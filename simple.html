<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .user-info strong {
            color: #667eea;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e1e1;
        }

        .tab {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .article-item {
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .article-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .article-content {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.7;
        }

        .article-meta {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 15px;
        }

        .article-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .article-actions button {
            background: #6c757d;
            padding: 8px 16px;
            font-size: 14px;
        }

        .article-actions button.active {
            background: #667eea;
        }

        .relay-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .relay-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .relay-status.connected {
            background: #28a745;
        }

        .relay-status.disconnected {
            background: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .version-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .version-info h3 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .warning strong {
            color: #d63384;
        }

        .format-btn {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .format-btn.active {
            background: #667eea;
            font-weight: 600;
        }

        .format-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .copy-success {
            background: #d4edda !important;
            color: #155724 !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .section {
                padding: 20px;
            }

            .article-actions {
                flex-direction: column;
            }

            .article-actions button {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        /* JSON Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .json-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .json-modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .json-modal-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .json-modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .json-modal-header .close-json-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .json-modal-body {
            padding: 20px;
        }

        .json-modal-footer {
            background: #f8f9fa;
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .json-modal-footer button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }

        /* ÂºÄÂèëËÄÖÊ®°ÂºèÊ†∑Âºè */
        .dev-button {
            display: none;
        }

        .dev-mode .dev-button {
            display: inline-block;
        }

        .dev-mode #toggleDevMode {
            background: #28a745 !important;
        }

        .comment-item {
            background: #f4f8fb;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.06);
            margin-bottom: 16px;
            padding: 16px 20px;
            position: relative;
        }

        .comment-item .reply-btn {
            background: #e0e7ff;
            color: #4f46e5;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            padding: 4px 10px;
            margin-top: 8px;
            cursor: pointer;
        }

        .comment-item .comment-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .comment-item .reply-box {
            margin-top: 10px;
        }

        .child-comment {
            background: #fff;
            margin-left: 24px;
            border-left: 3px solid #a5b4fc;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üî• Nostr Demo</h1>
            <p>Âéª‰∏≠ÂøÉÂåñÁ§æ‰∫§ÂçèËÆÆÊºîÁ§∫Â∫îÁî® - ÁúüÂÆûÂä†ÂØÜÁâàÊú¨</p>
        </div>

        <div id="app">
            <div class="loading">Ê≠£Âú®Âä†ËΩΩ nostr-tools Â∫ì...</div>
        </div>

        <div id="status-message" class="status"></div>
    </div>

    <!-- ÈÄöËøá CDN Âä†ËΩΩ nostr-tools -->
    <script src="https://unpkg.com/nostr-tools@2.15.0/lib/nostr.bundle.js"></script>

    <script>
        // Á≠âÂæÖ nostr-tools Âä†ËΩΩÂÆåÊàê
        document.addEventListener('DOMContentLoaded', function () {
            // Ê£ÄÊü• nostr-tools ÊòØÂê¶Âä†ËΩΩÊàêÂäü
            if (typeof window.NostrTools === 'undefined') {
                document.getElementById('app').innerHTML = `
                    <div class="section">
                        <h2>‚ùå Âä†ËΩΩÂ§±Ë¥•</h2>
                        <p>Êó†Ê≥ïÂä†ËΩΩ nostr-tools Â∫ìÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï„ÄÇ</p>
                        <p>Â¶ÇÊûúÈóÆÈ¢òÊåÅÁª≠Â≠òÂú®ÔºåÂèØ‰ª•Â∞ùËØï‰ΩøÁî® npm ÁâàÊú¨Ôºö</p>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;">
npm install
npm run dev
                        </pre>
                    </div>
                `;
                return;
            }

            // ‰ªéÂÖ®Â±ÄÂØπË±°Ëé∑Âèñ nostr-tools ÂáΩÊï∞
            const {
                SimplePool,
                finalizeEvent,
                generateSecretKey,
                getPublicKey,
                nip19,
                validateEvent,
                verifyEvent
            } = window.NostrTools;

            // ÁúüÂÆûÁöÑ Nostr ÂÆ¢Êà∑Á´ØÂÆûÁé∞
            class RealNostrClient {
                constructor() {
                    // NIP-42 ËÆ§ËØÅÁä∂ÊÄÅË∑üË∏™
                    this.authChallenges = new Map(); // relay -> challenge
                    this.authStatus = new Map(); // relay -> authenticated status
                    this.pendingAuthRequests = new Map(); // relay -> promise resolve
                    
                    // ÈªòËÆ§‰∏≠ÁªßÂàóË°®
                    this.defaultRelays = [
                        'wss://nostr.internal.ikandev.xyz',
                    ];

                    // Êé®Ëçê‰∏≠ÁªßÂàóË°®ÔºàÁî®‰∫éÂø´ÈÄüÊ∑ªÂä†Ôºâ
                    this.recommendedRelays = [
                        { url: 'wss://nostr.internal.ikandev.xyz', name: 'ikandev.xyz', description: 'Âø´ÈÄüÂèØÈù†ÁöÑ‰∏≠Áªß' },
                        { url: 'wss://relay.damus.io', name: 'damus.io', description: 'Damus ÂÆòÊñπ‰∏≠Áªß' },
                        { url: 'wss://relay.snort.social', name: 'snort.social', description: 'Snort ÂÆòÊñπ‰∏≠Áªß' },
                        { url: 'wss://nos.lol', name: 'nos.lol', description: 'Nos ÂÆòÊñπ‰∏≠Áªß' },
                        { url: 'wss://relay.nostr.band', name: 'nostr.band', description: 'Nostr.band ‰∏≠Áªß' },
                        { url: 'wss://eden.nostr.land', name: 'eden.nostr.land', description: 'Eden ‰∏≠Áªß' },
                        { url: 'wss://relay.nostr.info', name: 'nostr.info', description: 'Nostr.info ‰∏≠Áªß' },
                        { url: 'wss://nostr.wine', name: 'nostr.wine', description: 'Nostr.wine ‰∏≠Áªß' },
                        { url: 'wss://relay.current.fyi', name: 'current.fyi', description: 'Current.fyi ‰∏≠Áªß' },
                        { url: 'wss://relay.nostr.net', name: 'nostr.net', description: 'Nostr.net ‰∏≠Áªß' },
                        { url: 'wss://relay.nostr.com', name: 'nostr.com', description: 'Nostr.com ‰∏≠Áªß' },
                        { url: 'wss://relay.nostr.watch', name: 'nostr.watch', description: 'Nostr.watch ‰∏≠Áªß' }
                    ];

                    // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩ‰∏≠ÁªßÂàóË°®ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§ÂàóË°®
                    this.relays = this.loadRelaysFromStorage();

                    this.pool = new SimplePool();
                    this.privateKey = null;
                    this.publicKey = null;
                    this.userMetadata = null;

                    // ‰∫ã‰ª∂ÁßçÁ±ª
                    this.eventKinds = {
                        METADATA: 0,
                        TEXT_NOTE: 1,
                        CONTACT_LIST: 3,
                        REACTION: 7,
                        COMMENT: 1111,
                        LONG_FORM: 30023,
                        BOOKMARK: 10003,
                        BOOKMARK_SET: 30003
                    };

                    // ËøûÊé•Áä∂ÊÄÅ
                    this.connectionStatus = new Map();

                    console.log('RealNostrClient initialized with nostr-tools');
                }

                // ÂàõÂª∫Êñ∞Ë¥¶Âè∑
                async createAccount(name = '', about = '', picture = '', nip05 = '') {
                    try {
                        // ÁîüÊàêÁßÅÈí• (ËøîÂõû Uint8Array)
                        const privateKey = generateSecretKey();

                        // ‰ªéÁßÅÈí•Ê¥æÁîüÂÖ¨Èí• (ÈúÄË¶Å Uint8Array Êàñ hex string)
                        const publicKey = getPublicKey(privateKey);

                        // ÁîüÊàêÁî®Êà∑ÂèãÂ•ΩÁöÑÊ†ºÂºè
                        const npub = nip19.npubEncode(publicKey);
                        const nsec = nip19.nsecEncode(privateKey);

                        // ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ
                        await this.setUser(privateKey, publicKey);

                        // ÂèëÂ∏ÉÁî®Êà∑ÂÖÉÊï∞ÊçÆ
                        if (name || about || picture || nip05) {
                            await this.publishUserMetadata(name, about, picture, nip05);
                        }

                        console.log('Ë¥¶Âè∑ÂàõÂª∫ÊàêÂäü:', { npub, publicKey: publicKey.substring(0, 16) + '...' });

                        return {
                            privateKey,
                            publicKey,
                            npub,
                            nsec,
                            name,
                            about,
                            picture,
                            nip05
                        };

                    } catch (error) {
                        console.error('ÂàõÂª∫Ë¥¶Âè∑Â§±Ë¥•:', error);
                        throw error;
                    }
                }

                // ÂØºÂÖ•Ë¥¶Âè∑
                async importAccount(nsec) {
                    try {
                        const decoded = nip19.decode(nsec);

                        if (decoded.type !== 'nsec') {
                            throw new Error('Êó†ÊïàÁöÑ nsec Ê†ºÂºè');
                        }

                        const privateKey = decoded.data; // ËøôÂ∑≤ÁªèÊòØ Uint8Array
                        const publicKey = getPublicKey(privateKey);
                        const npub = nip19.npubEncode(publicKey);

                        await this.setUser(privateKey, publicKey);

                        // Ëé∑ÂèñÁî®Êà∑ÂÖÉÊï∞ÊçÆ
                        const metadata = await this.getUserMetadata(publicKey);

                        console.log('Ë¥¶Âè∑ÂØºÂÖ•ÊàêÂäü:', { npub, publicKey: publicKey.substring(0, 16) + '...' });

                        return {
                            privateKey,
                            publicKey,
                            npub,
                            nsec,
                            name: metadata?.name || '',
                            about: metadata?.about || '',
                            picture: metadata?.picture || '',
                            nip05: metadata?.nip05 || ''
                        };

                    } catch (error) {
                        console.error('ÂØºÂÖ•Ë¥¶Âè∑Â§±Ë¥•:', error);
                        throw error;
                    }
                }

                // ËÆæÁΩÆÁî®Êà∑
                async setUser(privateKey, publicKey) {
                    this.privateKey = privateKey;
                    this.publicKey = publicKey;

                    // È™åËØÅÂØÜÈí•ÂØπ (Á°Æ‰øù‰∏§‰∏™ÂØÜÈí•ÈÉΩÊòØÊ≠£Á°ÆÁöÑÊ†ºÂºè)
                    const derivedPublicKey = getPublicKey(privateKey);
                    if (derivedPublicKey !== publicKey) {
                        throw new Error('ÁßÅÈí•ÂíåÂÖ¨Èí•‰∏çÂåπÈÖç');
                    }

                    console.log('Áî®Êà∑ËÆæÁΩÆÊàêÂäü');
                }

                // ÂàõÂª∫Âπ∂Á≠æÂêç‰∫ã‰ª∂
                createEvent(kind, content, tags = []) {
                    if (!this.privateKey || !this.publicKey) {
                        throw new Error('Áî®Êà∑Êú™ËÆæÁΩÆÔºåÊó†Ê≥ïÂàõÂª∫‰∫ã‰ª∂');
                    }

                    const event = {
                        kind,
                        content,
                        tags,
                        created_at: Math.floor(Date.now() / 1000),
                        pubkey: this.publicKey
                    };

                    // ‰ΩøÁî® finalizeEvent ÂÆåÊàê‰∫ã‰ª∂Á≠æÂêç
                    const signedEvent = finalizeEvent(event, this.privateKey);

                    // È™åËØÅ‰∫ã‰ª∂
                    const isValid = validateEvent(signedEvent);
                    if (!isValid) {
                        throw new Error('‰∫ã‰ª∂È™åËØÅÂ§±Ë¥•');
                    }

                    const isSignatureValid = verifyEvent(signedEvent);
                    if (!isSignatureValid) {
                        throw new Error('‰∫ã‰ª∂Á≠æÂêçÈ™åËØÅÂ§±Ë¥•');
                    }

                    console.log('‰∫ã‰ª∂ÂàõÂª∫ÊàêÂäü:', { kind, id: signedEvent.id.substring(0, 16) + '...' });
                    return signedEvent;
                }

                // ÂèëÂ∏É‰∫ã‰ª∂ - ÊîØÊåÅ NIP-42 ËÆ§ËØÅ
                async publishEvent(event) {
                    if (!event.id || !event.sig) {
                        throw new Error('‰∫ã‰ª∂Êú™Ê≠£Á°ÆÁ≠æÂêç');
                    }

                    console.log('Ê≠£Âú®ÂèëÂ∏É‰∫ã‰ª∂:', {
                        kind: event.kind,
                        id: event.id.substring(0, 16) + '...',
                        relays: this.relays.length
                    });

                    // ‰∏∫ÊØè‰∏™‰∏≠ÁªßÂçïÁã¨Â§ÑÁêÜÂèëÂ∏ÉÔºàÊîØÊåÅËÆ§ËØÅÔºâ
                    const results = await Promise.allSettled(
                        this.relays.map(relayUrl => this.publishToRelayWithAuth(relayUrl, event))
                    );

                    const successful = results.filter(r => r.status === 'fulfilled').length;
                    const failed = results.filter(r => r.status === 'rejected').length;

                    console.log(`‚úÖ ÂèëÂ∏ÉÂÆåÊàê: ${successful} ÊàêÂäü, ${failed} Â§±Ë¥•`);

                    if (successful === 0) {
                        const errors = results.filter(r => r.status === 'rejected').map(r => r.reason.message);
                        throw new Error(`ÊâÄÊúâ‰∏≠ÁªßÂèëÂ∏ÉÂ§±Ë¥•: ${errors.join(', ')}`);
                    }

                    return { event, success: true, successful, failed, total: results.length };
                }

                // ÊîØÊåÅËÆ§ËØÅÁöÑÂèëÂ∏ÉÂà∞Âçï‰∏™‰∏≠Áªß
                async publishToRelayWithAuth(relayUrl, event) {
                    return new Promise((resolve, reject) => {
                        const ws = new WebSocket(relayUrl);
                        const timeout = setTimeout(() => {
                            ws.close();
                            reject(new Error(`ÂèëÂ∏ÉÂà∞ ${relayUrl} Ë∂ÖÊó∂`));
                        }, 15000);

                        ws.onopen = () => {
                            console.log(`üì§ ËøûÊé•Âà∞ ${relayUrl}ÔºåÂèëÂ∏É‰∫ã‰ª∂`);
                            // Áõ¥Êé•ÂèëÈÄÅ‰∫ã‰ª∂
                            ws.send(JSON.stringify(['EVENT', event]));
                        };

                        ws.onmessage = async (msgEvent) => {
                            try {
                                const data = JSON.parse(msgEvent.data);
                                console.log(`üì• ${relayUrl} ÂìçÂ∫î:`, data);

                                // Â§ÑÁêÜ AUTH Ê∂àÊÅØ
                                if (data[0] === 'AUTH') {
                                    const challenge = data[1];
                                                    console.log(`üîê Êî∂Âà∞ ${relayUrl} ÁöÑËÆ§ËØÅÊåëÊàò: ${challenge.substring(0, 16)}...`);
                                        
                                        // ÊòæÁ§∫ËÆ§ËØÅÁä∂ÊÄÅÂà∞Áî®Êà∑ÁïåÈù¢
                                        if (window.app && typeof window.app.showStatus === 'function') {
                                            window.app.showStatus(`üîê Ê≠£Âú®ËÆ§ËØÅ ${relayUrl}...`, 'info');
                                        }
                                    
                                    try {
                                        const authEvent = await this.handleAuthChallenge(relayUrl, challenge);
                                        ws.send(JSON.stringify(['AUTH', authEvent]));
                                        console.log(`üîê Â∑≤ÂèëÈÄÅËÆ§ËØÅÂìçÂ∫îÂà∞ ${relayUrl}`);
                                        
                                        // ÊòæÁ§∫ËÆ§ËØÅÊàêÂäü
                                        if (window.app && typeof window.app.showStatus === 'function') {
                                            window.app.showStatus(`üîê ${relayUrl} ËÆ§ËØÅÊàêÂäüÔºÅ`, 'success');
                                        }
                                        // ËÆ§ËØÅÂêéÈáçÊñ∞ÂèëÈÄÅÂéü‰∫ã‰ª∂
                                        ws.send(JSON.stringify(['EVENT', event]));
                                    } catch (authError) {
                                        console.error(`üîê ËÆ§ËØÅÂ§±Ë¥• ${relayUrl}:`, authError);
                                        clearTimeout(timeout);
                                        ws.close();
                                        reject(authError);
                                    }
                                }
                                
                                // Â§ÑÁêÜ OK Ê∂àÊÅØ (ÂèëÂ∏ÉÁªìÊûú)
                                else if (data[0] === 'OK') {
                                    const [, eventId, success, message] = data;
                                    clearTimeout(timeout);
                                    ws.close();
                                    
                                    if (success) {
                                        console.log(`‚úÖ ${relayUrl} ÂèëÂ∏ÉÊàêÂäü`);
                                        this.setAuthStatus(relayUrl, true);
                                        resolve({ relayUrl, success: true });
                                    } else {
                                        console.warn(`‚ùå ${relayUrl} ÂèëÂ∏ÉÂ§±Ë¥•: ${message}`);
                                        if (message && message.toLowerCase().includes('auth')) {
                                            this.setAuthStatus(relayUrl, false);
                                        }
                                        reject(new Error(`ÂèëÂ∏ÉÂ§±Ë¥•: ${message}`));
                                    }
                                }
                                
                            } catch (error) {
                                console.error(`Ëß£Êûê ${relayUrl} Ê∂àÊÅØÂ§±Ë¥•:`, error);
                            }
                        };

                        ws.onerror = (error) => {
                            console.error(`${relayUrl} WebSocket ÈîôËØØ:`, error);
                            clearTimeout(timeout);
                            reject(new Error(`WebSocket ËøûÊé•ÈîôËØØ: ${relayUrl}`));
                        };

                        ws.onclose = () => {
                            clearTimeout(timeout);
                        };
                    });
                }

                // ÂèëÂ∏ÉÁî®Êà∑ÂÖÉÊï∞ÊçÆ
                async publishUserMetadata(name, about, picture = '', nip05 = '', website = '') {
                    const metadata = {
                        name: name || '',
                        about: about || '',
                        picture: picture || '',
                        nip05: nip05 || '',
                        website: website || ''
                    };

                    const event = this.createEvent(
                        this.eventKinds.METADATA,
                        JSON.stringify(metadata)
                    );

                    return await this.publishEvent(event);
                }

                // Ëé∑ÂèñÁî®Êà∑ÂÖÉÊï∞ÊçÆ
                async getUserMetadata(pubkey) {
                    try {
                        const events = await this.pool.querySync(this.relays, [
                            {
                                kinds: [this.eventKinds.METADATA],
                                authors: [pubkey],
                                limit: 1
                            }
                        ]);

                        if (events.length > 0) {
                            const metadata = JSON.parse(events[0].content);
                            return metadata;
                        }

                        return null;
                    } catch (error) {
                        console.error('Ëé∑ÂèñÁî®Êà∑ÂÖÉÊï∞ÊçÆÂ§±Ë¥•:', error);
                        return null;
                    }
                }

                // ÂèëÂ∏ÉÊñáÁ´†
                async publishArticle(title, content, summary = '', dTag = '') {
                    if (!dTag) {
                        dTag = 'article_' + Date.now();
                    }
                    const event = this.createEvent(
                        this.eventKinds.LONG_FORM,
                        content,
                        [
                            ['d', dTag],
                            ['title', title],
                            ['summary', summary],
                            ['published_at', Math.floor(Date.now() / 1000).toString()]
                        ]
                    );
                    return await this.publishEvent(event);
                }

                // ÁÇπËµûÊñáÁ´†
                async likeArticle(articleId, authorPubkey) {
                    const event = this.createEvent(
                        this.eventKinds.REACTION,
                        '+',
                        [
                            ['e', articleId],
                            ['p', authorPubkey]
                        ]
                    );

                    return await this.publishEvent(event);
                }

                // Êü•ËØ¢Áî®Êà∑ÊòØÂê¶Â∑≤ÁÇπËµûÊüêÁØáÊñáÁ´†
                async checkUserLikeStatus(articleId) {
                    if (!this.publicKey) {
                        return false;
                    }

                    try {
                        const events = await this.pool.querySync(this.relays, {
                            kinds: [this.eventKinds.REACTION],
                            authors: [this.publicKey],
                            '#e': [articleId],
                            limit: 1
                        }, {
                            maxWait: 5000
                        });

                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÁÇπËµû‰∫ã‰ª∂Ôºàcontent ‰∏∫ '+'Ôºâ
                        return events.some(event => event.content === '+');
                    } catch (error) {
                        console.warn('Êü•ËØ¢ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
                        return false;
                    }
                }

                // Ëé∑ÂèñÂΩìÂâçÊî∂ËóèÂàóË°®
                async getCurrentBookmarks() {
                    // ‰ΩøÁî®Áã¨Á´ãÁöÑ SimplePool ÈÅøÂÖçÁä∂ÊÄÅÂÜ≤Á™Å
                    const bookmarkPool = new SimplePool();
                    try {
                        const bookmarkEvents = await bookmarkPool.querySync(this.relays, {
                            kinds: [this.eventKinds.BOOKMARK],
                            authors: [this.publicKey],
                            limit: 1
                        }, { maxWait: 10000 });

                        if (bookmarkEvents.length === 0) return [];

                        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÊî∂Ëóè‰∫ã‰ª∂
                        const latest = bookmarkEvents.sort((a, b) => b.created_at - a.created_at)[0];
                        // ËøîÂõûÊâÄÊúâÊî∂ËóèÊ†áÁ≠æ (ÊîØÊåÅ e Ê†áÁ≠æÂíå a Ê†áÁ≠æ)
                        return latest.tags.filter(tag => tag[0] === 'e' || tag[0] === 'a');
                    } catch (error) {
                        console.warn('Ëé∑ÂèñÂΩìÂâçÊî∂ËóèÂàóË°®Â§±Ë¥•:', error);
                        return [];
                    } finally {
                        bookmarkPool.close(this.relays);
                    }
                }

                // Ëé∑ÂèñÂΩìÂâçÂÖ≥Ê≥®ÂàóË°®
                async getCurrentFollowList() {
                    // ‰ΩøÁî®Áã¨Á´ãÁöÑ SimplePool ÈÅøÂÖçÁä∂ÊÄÅÂÜ≤Á™Å
                    const followPool = new SimplePool();
                    try {
                        const followEvents = await followPool.querySync(this.relays, {
                            kinds: [this.eventKinds.CONTACT_LIST],
                            authors: [this.publicKey],
                            limit: 1
                        }, { maxWait: 10000 });

                        if (followEvents.length === 0) return [];

                        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂÖ≥Ê≥®‰∫ã‰ª∂
                        const latest = followEvents.sort((a, b) => b.created_at - a.created_at)[0];
                        // ËøîÂõûÊâÄÊúâ p Ê†áÁ≠æ (ÂÖ≥Ê≥®ÁöÑÁî®Êà∑)
                        return latest.tags.filter(tag => tag[0] === 'p');
                    } catch (error) {
                        console.warn('Ëé∑ÂèñÂΩìÂâçÂÖ≥Ê≥®ÂàóË°®Â§±Ë¥•:', error);
                        return [];
                    } finally {
                        followPool.close(this.relays);
                    }
                }

                // Êî∂ËóèÊñáÁ´† - Êõ¥Êñ∞ÂÆåÊï¥Êî∂ËóèÂàóË°®Ôºå‰ΩøÁî® a Ê†áÁ≠æÊ†ºÂºè
                async bookmarkArticle(articleId, title = '', authorPubkey, dTag) {
                    // ÊûÑÈÄ†ÊñáÁ´†ÁöÑ a Ê†áÁ≠æ
                    const articleATag = `30023:${authorPubkey}:${dTag}`;

                    console.log('üîç ÂºÄÂßãÊî∂ËóèÊñáÁ´†:', {
                        articleId: articleId.substring(0, 16) + '...',
                        title: title,
                        authorPubkey: authorPubkey.substring(0, 16) + '...',
                        dTag: dTag,
                        articleATag: articleATag
                    });

                    try {
                        // 1. Ëé∑ÂèñÂΩìÂâçÊî∂ËóèÂàóË°®
                        const currentBookmarks = await this.getCurrentBookmarks();
                        console.log('üìã ÂΩìÂâçÊî∂ËóèÂàóË°®:', currentBookmarks.length, '‰∏™');

                        // 2. Ê£ÄÊü•ÊòØÂê¶Â∑≤Êî∂Ëóè (Ê£ÄÊü• a Ê†áÁ≠æ)
                        const isAlreadyBookmarked = currentBookmarks.some(tag =>
                            tag[0] === 'a' && tag[1] === articleATag
                        );

                        if (isAlreadyBookmarked) {
                            console.log('‚ö†Ô∏è Â∑≤ÁªèÊî∂ËóèËøáËØ•ÊñáÁ´†');
                            return { success: false, reason: 'already_bookmarked' };
                        }

                        // 3. Ê∑ªÂä†Êñ∞Êî∂ËóèÂà∞ÂÆåÊï¥ÂàóË°® (‰ΩøÁî® a Ê†áÁ≠æÊ†ºÂºè)
                        const newBookmarks = [
                            ...currentBookmarks,
                            ['a', articleATag, '']
                        ];

                        console.log('üìù Êõ¥Êñ∞ÂêéÁöÑÊî∂ËóèÂàóË°®:', newBookmarks.length, '‰∏™');

                        // 4. ÂàõÂª∫Êñ∞ÁöÑÊî∂Ëóè‰∫ã‰ª∂ÔºàÂåÖÂê´ÂÆåÊï¥ÂàóË°®Ôºâ
                        const event = this.createEvent(
                            this.eventKinds.BOOKMARK,
                            '',
                            [
                                ...newBookmarks
                            ]
                        );

                        console.log('üìù Êî∂Ëóè‰∫ã‰ª∂ËØ¶ÊÉÖ:', {
                            id: event.id.substring(0, 16) + '...',
                            kind: event.kind,
                            content: event.content,
                            tags: event.tags,
                            pubkey: event.pubkey.substring(0, 16) + '...',
                            sig: event.sig ? 'Â∑≤Á≠æÂêç' : 'Êú™Á≠æÂêç'
                        });

                        // 5. ÂèëÂ∏É‰∫ã‰ª∂
                        const result = await this.publishEvent(event);
                        console.log('‚úÖ Êî∂Ëóè‰∫ã‰ª∂ÂèëÂ∏ÉÁªìÊûú:', result);

                        return result;

                    } catch (error) {
                        console.error('‚ùå Êî∂ËóèÊñáÁ´†Â§±Ë¥•:', error);
                        throw error;
                    }
                }

                // ÂèñÊ∂àÊî∂Ëóè - Êõ¥Êñ∞ÂÆåÊï¥Êî∂ËóèÂàóË°®Ôºå‰ΩøÁî® a Ê†áÁ≠æÊ†ºÂºè
                async unbookmarkArticle(articleId, authorPubkey, dTag) {
                    // ÊûÑÈÄ†ÊñáÁ´†ÁöÑ a Ê†áÁ≠æ
                    const articleATag = `30023:${authorPubkey}:${dTag}`;

                    console.log('üîç ÂºÄÂßãÂèñÊ∂àÊî∂Ëóè:', {
                        articleId: articleId.substring(0, 16) + '...',
                        authorPubkey: authorPubkey.substring(0, 16) + '...',
                        dTag: dTag,
                        articleATag: articleATag
                    });

                    try {
                        // 1. Ëé∑ÂèñÂΩìÂâçÊî∂ËóèÂàóË°®
                        const currentBookmarks = await this.getCurrentBookmarks();
                        console.log('üìã ÂΩìÂâçÊî∂ËóèÂàóË°®:', currentBookmarks.length, '‰∏™');

                        // 2. ËøáÊª§ÊéâË¶ÅÂèñÊ∂àÊî∂ËóèÁöÑÊñáÁ´† (‰ΩøÁî® a Ê†áÁ≠æ)
                        const updatedBookmarks = currentBookmarks.filter(tag =>
                            !(tag[0] === 'a' && tag[1] === articleATag)
                        );

                        console.log('üìù Êõ¥Êñ∞ÂêéÁöÑÊî∂ËóèÂàóË°®:', updatedBookmarks.length, '‰∏™');

                        // 3. ÂàõÂª∫Êñ∞ÁöÑÊî∂Ëóè‰∫ã‰ª∂ÔºàÂåÖÂê´Êõ¥Êñ∞ÂêéÁöÑÂÆåÊï¥ÂàóË°®Ôºâ
                        const event = this.createEvent(
                            this.eventKinds.BOOKMARK,
                            '',
                            [
                                ['title', 'ÊàëÁöÑÊî∂Ëóè'],
                                ['description', 'Êî∂ËóèÁöÑÊñáÁ´†'],
                                ...updatedBookmarks
                            ]
                        );

                        // 4. ÂèëÂ∏É‰∫ã‰ª∂
                        const result = await this.publishEvent(event);
                        console.log('‚úÖ ÂèñÊ∂àÊî∂Ëóè‰∫ã‰ª∂ÂèëÂ∏ÉÁªìÊûú:', result);

                        return result;

                    } catch (error) {
                        console.error('‚ùå ÂèñÊ∂àÊî∂ËóèÂ§±Ë¥•:', error);
                        throw error;
                    }
                }

                // ÂÖ≥Ê≥®‰ΩúËÄÖ - Êõ¥Êñ∞ÂÆåÊï¥ÂÖ≥Ê≥®ÂàóË°®
                async followAuthor(authorPubkey, alias = '') {
                    console.log('üîç ÂºÄÂßãÂÖ≥Ê≥®‰ΩúËÄÖ:', {
                        authorPubkey: authorPubkey.substring(0, 16) + '...',
                        alias: alias
                    });

                    try {
                        // 1. Ëé∑ÂèñÂΩìÂâçÂÖ≥Ê≥®ÂàóË°®
                        const currentFollows = await this.getCurrentFollowList();
                        console.log('üìã ÂΩìÂâçÂÖ≥Ê≥®ÂàóË°®:', currentFollows.length, '‰∏™');

                        // 2. Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂÖ≥Ê≥®
                        const isAlreadyFollowed = currentFollows.some(tag =>
                            tag[0] === 'p' && tag[1] === authorPubkey
                        );

                        if (isAlreadyFollowed) {
                            console.log('‚ö†Ô∏è Â∑≤ÁªèÂÖ≥Ê≥®ËøáËØ•‰ΩúËÄÖ');
                            return { success: false, reason: 'already_followed' };
                        }

                        // 3. Ê∑ªÂä†Êñ∞ÂÖ≥Ê≥®Âà∞ÂÆåÊï¥ÂàóË°®
                        const newFollows = [
                            ...currentFollows,
                            ['p', authorPubkey, '', alias]
                        ];

                        console.log('üìù Êõ¥Êñ∞ÂêéÁöÑÂÖ≥Ê≥®ÂàóË°®:', newFollows.length, '‰∏™');

                        // 4. ÂàõÂª∫Êñ∞ÁöÑÂÖ≥Ê≥®‰∫ã‰ª∂ÔºàÂåÖÂê´ÂÆåÊï¥ÂàóË°®Ôºâ
                        const event = this.createEvent(
                            this.eventKinds.CONTACT_LIST,
                            '',
                            newFollows
                        );

                        console.log('üìù ÂÖ≥Ê≥®‰∫ã‰ª∂ËØ¶ÊÉÖ:', {
                            id: event.id.substring(0, 16) + '...',
                            kind: event.kind,
                            content: event.content,
                            tags: event.tags,
                            pubkey: event.pubkey.substring(0, 16) + '...',
                            sig: event.sig ? 'Â∑≤Á≠æÂêç' : 'Êú™Á≠æÂêç'
                        });

                        // 5. ÂèëÂ∏É‰∫ã‰ª∂
                        const result = await this.publishEvent(event);
                        console.log('‚úÖ ÂÖ≥Ê≥®‰∫ã‰ª∂ÂèëÂ∏ÉÁªìÊûú:', result);

                        return result;

                    } catch (error) {
                        console.error('‚ùå ÂÖ≥Ê≥®‰ΩúËÄÖÂ§±Ë¥•:', error);
                        throw error;
                    }
                }

                // ÂèñÊ∂àÂÖ≥Ê≥®‰ΩúËÄÖ - Êõ¥Êñ∞ÂÆåÊï¥ÂÖ≥Ê≥®ÂàóË°®
                async unfollowAuthor(authorPubkey) {
                    console.log('üîç ÂºÄÂßãÂèñÊ∂àÂÖ≥Ê≥®‰ΩúËÄÖ:', {
                        authorPubkey: authorPubkey.substring(0, 16) + '...'
                    });

                    try {
                        // 1. Ëé∑ÂèñÂΩìÂâçÂÖ≥Ê≥®ÂàóË°®
                        const currentFollows = await this.getCurrentFollowList();
                        console.log('üìã ÂΩìÂâçÂÖ≥Ê≥®ÂàóË°®:', currentFollows.length, '‰∏™');

                        // 2. ËøáÊª§ÊéâË¶ÅÂèñÊ∂àÂÖ≥Ê≥®ÁöÑ‰ΩúËÄÖ
                        const updatedFollows = currentFollows.filter(tag =>
                            !(tag[0] === 'p' && tag[1] === authorPubkey)
                        );

                        console.log('üìù Êõ¥Êñ∞ÂêéÁöÑÂÖ≥Ê≥®ÂàóË°®:', updatedFollows.length, '‰∏™');

                        // 3. ÂàõÂª∫Êñ∞ÁöÑÂÖ≥Ê≥®‰∫ã‰ª∂ÔºàÂåÖÂê´Êõ¥Êñ∞ÂêéÁöÑÂÆåÊï¥ÂàóË°®Ôºâ
                        const event = this.createEvent(
                            this.eventKinds.CONTACT_LIST,
                            '',
                            updatedFollows
                        );

                        // 4. ÂèëÂ∏É‰∫ã‰ª∂
                        const result = await this.publishEvent(event);
                        console.log('‚úÖ ÂèñÊ∂àÂÖ≥Ê≥®‰∫ã‰ª∂ÂèëÂ∏ÉÁªìÊûú:', result);

                        return result;

                    } catch (error) {
                        console.error('‚ùå ÂèñÊ∂àÂÖ≥Ê≥®Â§±Ë¥•:', error);
                        throw error;
                    }
                }

                // ËØÑËÆ∫ÊñáÁ´†
                async commentOnArticle(articleId, authorPubkey, targetPubkey, content, parentId = null, article = null, dTag = null) {
                    // authorPubkey: ÊñáÁ´†‰ΩúËÄÖÁöÑ pubkeyÔºàÁî®‰∫éÂ§ßÂÜô P Ê†áÁ≠æÔºâ
                    // targetPubkey: Ë¢´ÂõûÂ§çËØÑËÆ∫‰ΩúËÄÖÁöÑ pubkeyÔºàÁî®‰∫éÂ∞èÂÜô p Ê†áÁ≠æÔºâ
                    // dTag: ÊñáÁ´†ÁöÑ d-tag
                    // ‰ªé‰º†ÂÖ•ÁöÑ article ÂèÇÊï∞ÊûÑÂª∫ aTag
                    if (!article) {
                        throw new Error('Áº∫Â∞ëÊñáÁ´†‰ø°ÊÅØ');
                    }

                    // Â¶ÇÊûúÊ≤°Êúâ‰º†ÂÖ• dTagÔºåÂ∞ùËØï‰ªéÊñáÁ´†Ê†áÁ≠æ‰∏≠Ëé∑Âèñ
                    if (!dTag) {
                        dTag = this.getTagValue(article.tags, 'd') || articleId;
                    }

                    const articleATag = `30023:${article.pubkey}:${dTag}`;
                    let tags = [];

                    if (parentId) {
                        // ÂõûÂ§çËØÑËÆ∫ÔºöÂêåÊó∂‰ΩøÁî®Â§ßÂÜôÊ†áÁ≠æÊåáÂêëÊñáÁ´†ÂíåÂ∞èÂÜôÊ†áÁ≠æÊåáÂêëË¢´ÂõûÂ§çÁöÑËØÑËÆ∫
                        tags = [
                            ['A', articleATag],  // Â§ßÂÜôÊ†áÁ≠æÊåáÂêëÊñáÁ´†
                            ['K', '30023'],
                            ['P', authorPubkey],
                            ['E', articleId],
                            ['k', '1111'],
                            ['p', targetPubkey],
                            ['e', parentId]
                        ];
                    } else {
                        // ‰∏ªËØÑËÆ∫Ôºö‰ΩøÁî®Â§ßÂÜôÊ†áÁ≠æ
                        tags = [
                            ['A', articleATag],
                            ['K', '30023'],
                            ['P', authorPubkey],
                            ['E', articleId],
                            ['k', '1111'],
                            ['p', authorPubkey],
                            ['e', articleId]
                        ];
                    }

                    const event = this.createEvent(
                        this.eventKinds.COMMENT,
                        content,
                        tags
                    );
                    return await this.publishEvent(event);
                }

                // Ëé∑ÂèñÊó∂Èó¥Á∫ø - ‰ΩøÁî®Êõ¥ÂÅ•Â£ÆÁöÑÊñπÊ≥ï
                async getTimeline(limit = 20, timelineType = 'global') {
                    try {
                        console.log(`ÂºÄÂßã‰ªé ${this.relays.length} ‰∏™‰∏≠ÁªßËé∑ÂèñÊó∂Èó¥Á∫øÊï∞ÊçÆ...`);
                        console.log('üîç ÂΩìÂâçËÆ§ËØÅÁä∂ÊÄÅ:', Array.from(this.authStatus.entries()));

                        // Ê†πÊçÆÊó∂Èó¥Á∫øÁ±ªÂûãÂä®ÊÄÅË∞ÉÊï¥Êü•ËØ¢ÁöÑ kind
                        let kinds = [];
                        if (timelineType === 'global') {
                            // ÂÖ®Â±ÄÊó∂Èó¥Á∫øÔºöÊòæÁ§∫ÊâÄÊúâÂÜÖÂÆπÔºàÊñáÁ´†ÂíåËØÑËÆ∫Ôºâ
                            kinds = [this.eventKinds.TEXT_NOTE, this.eventKinds.LONG_FORM];
                        } else {
                            // ÂÖ∂‰ªñÊó∂Èó¥Á∫øÔºöÂè™ÊòæÁ§∫ÊñáÁ´†
                            kinds = [this.eventKinds.LONG_FORM];
                        }

                        console.log(`Êó∂Èó¥Á∫øÁ±ªÂûã: ${timelineType}, Êü•ËØ¢ÁöÑ kinds:`, kinds);

                        // ‰ΩøÁî®Ê≠£Á°ÆÁöÑ maxWait ÂèÇÊï∞ËøõË°å‰∏ÄÊ¨°ÊÄßÊü•ËØ¢
                        const events = await this.pool.querySync(this.relays, {
                            kinds: kinds,
                            limit: limit * 2
                        }, {
                            maxWait: 10000 // 10ÁßíË∂ÖÊó∂
                        });

                        console.log(`‚úÖ Ëé∑ÂèñÂà∞ ${events.length} ‰∏™‰∫ã‰ª∂`);

                        if (events.length === 0) {
                            console.warn('Êú™Ëé∑ÂèñÂà∞‰ªª‰Ωï‰∫ã‰ª∂');
                            return [];
                        }

                        // ÂéªÈáçÂπ∂ÊéíÂ∫è
                        const uniqueEvents = this.removeDuplicateEvents(events);
                        const sortedEvents = uniqueEvents.sort((a, b) => b.created_at - a.created_at);

                        console.log(`ÂéªÈáçÂêéÂâ©‰Ωô ${sortedEvents.length} ‰∏™‰∫ã‰ª∂`);

                        // ËøîÂõûÂâç limit ‰∏™‰∫ã‰ª∂
                        return sortedEvents.slice(0, limit);

                    } catch (error) {
                        console.error('Ëé∑ÂèñÊó∂Èó¥Á∫øËøáÁ®ã‰∏≠ÂèëÁîüÊÑèÂ§ñÈîôËØØ:', error);
                        return [];
                    }
                }

                // Ëé∑ÂèñÁâπÂÆöÁî®Êà∑ÁöÑÊó∂Èó¥Á∫ø
                async getUserTimeline(pubkey, limit = 20) {
                    try {
                        console.log(`Ëé∑ÂèñÁî®Êà∑ ${pubkey.substring(0, 16)}... ÁöÑÊó∂Èó¥Á∫ø`);

                        // ‰ΩøÁî®Ê≠£Á°ÆÁöÑ maxWait ÂèÇÊï∞ËøõË°å‰∏ÄÊ¨°ÊÄßÊü•ËØ¢
                        const events = await this.pool.querySync(this.relays, {
                            kinds: [this.eventKinds.LONG_FORM], // Âè™Êü•ËØ¢ÊñáÁ´†Ôºå‰∏çÂåÖÂê´ËØÑËÆ∫
                            authors: [pubkey],
                            limit: limit
                        }, {
                            maxWait: 10000 // 10ÁßíË∂ÖÊó∂
                        });

                        console.log(`‚úÖ Ëé∑ÂèñÂà∞ ${events.length} ‰∏™Áî®Êà∑‰∫ã‰ª∂`);
                        if (events.length > 0) {
                            console.log(`üìù ‰∫ã‰ª∂ËØ¶ÊÉÖ:`, events.map(e => ({
                                id: e.id.substring(0, 16) + '...',
                                kind: e.kind,
                                created_at: e.created_at,
                                content_preview: e.content.substring(0, 50) + '...'
                            })));
                        }

                        // ÂéªÈáçÂπ∂ÊéíÂ∫è
                        const uniqueEvents = this.removeDuplicateEvents(events);
                        return uniqueEvents.sort((a, b) => b.created_at - a.created_at);

                    } catch (error) {
                        console.error('Ëé∑ÂèñÁî®Êà∑Êó∂Èó¥Á∫øÂ§±Ë¥•:', error);
                        return [];
                    }
                }

                // Ëé∑ÂèñÂÖ≥Ê≥®Áî®Êà∑ÁöÑÊó∂Èó¥Á∫ø
                async getFollowedTimeline(limit = 20) {
                    try {
                        if (!this.publicKey) {
                            throw new Error('Áî®Êà∑Êú™ÁôªÂΩï');
                        }

                        console.log(`Ëé∑ÂèñÂÖ≥Ê≥®Áî®Êà∑ÁöÑÊó∂Èó¥Á∫ø`);

                        // È¶ñÂÖàËé∑ÂèñÂÖ≥Ê≥®ÂàóË°® - ÈÄê‰∏™Â∞ùËØï‰∏≠Áªß
                        let contactEvents = [];
                        for (const relay of this.relays) {
                            try {
                                console.log(`Ê≠£Âú®‰ªé ${relay} Ëé∑ÂèñÂÖ≥Ê≥®ÂàóË°®`);

                                const events = await this.pool.querySync([relay], {
                                    kinds: [this.eventKinds.CONTACT_LIST],
                                    authors: [this.publicKey],
                                    limit: 1
                                }, {
                                    timeout: 8000
                                });

                                if (events.length > 0) {
                                    contactEvents = events;
                                    console.log(`‚úÖ ‰ªé ${relay} Ëé∑ÂèñÂà∞ÂÖ≥Ê≥®ÂàóË°®`);
                                    break; // ÊâæÂà∞ÂÖ≥Ê≥®ÂàóË°®Â∞±ÂÅúÊ≠¢
                                }

                            } catch (error) {
                                console.warn(`‚ùå ‰ªé ${relay} Ëé∑ÂèñÂÖ≥Ê≥®ÂàóË°®Â§±Ë¥•:`, error.message);
                                // ÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™‰∏≠Áªß
                            }
                        }

                        if (contactEvents.length === 0) {
                            console.log('Êú™ÊâæÂà∞ÂÖ≥Ê≥®ÂàóË°®');
                            return [];
                        }

                        // ÊèêÂèñÂÖ≥Ê≥®ÁöÑÁî®Êà∑ÂÖ¨Èí•
                        const followedPubkeys = contactEvents[0].tags
                            .filter(tag => tag[0] === 'p')
                            .map(tag => tag[1]);

                        if (followedPubkeys.length === 0) {
                            console.log('ÂÖ≥Ê≥®ÂàóË°®‰∏∫Á©∫');
                            return [];
                        }

                        console.log(`ÊâæÂà∞ ${followedPubkeys.length} ‰∏™ÂÖ≥Ê≥®ÁöÑÁî®Êà∑`);

                        // Ëé∑ÂèñÂÖ≥Ê≥®Áî®Êà∑ÁöÑ‰∫ã‰ª∂ - ÈÄê‰∏™Â∞ùËØï‰∏≠Áªß
                        const allEvents = [];
                        for (const relay of this.relays) {
                            try {
                                console.log(`Ê≠£Âú®‰ªé ${relay} Ëé∑ÂèñÂÖ≥Ê≥®Áî®Êà∑‰∫ã‰ª∂`);

                                const events = await this.pool.querySync([relay], {
                                    kinds: [this.eventKinds.TEXT_NOTE, this.eventKinds.LONG_FORM],
                                    authors: followedPubkeys,
                                    limit: limit * 2
                                }, {
                                    timeout: 10000
                                });

                                console.log(`‚úÖ ‰∏≠Áªß ${relay} ËøîÂõû ${events.length} ‰∏™ÂÖ≥Ê≥®Áî®Êà∑‰∫ã‰ª∂`);
                                allEvents.push(...events);

                            } catch (error) {
                                console.warn(`‚ùå ‰∏≠Áªß ${relay} Ëé∑ÂèñÂÖ≥Ê≥®Áî®Êà∑‰∫ã‰ª∂Â§±Ë¥•:`, error.message);
                                // ÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™‰∏≠Áªß
                            }
                        }

                        console.log(`ÊÄªÂÖ±Ëé∑ÂèñÂà∞ÂÖ≥Ê≥®Áî®Êà∑ ${allEvents.length} ‰∏™‰∫ã‰ª∂`);

                        // ÂéªÈáçÂπ∂ÊéíÂ∫è
                        const uniqueEvents = this.removeDuplicateEvents(allEvents);
                        return uniqueEvents.sort((a, b) => b.created_at - a.created_at).slice(0, limit);

                    } catch (error) {
                        console.error('Ëé∑ÂèñÂÖ≥Ê≥®Êó∂Èó¥Á∫øÂ§±Ë¥•:', error);
                        return [];
                    }
                }

                // ÂéªÈô§ÈáçÂ§ç‰∫ã‰ª∂
                removeDuplicateEvents(events) {
                    const seen = new Set();
                    return events.filter(event => {
                        if (seen.has(event.id)) {
                            return false;
                        }
                        seen.add(event.id);
                        return true;
                    });
                }

                // ÊµãËØïÁâπÂÆöÂÖ¨Èí•ÁöÑ‰∫ã‰ª∂
                async testSpecificPubkey(pubkey) {
                    console.log(`üîç ÊµãËØïÂÖ¨Èí• ${pubkey.substring(0, 16)}... ÁöÑ‰∫ã‰ª∂`);

                    for (const relay of this.relays) {
                        try {
                            console.log(`Ê≠£Âú®‰ªé ${relay} Êü•ËØ¢ÂÖ¨Èí•‰∫ã‰ª∂...`);

                            // Êü•ËØ¢ÊâÄÊúâÁ±ªÂûãÁöÑ‰∫ã‰ª∂
                            const events = await this.pool.querySync([relay], [
                                {
                                    authors: [pubkey],
                                    limit: 50
                                }
                            ], {
                                timeout: 8000
                            });

                            console.log(`‚úÖ ‰∏≠Áªß ${relay} ËøîÂõû ${events.length} ‰∏™‰∫ã‰ª∂`);
                            if (events.length > 0) {
                                console.log(`üìù ÊâæÂà∞ÁöÑ‰∫ã‰ª∂:`, events.map(e => ({
                                    id: e.id.substring(0, 16) + '...',
                                    kind: e.kind,
                                    created_at: e.created_at,
                                    content_preview: e.content.substring(0, 100) + '...'
                                })));
                            }

                        } catch (error) {
                            console.warn(`‚ùå ‰∏≠Áªß ${relay} Êü•ËØ¢Â§±Ë¥•:`, error.message);
                        }
                    }
                }

                // ÊµãËØïÁâπÂÆöÂÖ¨Èí•ÁöÑ 30023 ‰∫ã‰ª∂
                async testSpecificPubkey30023(pubkey) {
                    console.log(`üîç ‰∏ìÈó®ÊµãËØïÂÖ¨Èí• ${pubkey.substring(0, 16)}... ÁöÑ 30023 ‰∫ã‰ª∂`);

                    for (const relay of this.relays) {
                        try {
                            console.log(`Ê≠£Âú®‰ªé ${relay} Êü•ËØ¢ÂÖ¨Èí•ÁöÑ 30023 ‰∫ã‰ª∂...`);

                            // ‰∏ìÈó®Êü•ËØ¢ 30023 Á±ªÂûãÁöÑ‰∫ã‰ª∂
                            const events = await this.pool.querySync([relay], {
                                kinds: [30023],
                                authors: [pubkey],
                                limit: 50
                            }, {
                                timeout: 8000
                            });

                            console.log(`‚úÖ ‰∏≠Áªß ${relay} ËøîÂõû ${events.length} ‰∏™ 30023 ‰∫ã‰ª∂`);
                            if (events.length > 0) {
                                console.log(`üìù ÊâæÂà∞ÁöÑ 30023 ‰∫ã‰ª∂:`, events.map(e => ({
                                    id: e.id.substring(0, 16) + '...',
                                    kind: e.kind,
                                    created_at: e.created_at,
                                    content_preview: e.content.substring(0, 100) + '...'
                                })));
                            }

                        } catch (error) {
                            console.warn(`‚ùå ‰∏≠Áªß ${relay} Êü•ËØ¢ 30023 ‰∫ã‰ª∂Â§±Ë¥•:`, error.message);
                        }
                    }
                }

                // Ê†πÊçÆ‰∫ã‰ª∂ ID Êü•ËØ¢‰∫ã‰ª∂
                async queryEventById(eventId) {
                    console.log(`üîç Ê†πÊçÆ‰∫ã‰ª∂ ID Êü•ËØ¢: ${eventId.substring(0, 16)}...`);

                    const results = [];

                    for (const relay of this.relays) {
                        try {
                            console.log(`Ê≠£Âú®‰ªé ${relay} Êü•ËØ¢‰∫ã‰ª∂...`);

                            const event = this.pool.get([relay], [
                                {
                                    ids: [eventId]
                                }
                            ], {
                                timeout: 8000
                            });

                            if (event) {
                                console.log('it exists indeed on this relay:', event)
                            }

                            const events = await this.pool.querySync([relay], {
                                ids: [eventId]
                            }, {
                                timeout: 8000
                            });

                            console.log(`‚úÖ ‰∏≠Áªß ${relay} ËøîÂõû ${events.length} ‰∏™‰∫ã‰ª∂`);
                            if (events.length > 0) {
                                const event = events[0];
                                console.log(`üìù ÊâæÂà∞‰∫ã‰ª∂:`, {
                                    id: event.id,
                                    pubkey: event.pubkey.substring(0, 16) + '...',
                                    kind: event.kind,
                                    created_at: event.created_at,
                                    content: event.content.substring(0, 200) + '...',
                                    tags: event.tags
                                });

                                results.push({
                                    relay,
                                    success: true,
                                    event: event
                                });
                            } else {
                                results.push({
                                    relay,
                                    success: false,
                                    message: 'Êú™ÊâæÂà∞‰∫ã‰ª∂'
                                });
                            }

                        } catch (error) {
                            console.warn(`‚ùå ‰∏≠Áªß ${relay} Êü•ËØ¢Â§±Ë¥•:`, error.message);
                            results.push({
                                relay,
                                success: false,
                                error: error.message
                            });
                        }
                    }

                    const successfulRelays = results.filter(r => r.success).length;
                    console.log(`‚úÖ Êü•ËØ¢ÂÆåÊàê: ${successfulRelays}/${this.relays.length} ‰∏™‰∏≠ÁªßÊàêÂäü`);

                    return results;
                }

                // ÊµãËØïÁâπÂÆö‰∏≠ÁªßÁöÑËøûÊé•ÂíåÊü•ËØ¢
                async testSpecificRelay(relayUrl) {
                    console.log(`üîç ÊµãËØï‰∏≠Áªß ${relayUrl}`);

                    try {
                        // ÊµãËØïËøûÊé•
                        console.log(`1. ÊµãËØïËøûÊé•...`);
                        await this.testRelayConnection(relayUrl);
                        console.log(`‚úÖ ËøûÊé•ÊàêÂäü`);

                        // ÊµãËØïÊü•ËØ¢
                        console.log(`2. ÊµãËØïÊü•ËØ¢...`);
                        const events = await this.pool.querySync([relayUrl], {
                            kinds: [this.eventKinds.LONG_FORM],
                            limit: 10
                        }, {
                            timeout: 10000
                        });

                        console.log(`‚úÖ Êü•ËØ¢ÊàêÂäüÔºåËøîÂõû ${events.length} ‰∏™‰∫ã‰ª∂`);
                        if (events.length > 0) {
                            console.log(`üìù ‰∫ã‰ª∂Á§∫‰æã:`, events[0]);
                        }

                    } catch (error) {
                        console.error(`‚ùå ÊµãËØïÂ§±Ë¥•:`, error.message);
                    }
                }

                // ÊµãËØïÁâπÂÆö‰∏≠ÁªßÁöÑÁâπÂÆöÂÖ¨Èí•Êü•ËØ¢
                async testSpecificRelayForPubkey(relayUrl, pubkey) {
                    console.log(`üîç ÊµãËØï‰∏≠Áªß ${relayUrl} ÂØπÂÖ¨Èí• ${pubkey.substring(0, 16)}... ÁöÑÊü•ËØ¢`);

                    try {
                        // ÊµãËØïËøûÊé•
                        console.log(`1. ÊµãËØïËøûÊé•...`);
                        await this.testRelayConnection(relayUrl);
                        console.log(`‚úÖ ËøûÊé•ÊàêÂäü`);

                        // ÊµãËØïÊü•ËØ¢ÊâÄÊúâÁ±ªÂûã‰∫ã‰ª∂
                        console.log(`2. ÊµãËØïÊü•ËØ¢ÊâÄÊúâÁ±ªÂûã‰∫ã‰ª∂...`);
                        const allEvents = await this.pool.querySync([relayUrl], [
                            {
                                authors: [pubkey],
                                limit: 50
                            }
                        ], {
                            timeout: 10000
                        });

                        console.log(`‚úÖ Êü•ËØ¢ÊâÄÊúâÁ±ªÂûã‰∫ã‰ª∂ÊàêÂäüÔºåËøîÂõû ${allEvents.length} ‰∏™‰∫ã‰ª∂`);
                        if (allEvents.length > 0) {
                            console.log(`üìù ÊâÄÊúâ‰∫ã‰ª∂:`, allEvents.map(e => ({
                                id: e.id.substring(0, 16) + '...',
                                kind: e.kind,
                                created_at: e.created_at,
                                content_preview: e.content.substring(0, 50) + '...'
                            })));
                        }

                        // ÊµãËØïÊü•ËØ¢ 30023 Á±ªÂûã‰∫ã‰ª∂
                        console.log(`3. ÊµãËØïÊü•ËØ¢ 30023 Á±ªÂûã‰∫ã‰ª∂...`);
                        const events30023 = await this.pool.querySync([relayUrl], [
                            {
                                kinds: [30023],
                                authors: [pubkey],
                                limit: 50
                            }
                        ], {
                            timeout: 10000
                        });

                        console.log(`‚úÖ Êü•ËØ¢ 30023 Á±ªÂûã‰∫ã‰ª∂ÊàêÂäüÔºåËøîÂõû ${events30023.length} ‰∏™‰∫ã‰ª∂`);
                        if (events30023.length > 0) {
                            console.log(`üìù 30023 ‰∫ã‰ª∂:`, events30023.map(e => ({
                                id: e.id.substring(0, 16) + '...',
                                kind: e.kind,
                                created_at: e.created_at,
                                content_preview: e.content.substring(0, 50) + '...'
                            })));
                        }

                    } catch (error) {
                        console.error(`‚ùå ÊµãËØïÂ§±Ë¥•:`, error.message);
                    }
                }

                // ÊµãËØïÊó∂Èó¥Á∫øÊü•ËØ¢ÈÄªËæë
                async testTimelineQueryLogic(relayUrl) {
                    console.log(`üîç ÊµãËØïÊó∂Èó¥Á∫øÊü•ËØ¢ÈÄªËæë - ‰∏≠Áªß: ${relayUrl}`);

                    try {
                        // 1. ÊµãËØïÊü•ËØ¢ÊâÄÊúâÁî®Êà∑ÁöÑ 30023 ‰∫ã‰ª∂ÔºàÊó∂Èó¥Á∫øÊü•ËØ¢Ôºâ
                        console.log(`1. ÊµãËØïÊü•ËØ¢ÊâÄÊúâÁî®Êà∑ÁöÑ 30023 ‰∫ã‰ª∂...`);
                        const allEvents = await this.pool.querySync([relayUrl], [
                            {
                                kinds: [30023],
                                limit: 50
                            }
                        ], {
                            timeout: 10000
                        });

                        console.log(`‚úÖ Êü•ËØ¢ÊâÄÊúâÁî®Êà∑‰∫ã‰ª∂ÊàêÂäüÔºåËøîÂõû ${allEvents.length} ‰∏™‰∫ã‰ª∂`);
                        if (allEvents.length > 0) {
                            console.log(`üìù ÊâÄÊúâÁî®Êà∑‰∫ã‰ª∂:`, allEvents.map(e => ({
                                id: e.id.substring(0, 16) + '...',
                                pubkey: e.pubkey.substring(0, 16) + '...',
                                kind: e.kind,
                                created_at: e.created_at,
                                content_preview: e.content.substring(0, 50) + '...'
                            })));
                        }

                        // 2. Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÁâπÂÆöÂÖ¨Èí•ÁöÑ‰∫ã‰ª∂
                        const targetPubkey = '98496f39197bb0da9b8d647560e3d1a96513a3642a3653836543525a56b8f2b8';
                        const targetEvents = allEvents.filter(e => e.pubkey === targetPubkey);

                        console.log(`2. Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÁõÆÊ†áÂÖ¨Èí•ÁöÑ‰∫ã‰ª∂...`);
                        console.log(`ÁõÆÊ†áÂÖ¨Èí•: ${targetPubkey.substring(0, 16)}...`);
                        console.log(`Âú® ${allEvents.length} ‰∏™‰∫ã‰ª∂‰∏≠ÊâæÂà∞ ${targetEvents.length} ‰∏™ÁõÆÊ†áÂÖ¨Èí•‰∫ã‰ª∂`);

                        if (targetEvents.length > 0) {
                            console.log(`üìù ÁõÆÊ†áÂÖ¨Èí•‰∫ã‰ª∂:`, targetEvents.map(e => ({
                                id: e.id.substring(0, 16) + '...',
                                kind: e.kind,
                                created_at: e.created_at,
                                content_preview: e.content.substring(0, 50) + '...'
                            })));
                        } else {
                            console.log(`‚ùå Êú™ÊâæÂà∞ÁõÆÊ†áÂÖ¨Èí•ÁöÑ‰∫ã‰ª∂`);
                        }

                        // 3. ÊµãËØïÊü•ËØ¢ÊâÄÊúâÁ±ªÂûãÁöÑ‰∫ã‰ª∂
                        console.log(`3. ÊµãËØïÊü•ËØ¢ÊâÄÊúâÁ±ªÂûãÁöÑ‰∫ã‰ª∂...`);
                        const allTypeEvents = await this.pool.querySync([relayUrl], [
                            {
                                limit: 50
                            }
                        ], {
                            timeout: 10000
                        });

                        console.log(`‚úÖ Êü•ËØ¢ÊâÄÊúâÁ±ªÂûã‰∫ã‰ª∂ÊàêÂäüÔºåËøîÂõû ${allTypeEvents.length} ‰∏™‰∫ã‰ª∂`);
                        const targetAllTypeEvents = allTypeEvents.filter(e => e.pubkey === targetPubkey);
                        console.log(`Âú®ÊâÄÊúâÁ±ªÂûã‰∫ã‰ª∂‰∏≠ÊâæÂà∞ ${targetAllTypeEvents.length} ‰∏™ÁõÆÊ†áÂÖ¨Èí•‰∫ã‰ª∂`);

                        if (targetAllTypeEvents.length > 0) {
                            console.log(`üìù ÁõÆÊ†áÂÖ¨Èí•ÁöÑÊâÄÊúâÁ±ªÂûã‰∫ã‰ª∂:`, targetAllTypeEvents.map(e => ({
                                id: e.id.substring(0, 16) + '...',
                                kind: e.kind,
                                created_at: e.created_at,
                                content_preview: e.content.substring(0, 50) + '...'
                            })));
                        }

                        return {
                            totalEvents: allEvents.length,
                            targetEvents: targetEvents.length,
                            totalAllTypeEvents: allTypeEvents.length,
                            targetAllTypeEvents: targetAllTypeEvents.length,
                            targetPubkey: targetPubkey.substring(0, 16) + '...'
                        };

                    } catch (error) {
                        console.error(`‚ùå ÊµãËØïÂ§±Ë¥•:`, error.message);
                        throw error;
                    }
                }

                // ‰ΩøÁî®ÂéüÁîü WebSocket ÊµãËØïÊü•ËØ¢
                async testWithRawWebSocket(relayUrl, pubkey) {
                    console.log(`üîç ‰ΩøÁî®ÂéüÁîü WebSocket ÊµãËØï‰∏≠Áªß ${relayUrl}`);

                    return new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('ËøûÊé•Ë∂ÖÊó∂'));
                        }, 10000);

                        try {
                            const ws = new WebSocket(relayUrl);

                            ws.onopen = () => {
                                console.log(`‚úÖ WebSocket ËøûÊé•ÊàêÂäü`);

                                // ÂèëÈÄÅ REQ Ê∂àÊÅØ
                                const reqMessage = [
                                    "REQ",
                                    "test-subscription",
                                    {
                                        kinds: [30023],
                                        authors: [pubkey],
                                        limit: 50
                                    }
                                ];

                                console.log(`üì§ ÂèëÈÄÅÊü•ËØ¢Ê∂àÊÅØ:`, reqMessage);
                                ws.send(JSON.stringify(reqMessage));

                                // ËÆæÁΩÆÊ∂àÊÅØÂ§ÑÁêÜ
                                let eventCount = 0;
                                ws.onmessage = (event) => {
                                    try {
                                        const data = JSON.parse(event.data);
                                        console.log(`üì• Êî∂Âà∞Ê∂àÊÅØ:`, data);

                                        if (data[0] === 'EVENT') {
                                            eventCount++;
                                            console.log(`üìù Êî∂Âà∞‰∫ã‰ª∂ ${eventCount}:`, data[2]);
                                        } else if (data[0] === 'EOSE') {
                                            console.log(`‚úÖ Êü•ËØ¢ÂÆåÊàêÔºåÊÄªÂÖ±Êî∂Âà∞ ${eventCount} ‰∏™‰∫ã‰ª∂`);
                                            clearTimeout(timeout);
                                            ws.close();
                                            resolve(eventCount);
                                        }
                                    } catch (error) {
                                        console.error(`‚ùå Ëß£ÊûêÊ∂àÊÅØÂ§±Ë¥•:`, error);
                                    }
                                };

                                ws.onerror = (error) => {
                                    console.error(`‚ùå WebSocket ÈîôËØØ:`, error);
                                    clearTimeout(timeout);
                                    reject(error);
                                };

                                ws.onclose = () => {
                                    console.log(`üîå WebSocket ËøûÊé•ÂÖ≥Èó≠`);
                                };

                            };

                            ws.onerror = (error) => {
                                console.error(`‚ùå WebSocket ËøûÊé•Â§±Ë¥•:`, error);
                                clearTimeout(timeout);
                                reject(error);
                            };

                        } catch (error) {
                            console.error(`‚ùå WebSocket ÂàõÂª∫Â§±Ë¥•:`, error);
                            clearTimeout(timeout);
                            reject(error);
                        }
                    });
                }



                // Ê∑ªÂä†‰∏≠Áªß
                async addRelay(relayUrl) {
                    if (this.relays.includes(relayUrl)) {
                        throw new Error('ËØ•‰∏≠ÁªßÂ∑≤Â≠òÂú®');
                    }

                    await this.testRelayConnection(relayUrl);
                    this.relays.push(relayUrl);
                    this.connectionStatus.set(relayUrl, 'connected');

                    console.log(`‰∏≠ÁªßÊ∑ªÂä†ÊàêÂäü: ${relayUrl}`);
                }

                // Ëé∑Âèñ‰∏≠ÁªßÂàóË°®
                getRelays() {
                    return this.relays.map(url => ({
                        url,
                        connected: this.connectionStatus.get(url) === 'connected'
                    }));
                }

                // Â∑•ÂÖ∑ÊñπÊ≥ï
                truncateKey(key, length = 16) {
                    if (!key) return '';
                    return key.length > length ? key.substring(0, length) + '...' : key;
                }

                formatTime(timestamp) {
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString('zh-CN');
                }

                getTagValue(tags, tagName) {
                    const tag = tags.find(t => t[0] === tagName);
                    return tag ? tag[1] : null;
                }

                destroy() {
                    this.pool.close(this.relays);
                }

                // NIP-42 ËÆ§ËØÅÁõ∏ÂÖ≥ÊñπÊ≥ï
                
                // ÂàõÂª∫ËÆ§ËØÅ‰∫ã‰ª∂ (kind 22242)
                async createAuthEvent(challenge, relayUrl) {
                    if (!this.privateKey || !this.publicKey) {
                        throw new Error('ÈúÄË¶ÅÂÖàËÆæÁΩÆÁî®Êà∑ÂØÜÈí•ÂØπ');
                    }

                    const tags = [
                        ['relay', relayUrl],
                        ['challenge', challenge]
                    ];

                    const authEvent = {
                        kind: 22242,
                        created_at: Math.floor(Date.now() / 1000),
                        tags,
                        content: '',
                        pubkey: this.publicKey
                    };

                    // ‰ΩøÁî® nostr-tools Á≠æÂêç
                    const signedEvent = finalizeEvent(authEvent, this.privateKey);
                    return signedEvent;
                }

                // Â§ÑÁêÜ AUTH Ê∂àÊÅØ
                async handleAuthChallenge(relayUrl, challenge) {
                    try {
                        console.log(`üîê Êî∂Âà∞ËÆ§ËØÅÊåëÊàò from ${relayUrl}: ${challenge}`);
                        this.addAuthLog(`üì® Êî∂Âà∞ ${relayUrl} ËÆ§ËØÅÊåëÊàò`);
                        
                        // Â≠òÂÇ®ÊåëÊàò
                        this.authChallenges.set(relayUrl, challenge);

                        // ÂàõÂª∫ËÆ§ËØÅ‰∫ã‰ª∂
                        const authEvent = await this.createAuthEvent(challenge, relayUrl);
                        console.log(`üîê ÂàõÂª∫ËÆ§ËØÅ‰∫ã‰ª∂:`, authEvent);
                        this.addAuthLog(`üîß ÂàõÂª∫ËÆ§ËØÅ‰∫ã‰ª∂ (kind: ${authEvent.kind})`);

                        return authEvent;
                    } catch (error) {
                        console.error(`üîê Â§ÑÁêÜËÆ§ËØÅÊåëÊàòÂ§±Ë¥•:`, error);
                        this.addAuthLog(`‚ùå ${relayUrl} ËÆ§ËØÅÊåëÊàòÂ§ÑÁêÜÂ§±Ë¥•: ${error.message}`);
                        throw error;
                    }
                }

                // Ê£ÄÊü•‰∏≠ÁªßÊòØÂê¶Â∑≤ËÆ§ËØÅ
                isAuthenticated(relayUrl) {
                    return this.authStatus.get(relayUrl) === true;
                }

                // ËÆæÁΩÆ‰∏≠ÁªßËÆ§ËØÅÁä∂ÊÄÅ
                setAuthStatus(relayUrl, status) {
                    this.authStatus.set(relayUrl, status);
                    console.log(`üîê ${relayUrl} ËÆ§ËØÅÁä∂ÊÄÅ: ${status ? 'Â∑≤ËÆ§ËØÅ' : 'Êú™ËÆ§ËØÅ'}`);
                    
                    // Ê∑ªÂä†Âà∞ËÆ§ËØÅÊó•Âøó
                    this.addAuthLog(`${relayUrl} - ${status ? '‚úÖ ËÆ§ËØÅÊàêÂäü' : '‚ùå ËÆ§ËØÅÂ§±Ë¥•'}`);
                }

                // Ê∑ªÂä†ËÆ§ËØÅÊó•ÂøóÊù°ÁõÆ
                addAuthLog(message) {
                    const authLog = document.getElementById('auth-log');
                    if (authLog) {
                        const time = new Date().toLocaleTimeString();
                        const logEntry = document.createElement('div');
                        logEntry.innerHTML = `<span style="color: #6c757d;">[${time}]</span> ${message}`;
                        logEntry.style.marginBottom = '2px';
                        
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™Êó•ÂøóÔºåÊ∏ÖÁ©∫ÈªòËÆ§ÊèêÁ§∫
                        if (authLog.innerHTML.includes('ËÆ§ËØÅ‰∫ã‰ª∂Â∞ÜÂú®Ê≠§Â§ÑÊòæÁ§∫')) {
                            authLog.innerHTML = '';
                        }
                        
                        authLog.appendChild(logEntry);
                        // ÊªöÂä®Âà∞Â∫ïÈÉ®
                        authLog.scrollTop = authLog.scrollHeight;
                    }
                }

                // ‰∏≠ÁªßÁÆ°ÁêÜÊñπÊ≥ï
                loadRelaysFromStorage() {
                    try {
                        const savedRelays = localStorage.getItem('nostr-relays');
                        if (savedRelays) {
                            return JSON.parse(savedRelays);
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩ‰∏≠ÁªßÂàóË°®Â§±Ë¥•:', error);
                    }
                    return [...this.defaultRelays]; // ËøîÂõûÈªòËÆ§ÂàóË°®ÁöÑÂâØÊú¨
                }

                saveRelaysToStorage() {
                    try {
                        localStorage.setItem('nostr-relays', JSON.stringify(this.relays));
                        console.log('‰∏≠ÁªßÂàóË°®Â∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
                    } catch (error) {
                        console.error('‰øùÂ≠ò‰∏≠ÁªßÂàóË°®Â§±Ë¥•:', error);
                    }
                }

                getRecommendedRelays() {
                    // ËøîÂõûÂ∞öÊú™Ê∑ªÂä†ÁöÑÊé®Ëçê‰∏≠Áªß
                    return this.recommendedRelays.filter(relay =>
                        !this.relays.includes(relay.url)
                    );
                }

                async addRelay(relayUrl) {
                    if (this.relays.includes(relayUrl)) {
                        throw new Error('ËØ•‰∏≠ÁªßÂ∑≤Â≠òÂú®');
                    }

                    await this.testRelayConnection(relayUrl);
                    this.relays.push(relayUrl);
                    this.connectionStatus.set(relayUrl, 'connected');
                    this.saveRelaysToStorage(); // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®

                    console.log(`‰∏≠ÁªßÊ∑ªÂä†ÊàêÂäü: ${relayUrl}`);
                }

                removeRelay(relayUrl) {
                    const index = this.relays.indexOf(relayUrl);
                    if (index > -1) {
                        this.relays.splice(index, 1);
                        this.connectionStatus.delete(relayUrl);
                        this.saveRelaysToStorage(); // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        console.log(`‰∏≠ÁªßÁßªÈô§ÊàêÂäü: ${relayUrl}`);
                        return true;
                    }
                    return false;
                }
            }

            // Â∫îÁî®Á±ª
            class NostrApp {
                constructor() {
                    this.client = new RealNostrClient();
                    this.currentSection = 'auth';
                    this.currentTab = 'create';
                    this.articles = [];
                }

                async init() {
                    this.createUI();
                    this.bindEvents();

                    const savedUser = localStorage.getItem('nostr-user');
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        // Ê≥®ÊÑèÔºöÁßÅÈí•ÈúÄË¶Å‰ªé nsec ÈáçÊñ∞Ëß£Á†Å
                        if (user.nsec) {
                            try {
                                const decoded = nip19.decode(user.nsec);
                                this.client.privateKey = decoded.data;
                                this.client.publicKey = user.publicKey;
                                this.showUserInfo(user);
                                this.showSection('main');
                                // Âª∂ËøüÊõ¥Êñ∞ÂØÜÈí•ÊòæÁ§∫ÔºåÁ°Æ‰øù DOM Â∑≤Âä†ËΩΩ
                                setTimeout(() => {
                                    this.updateKeyDisplay();
                                }, 100);
                            } catch (error) {
                                console.error('ÊÅ¢Â§çÁî®Êà∑‰ºöËØùÂ§±Ë¥•:', error);
                                localStorage.removeItem('nostr-user');
                            }
                        }
                    }

                    this.updateRelayList();
                    this.updateQuickAddRelays();
                }

                createUI() {
                    const app = document.getElementById('app');
                    app.innerHTML = `
                    <div id="auth-section" class="section" style="display: ${this.currentSection === 'auth' ? 'block' : 'none'};">
                        <h2>Ê¨¢Ëøé‰ΩøÁî® Nostr Demo</h2>

                        <div class="tabs">
                            <button class="tab active" data-tab="create">ÂàõÂª∫Ë¥¶Âè∑</button>
                            <button class="tab" data-tab="import">ÂØºÂÖ•Ë¥¶Âè∑</button>
                        </div>

                        <div id="create-tab" class="tab-content active">
                            <div class="form-group">
                                <label for="userName">Áî®Êà∑Âêç:</label>
                                <input type="text" id="userName" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç">
                            </div>

                            <div class="form-group">
                                <label for="userAbout">‰∏™‰∫∫ÁÆÄ‰ªã:</label>
                                <textarea id="userAbout" placeholder="ËØ∑ËæìÂÖ•‰∏™‰∫∫ÁÆÄ‰ªã"></textarea>
                            </div>

                            <button id="createAccount">ÂàõÂª∫Ë¥¶Âè∑</button>
                        </div>

                        <div id="import-tab" class="tab-content">
                            <div class="form-group">
                                <label for="nsecInput">ÁßÅÈí• (nsec):</label>
                                <input type="password" id="nsecInput" placeholder="ËØ∑ËæìÂÖ• nsec ÁßÅÈí•">
                            </div>

                            <button id="importAccount">ÂØºÂÖ•Ë¥¶Âè∑</button>
                        </div>
                    </div>

                    <div id="main-section" class="section" style="display: ${this.currentSection === 'main' ? 'block' : 'none'};">
                        <div id="user-info" class="user-info">
                            <strong>Áî®Êà∑:</strong> <span id="user-name"></span>
                            (<span id="user-pubkey"></span>)
                            <br>
                            <strong>ÁÆÄ‰ªã:</strong> <span id="user-about"></span>
                        </div>

                        <div class="tabs">
                            <button class="tab active" data-tab="timeline">Êó∂Èó¥Á∫ø</button>
                            <button class="tab" data-tab="publish">ÂèëÂ∏ÉÊñáÁ´†</button>
                            <button class="tab" data-tab="favorites">ÊàëÁöÑÊî∂Ëóè</button>
                            <button class="tab" data-tab="following">ÊàëÂÖ≥Ê≥®ÁöÑ‰∫∫</button>
                            <button class="tab" data-tab="keys">ÂØÜÈí•ÁÆ°ÁêÜ</button>
                            <button class="tab" data-tab="relays">‰∏≠ÁªßÁÆ°ÁêÜ</button>
                        </div>

                        <div id="timeline-tab" class="tab-content active">
                            <div style="margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <label style="margin-right: 10px; font-weight: 600;">Êó∂Èó¥Á∫øÁ±ªÂûã:</label>
                                        <select id="timelineType" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                            <option value="global">ÂÖ®Â±ÄÊó∂Èó¥Á∫ø</option>
                                            <option value="followed">ÂÖ≥Ê≥®Áî®Êà∑</option>
                                            <option value="user">ÊàëÁöÑÊñáÁ´†</option>
                                        </select>
                                        <button id="refreshTimeline" style="margin-left: 10px;">Âà∑Êñ∞Êó∂Èó¥Á∫ø</button>
                                        <button id="debugRelays" class="dev-button" style="background: #6c757d; margin-left: 10px;">Ë∞ÉËØï‰∏≠Áªß</button>
                    <button id="testSpecificPubkey" class="dev-button" style="background: #28a745; margin-left: 10px;">ÊµãËØïÁâπÂÆöÂÖ¨Èí•</button>
                    <button id="testSpecificRelay" class="dev-button" style="background: #ffc107; margin-left: 10px;">ÊµãËØïÁâπÂÆö‰∏≠Áªß</button>
                    <button id="test30023Events" class="dev-button" style="background: #17a2b8; margin-left: 10px;">ÊµãËØï30023‰∫ã‰ª∂</button>
                    <button id="queryEventById" class="dev-button" style="background: #6f42c1; margin-left: 10px;">Ê†πÊçÆIDÊü•ËØ¢</button>
                    <button id="testSpecificRelayForPubkey" class="dev-button" style="background: #6f42c1; margin-left: 10px;">ÊµãËØïÁâπÂÆö‰∏≠ÁªßÂÖ¨Èí•</button>
                    <button id="testRawWebSocket" class="dev-button" style="background: #fd7e14; margin-left: 10px;">ÂéüÁîüWebSocketÊµãËØï</button>
                    <button id="testTimelineLogic" class="dev-button" style="background: #20c997; margin-left: 10px;">ÊµãËØïÊó∂Èó¥Á∫øÈÄªËæë</button>
                    <button id="customComment" class="dev-button" style="background: #e83e8c; margin-left: 10px;">Ëá™ÂÆö‰πâËØÑËÆ∫</button>
                    <button id="testAuth" class="dev-button" style="background: #9b59b6; margin-left: 10px;">üîê ÊµãËØïËÆ§ËØÅ</button>
                    <button id="testAuthReq" class="dev-button" style="background: #8e44ad; margin-left: 10px;">üîç Ê£ÄÊµãËÆ§ËØÅÈúÄÊ±Ç</button>
                    <button id="toggleDevMode" style="background: #6c757d; margin-left: 10px;">üîß ÂºÄÂèëËÄÖÊ®°Âºè</button>
                                    </div>
                            </div>

                            <div id="timeline-content">
                                <div class="loading">Êó∂Èó¥Á∫øÂäüËÉΩÊºîÁ§∫‰∏≠...</div>
                            </div>
                        </div>

                        <div id="favorites-tab" class="tab-content">
                            <div style="margin-bottom: 20px;">
                                <h2>ÊàëÁöÑÊî∂Ëóè</h2>
                                <div id="favorites-content">
                                    <div class="loading">Ê≠£Âú®Âä†ËΩΩÊî∂ËóèÊñáÁ´†...</div>
                                </div>
                            </div>
                        </div>

                        <div id="following-tab" class="tab-content">
                            <div style="margin-bottom: 20px;">
                                <h2>ÊàëÂÖ≥Ê≥®ÁöÑ‰∫∫</h2>
                                <div id="following-content">
                                    <div class="loading">Ê≠£Âú®Âä†ËΩΩÂÖ≥Ê≥®ÂàóË°®...</div>
                                </div>
                            </div>
                        </div>

                        <div id="article-viewer" style="display:none">
                            <button id="back-to-timeline" style="margin-bottom: 20px;">‚Üê ËøîÂõûÊó∂Èó¥Á∫ø</button>
                            <div id="article-content"></div>
                        </div>

                        <div id="article-editor" style="display:none">
                            <button id="back-to-timeline-from-editor" style="margin-bottom: 20px;">‚Üê ËøîÂõûÊó∂Èó¥Á∫ø</button>
                            <div style="margin-bottom: 20px;">
                                <h3>ÁºñËæëÊñáÁ´†</h3>
                            </div>
                            <div class="form-group">
                                <label for="edit-articleTitle">ÊñáÁ´†Ê†áÈ¢ò:</label>
                                <input type="text" id="edit-articleTitle" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò">
                            </div>
                            <div class="form-group">
                                <label for="edit-articleDTag">ÊñáÁ´†Ê†áËØÜ (dTag):</label>
                                <input type="text" id="edit-articleDTag" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áËØÜÔºåÁïôÁ©∫Â∞ÜËá™Âä®ÁîüÊàê">
                                <small style="color: #666; font-size: 12px;">dTag Áî®‰∫éÂîØ‰∏ÄÊ†áËØÜÊñáÁ´†Ôºå‰ΩøÁî® <code>content_id</code> </small>
                            </div>
                            <div class="form-group">
                                <label for="edit-articleContent">ÊñáÁ´†ÂÜÖÂÆπ:</label>
                                <textarea id="edit-articleContent" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπ" rows="10"></textarea>
                            </div>
                            <div style="margin-top: 20px;">
                                <button id="update-article" style="background: #28a745; margin-right: 10px;">Êõ¥Êñ∞ÊñáÁ´†</button>
                                <button id="cancel-edit" style="background: #6c757d;">ÂèñÊ∂àÁºñËæë</button>
                            </div>
                        </div>

                        <div id="custom-comment-page" style="display:none">
                            <button id="back-to-timeline-from-comment" style="margin-bottom: 20px;">‚Üê ËøîÂõûÊó∂Èó¥Á∫ø</button>
                            <div style="margin-bottom: 20px;">
                                <h3>Ëá™ÂÆö‰πâËØÑËÆ∫ÂàõÂª∫ (kind: 1111)</h3>
                                <p style="color: #666; font-size: 14px;">Áî®‰∫éÊµãËØï relay ÂØπÂêÑÁßçÊ†áÁ≠æÁªÑÂêàÁöÑÂ§ÑÁêÜ</p>
                            </div>
                            <div class="form-group">
                                <label for="comment-content">ËØÑËÆ∫ÂÜÖÂÆπ:</label>
                                <textarea id="comment-content" placeholder="ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ" rows="5"></textarea>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label for="comment-a-tag">A tag (ÈïøÊñáÁ´†Âú∞ÂùÄ):</label>
                                    <input type="text" id="comment-a-tag" placeholder="naddr1... ÊàñÁïôÁ©∫">
                                    <small style="color: #666; font-size: 12px;">ÂºïÁî®ÈïøÊñáÁ´†ÁöÑÂú∞ÂùÄ</small>
                                </div>
                                <div class="form-group">
                                    <label for="comment-p-tag">p tag (Áî®Êà∑ÂÖ¨Èí•):</label>
                                    <input type="text" id="comment-p-tag" placeholder="Áî®Êà∑ÂÖ¨Èí• hex Ê†ºÂºè">
                                    <small style="color: #666; font-size: 12px;">ÊèêÂèäÁöÑÁî®Êà∑</small>
                                </div>
                                <div class="form-group">
                                    <label for="comment-e-tag">e tag (‰∫ã‰ª∂ ID):</label>
                                    <input type="text" id="comment-e-tag" placeholder="‰∫ã‰ª∂ ID hex Ê†ºÂºè">
                                    <small style="color: #666; font-size: 12px;">ÂõûÂ§çÁöÑ‰∫ã‰ª∂ ID</small>
                                </div>
                                <div class="form-group">
                                    <label for="comment-P-tag">P tag (Ëá™ÂÆö‰πâ):</label>
                                    <input type="text" id="comment-P-tag" placeholder="ÁïôÁ©∫ÊàñËá™ÂÆö‰πâÂÄº">
                                    <small style="color: #666; font-size: 12px;">Ëá™ÂÆö‰πâ P Ê†áÁ≠æÂÜÖÂÆπ</small>
                                </div>
                                <div class="form-group">
                                    <label for="comment-E-tag">E tag (‰∫ã‰ª∂Âú∞ÂùÄ):</label>
                                    <input type="text" id="comment-E-tag" placeholder="‰∫ã‰ª∂Âú∞ÂùÄ">
                                    <small style="color: #666; font-size: 12px;">Êõø‰ª£‰∫ã‰ª∂Âú∞ÂùÄ</small>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button id="create-custom-comment" style="background: #28a745; margin-right: 10px;">ÂèëÂ∏ÉËá™ÂÆö‰πâËØÑËÆ∫</button>
                                <button id="cancel-custom-comment" style="background: #6c757d;">ÂèñÊ∂à</button>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
                                <h4 style="margin: 0 0 10px 0; color: #856404;">ÊµãËØïËØ¥Êòé:</h4>
                                <ul style="margin: 0; color: #856404; font-size: 14px;">
                                    <li>A tag: ÊµãËØïÂºïÁî®‰∏çÂ≠òÂú®ÁöÑÈïøÊñáÁ´†‰ºöÂ¶Ç‰Ωï</li>
                                    <li>P tag: ÊµãËØïËá™ÂÆö‰πâ P Ê†áÁ≠æÁöÑÂ§ÑÁêÜ</li>
                                    <li>e tag: ÊµãËØïÂõûÂ§ç‰∏çÂ≠òÂú®‰∫ã‰ª∂ÁöÑÂ§ÑÁêÜ</li>
                                    <li>k/K Ê†áÁ≠æ: Ëá™Âä®Ê∑ªÂä†ÈªòËÆ§ÂÄº (k=1111, K=30023)</li>
                                    <li>ÁïôÁ©∫Êüê‰∫õÂ≠óÊÆµÊµãËØï relay ÁöÑÂÆπÈîôÊÄß</li>
                                </ul>
                            </div>
                        </div>

                        <div id="publish-tab" class="tab-content">
                            <div class="form-group">
                                <label for="articleTitle">ÊñáÁ´†Ê†áÈ¢ò:</label>
                                <input type="text" id="articleTitle" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò">
                            </div>
                            <div class="form-group">
                                <label for="articleDTag">ÊñáÁ´†Ê†áËØÜ (dTag):</label>
                                <input type="text" id="articleDTag" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áËØÜÔºåÁïôÁ©∫Â∞ÜËá™Âä®ÁîüÊàê">
                                <small style="color: #666; font-size: 12px;">dTag Áî®‰∫éÂîØ‰∏ÄÊ†áËØÜÊñáÁ´†Ôºå‰ΩøÁî® <code>content_id</code> </small>
                            </div>
                            <div class="form-group">
                                <label for="articleContent">ÊñáÁ´†ÂÜÖÂÆπ:</label>
                                <textarea id="articleContent" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπ" rows="10"></textarea>
                            </div>
                            <button id="publishArticle">ÂèëÂ∏ÉÊñáÁ´†</button>
                        </div>

                            <div id="keys-tab" class="tab-content">
                                <div class="form-group">
                                    <h3>üîë ÂÖ¨Èí•‰ø°ÊÅØ</h3>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                        <div style="margin-bottom: 15px;">
                                            <label style="font-weight: 600; color: #667eea;">Ê†ºÂºèÈÄâÊã©:</label>
                                            <div style="margin-top: 8px;">
                                                <button id="format-npub" class="format-btn active" data-format="npub">npub Ê†ºÂºè</button>
                                                <button id="format-hex" class="format-btn" data-format="hex">Hex Ê†ºÂºè</button>
                                            </div>
                                        </div>

                                        <div style="margin-bottom: 15px;">
                                            <label style="font-weight: 600; color: #667eea;">ÂÖ¨Èí•:</label>
                                            <div style="display: flex; align-items: center; margin-top: 8px;">
                                                <input type="text" id="public-key-display" readonly style="flex: 1; margin-right: 10px; font-family: monospace; font-size: 14px;">
                                                <button id="copy-public-key" style="background: #28a745; padding: 8px 16px; font-size: 14px;">
                                                    üìã Â§çÂà∂
                                                </button>
                                            </div>
                                        </div>

                                        <div style="margin-bottom: 15px;">
                                            <label style="font-weight: 600; color: #667eea;">ÁßÅÈí• (nsec):</label>
                                            <div style="display: flex; align-items: center; margin-top: 8px;">
                                                <input type="password" id="private-key-display" readonly style="flex: 1; margin-right: 10px; font-family: monospace; font-size: 14px;">
                                                <button id="copy-private-key" style="background: #dc3545; padding: 8px 16px; font-size: 14px;">
                                                    üìã Â§çÂà∂
                                                </button>
                                                <button id="toggle-private-key" style="background: #6c757d; padding: 8px 16px; font-size: 14px; margin-left: 5px;">
                                                    üëÅÔ∏è ÊòæÁ§∫
                                                </button>
                                            </div>
                                        </div>

                                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 4px; font-size: 14px;">
                                            <strong>‚ö†Ô∏è ÂÆâÂÖ®ÊèêÈÜí:</strong>
                                            <ul style="margin: 10px 0 0 20px;">
                                                <li>ËØ∑Â¶•ÂñÑ‰øùÁÆ°ÊÇ®ÁöÑÁßÅÈí•Ôºå‰∏çË¶ÅÂàÜ‰∫´Áªô‰ªª‰Ωï‰∫∫</li>
                                                <li>ÁßÅÈí•‰∏¢Â§±Â∞ÜÊó†Ê≥ïÊÅ¢Â§çÊÇ®ÁöÑË¥¶Âè∑</li>
                                                <li>Âª∫ËÆÆÂ∞ÜÁßÅÈí•Â§á‰ªΩÂà∞ÂÆâÂÖ®ÁöÑÂú∞Êñπ</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <div id="relays-tab" class="tab-content">
                            <div class="form-group">
                                <label for="relayUrl">‰∏≠ÁªßÂú∞ÂùÄ:</label>
                                <input type="url" id="relayUrl" placeholder="wss://relay.example.com">
                            </div>

                            <button id="addRelay">Ê∑ªÂä†‰∏≠Áªß</button>

                                <div style="margin: 20px 0;">
                                    <h4>Âø´ÈÄüÊ∑ªÂä†Â∏∏Áî®‰∏≠Áªß:</h4>
                                    <div id="quick-add-relays"></div>
                                </div>

                            <div id="relay-list">
                                <h3>‰∏≠ÁªßÂàóË°®</h3>
                                <div id="relay-items"></div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h4>üîê ËÆ§ËØÅÊó•Âøó</h4>
                                <div id="auth-log" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                                    <div style="color: #6c757d;">ËÆ§ËØÅ‰∫ã‰ª∂Â∞ÜÂú®Ê≠§Â§ÑÊòæÁ§∫...</div>
                                </div>
                                <button id="clearAuthLog" style="margin-top: 10px; background: #6c757d; font-size: 12px;">Ê∏ÖÁ©∫Êó•Âøó</button>
                            </div>
                        </div>
                    </div>
                `;
                }

                bindEvents() {
                    // Ê†áÁ≠æÂàáÊç¢
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tab')) {
                            this.switchTab(e.target.dataset.tab);
                            if (e.target.dataset.tab === 'relays') {
                                this.updateRelayList();
                            }
                        }
                    });

                    // ÂàõÂª∫Ë¥¶Âè∑
                    document.getElementById('createAccount').addEventListener('click', async () => {
                        await this.handleCreateAccount();
                    });

                    // ÂØºÂÖ•Ë¥¶Âè∑
                    document.getElementById('importAccount').addEventListener('click', async () => {
                        await this.handleImportAccount();
                    });

                    // ÂèëÂ∏ÉÊñáÁ´†
                    document.getElementById('publishArticle').addEventListener('click', async () => {
                        await this.handlePublishArticle();
                    });

                    // Âà∑Êñ∞Êó∂Èó¥Á∫ø
                    document.getElementById('refreshTimeline').addEventListener('click', async () => {
                        await this.handleRefreshTimeline();
                    });

                    // Ë∞ÉËØï‰∏≠Áªß
                    document.getElementById('debugRelays').addEventListener('click', async () => {
                        await this.handleDebugRelays();
                    });

                    document.getElementById('testSpecificPubkey').addEventListener('click', async () => {
                        const pubkey = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÂÖ¨Èí• (hex Ê†ºÂºè):', '98496f39197bb0da9b8d647560e3d1a96513a3642a3653836543525a56b8f2b8');
                        if (pubkey) {
                            await this.client.testSpecificPubkey(pubkey);
                        }
                    });

                    document.getElementById('testSpecificRelay').addEventListener('click', async () => {
                        const relayUrl = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑ‰∏≠Áªß URL:', 'wss://nostr.internal.ikandev.xyz');
                        if (relayUrl) {
                            await this.client.testSpecificRelay(relayUrl);
                        }
                    });

                    document.getElementById('test30023Events').addEventListener('click', async () => {
                        const pubkey = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÂÖ¨Èí• (hex Ê†ºÂºè):', '98496f39197bb0da9b8d647560e3d1a96513a3642a3653836543525a56b8f2b8');
                        if (pubkey) {
                            await this.client.testSpecificPubkey30023(pubkey);
                        }
                    });

                    document.getElementById('queryEventById').addEventListener('click', async () => {
                        const eventId = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊü•ËØ¢ÁöÑ‰∫ã‰ª∂ ID (hex Ê†ºÂºè):', '5a30e25ce5618461faca1408cb81699896b271d7ec27c128e53056921e5f3df7');
                        if (eventId) {
                            try {
                                const results = await this.client.queryEventById(eventId);
                                console.log(`‚úÖ Ê†πÊçÆ ID Êü•ËØ¢ÂÆåÊàê:`, results);
                            } catch (error) {
                                console.error(`‚ùå Ê†πÊçÆ ID Êü•ËØ¢Â§±Ë¥•:`, error.message);
                            }
                        }
                    });

                    document.getElementById('testSpecificRelayForPubkey').addEventListener('click', async () => {
                        const relayUrl = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑ‰∏≠Áªß URL:', 'wss://nostr.internal.ikandev.xyz');
                        const pubkey = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÂÖ¨Èí• (hex Ê†ºÂºè):', '98496f39197bb0da9b8d647560e3d1a96513a3642a3653836543525a56b8f2b8');
                        if (relayUrl && pubkey) {
                            await this.client.testSpecificRelayForPubkey(relayUrl, pubkey);
                        }
                    });

                    document.getElementById('testRawWebSocket').addEventListener('click', async () => {
                        const relayUrl = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑ‰∏≠Áªß URL:', 'wss://nostr.internal.ikandev.xyz');
                        const pubkey = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑÂÖ¨Èí• (hex Ê†ºÂºè):', '98496f39197bb0da9b8d647560e3d1a96513a3642a3653836543525a56b8f2b8');
                        if (relayUrl && pubkey) {
                            try {
                                const eventCount = await this.client.testWithRawWebSocket(relayUrl, pubkey);
                                console.log(`‚úÖ ÂéüÁîü WebSocket ÊµãËØïÂÆåÊàêÔºåÊî∂Âà∞ ${eventCount} ‰∏™‰∫ã‰ª∂`);
                            } catch (error) {
                                console.error(`‚ùå ÂéüÁîü WebSocket ÊµãËØïÂ§±Ë¥•:`, error.message);
                            }
                        }
                    });

                    document.getElementById('testTimelineLogic').addEventListener('click', async () => {
                        const relayUrl = prompt('ËØ∑ËæìÂÖ•Ë¶ÅÊµãËØïÁöÑ‰∏≠Áªß URL:', 'wss://nostr.internal.ikandev.xyz');
                        if (relayUrl) {
                            try {
                                const result = await this.client.testTimelineQueryLogic(relayUrl);
                                console.log(`‚úÖ Êó∂Èó¥Á∫øÈÄªËæëÊµãËØïÂÆåÊàê:`, result);
                            } catch (error) {
                                console.error(`‚ùå Êó∂Èó¥Á∫øÈÄªËæëÊµãËØïÂ§±Ë¥•:`, error.message);
                            }
                        }
                    });

                    // ÂºÄÂèëËÄÖÊ®°ÂºèÂàáÊç¢
                    document.getElementById('toggleDevMode').addEventListener('click', () => {
                        this.toggleDevMode();
                    });

                    // Ê∑ªÂä†‰∏≠Áªß
                    document.getElementById('addRelay').addEventListener('click', async () => {
                        await this.handleAddRelay();
                    });

                    // Âø´ÈÄüÊ∑ªÂä†‰∏≠ÁªßÊåâÈíÆ‰ºöÂú® updateQuickAddRelays ‰∏≠Âä®ÊÄÅÁªëÂÆö

                    // ÊñáÁ´†Êìç‰Ωú
                    document.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('like-btn')) {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleLikeArticle(e.target);
                        }
                        if (e.target.classList.contains('bookmark-btn')) {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleBookmarkArticle(e.target);
                        }
                        if (e.target.classList.contains('follow-btn')) {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleFollowAuthor(e.target);
                        }
                        if (e.target.classList.contains('comment-btn')) {
                            e.preventDefault();
                            e.stopPropagation();
                            await this.handleCommentArticle(e.target);
                        }
                        if (e.target.classList.contains('show-json-btn')) {
                            const eventId = e.target.dataset.eventId;
                            this.showEventJson(eventId);
                        }
                        if (e.target.classList.contains('close-json-btn')) {
                            const eventId = e.target.dataset.eventId;
                            this.hideEventJson(eventId);
                        }
                        if (e.target.classList.contains('copy-json-btn')) {
                            const eventId = e.target.dataset.eventId;
                            this.copyEventJson(eventId);
                        }
                        // ÊñáÁ´†Ê†áÈ¢òÁÇπÂáª‰∫ã‰ª∂
                        if (e.target.classList.contains('article-title') && e.target.dataset.articleId) {
                            const articleId = e.target.dataset.articleId;
                            await this.showArticleViewer(articleId);
                        }

                        // ËØ¶ÊÉÖÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                        if (e.target.classList.contains('view-detail-btn') && e.target.dataset.articleId) {
                            const articleId = e.target.dataset.articleId;
                            await this.showArticleViewer(articleId);
                        }

                        // ÁºñËæëÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                        if (e.target.classList.contains('edit-btn') && e.target.dataset.articleId) {
                            const articleId = e.target.dataset.articleId;
                            await this.showArticleEditor(articleId);
                        }
                    });

                    // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('json-modal')) {
                            const eventId = e.target.id.replace('json-modal-', '');
                            this.hideEventJson(eventId);
                        }
                    });

                    // ÂØÜÈí•ÁÆ°ÁêÜÂäüËÉΩ
                    this.bindKeyManagementEvents();

                    // Êõ¥Êñ∞‰∏≠ÁªßÂàóË°®ÔºåÊòæÁ§∫ËøûÊé•Áä∂ÊÄÅ
                    this.updateRelayList();
                }

                bindKeyManagementEvents() {
                    // Ê†ºÂºèÂàáÊç¢
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('format-btn')) {
                            this.switchKeyFormat(e.target.dataset.format);
                        }
                    });

                    // Â§çÂà∂ÂÖ¨Èí•
                    document.getElementById('copy-public-key').addEventListener('click', () => {
                        this.copyToClipboard('public-key-display', 'copy-public-key');
                    });

                    // Â§çÂà∂ÁßÅÈí•
                    document.getElementById('copy-private-key').addEventListener('click', () => {
                        this.copyToClipboard('private-key-display', 'copy-private-key');
                    });

                    // ÂàáÊç¢ÁßÅÈí•ÊòæÁ§∫
                    document.getElementById('toggle-private-key').addEventListener('click', () => {
                        this.togglePrivateKeyVisibility();
                    });

                    // ÁºñËæëÈ°µÈù¢ËøîÂõûÊåâÈíÆ
                    document.getElementById('back-to-timeline-from-editor').addEventListener('click', () => {
                        this.hideArticleEditor();
                    });

                    // Êõ¥Êñ∞ÊñáÁ´†ÊåâÈíÆ
                    document.getElementById('update-article').addEventListener('click', async () => {
                        await this.handleUpdateArticle();
                    });

                    // ÂèñÊ∂àÁºñËæëÊåâÈíÆ
                    document.getElementById('cancel-edit').addEventListener('click', () => {
                        this.hideArticleEditor();
                    });

                    // Ëá™ÂÆö‰πâËØÑËÆ∫ÊåâÈíÆ
                    document.getElementById('customComment').addEventListener('click', () => {
                        this.showCustomCommentPage();
                    });

                    // Ëá™ÂÆö‰πâËØÑËÆ∫È°µÈù¢ËøîÂõûÊåâÈíÆ
                    document.getElementById('back-to-timeline-from-comment').addEventListener('click', () => {
                        this.hideCustomCommentPage();
                    });

                    // ÂèëÂ∏ÉËá™ÂÆö‰πâËØÑËÆ∫ÊåâÈíÆ
                    document.getElementById('create-custom-comment').addEventListener('click', async () => {
                        await this.handleCreateCustomComment();
                    });

                    // ÂèñÊ∂àËá™ÂÆö‰πâËØÑËÆ∫ÊåâÈíÆ
                    document.getElementById('cancel-custom-comment').addEventListener('click', () => {
                        this.hideCustomCommentPage();
                    });

                    // ÊµãËØïËÆ§ËØÅÊåâÈíÆ
                    document.getElementById('testAuth').addEventListener('click', async () => {
                        await this.handleTestAuth();
                    });

                    // Ê∏ÖÁ©∫ËÆ§ËØÅÊó•ÂøóÊåâÈíÆ
                    document.getElementById('clearAuthLog').addEventListener('click', () => {
                        const authLog = document.getElementById('auth-log');
                        if (authLog) {
                            authLog.innerHTML = '<div style="color: #6c757d;">ËÆ§ËØÅ‰∫ã‰ª∂Â∞ÜÂú®Ê≠§Â§ÑÊòæÁ§∫...</div>';
                        }
                    });
                }

                switchTab(tabType) {
                    const tabs = document.querySelectorAll('.tab');
                    tabs.forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.dataset.tab === tabType) {
                            tab.classList.add('active');
                        }
                    });

                    const contents = document.querySelectorAll('.tab-content');
                    contents.forEach(content => {
                        content.classList.remove('active');
                    });

                    const activeContent = document.getElementById(tabType + '-tab');
                    if (activeContent) {
                        activeContent.classList.add('active');
                    }

                    // Â¶ÇÊûúÂàáÊç¢Âà∞Êî∂ËóètabÔºåÂä†ËΩΩÊî∂ËóèÊñáÁ´†
                    if (tabType === 'favorites') {
                        this.loadFavoritesArticles();
                    }

                    // Â¶ÇÊûúÂàáÊç¢Âà∞ÂÖ≥Ê≥®tabÔºåÂä†ËΩΩÂÖ≥Ê≥®ÂàóË°®
                    if (tabType === 'following') {
                        this.loadFollowingList();
                    }

                    // Â¶ÇÊûúÂàáÊç¢Âà∞ÈùûÊó∂Èó¥Á∫øtabÔºåÁ°Æ‰øùÊñáÁ´†Êü•ÁúãÂô®Ë¢´ÈöêËóè
                    if (tabType !== 'timeline') {
                        const viewer = document.getElementById('article-viewer');
                        if (viewer && viewer.style.display === 'block') {
                            viewer.style.display = 'none';
                        }

                        // ÈöêËóèÊó∂Èó¥Á∫øtabÔºåÈÅøÂÖçÊòæÁ§∫Êó∂Èó¥Á∫øÁ±ªÂûãÈÄâÊã©Âô®
                        const timelineTab = document.getElementById('timeline-tab');
                        if (timelineTab) {
                            timelineTab.style.display = 'none';
                        }

                        // Ê∏ÖÁ©∫Êó∂Èó¥Á∫øÂÜÖÂÆπÔºåÈÅøÂÖçÂú®ÂÖ∂‰ªñtab‰∏≠ÊòæÁ§∫
                        const timelineContent = document.getElementById('timeline-content');
                        if (timelineContent) {
                            timelineContent.innerHTML = '';
                        }
                    } else {
                        // Â¶ÇÊûúÂàáÊç¢Âà∞Êó∂Èó¥Á∫øtabÔºåÊòæÁ§∫Êó∂Èó¥Á∫øtabÂπ∂ÈáçÊñ∞ÊòæÁ§∫Êó∂Èó¥Á∫øÂÜÖÂÆπ
                        const timelineTab = document.getElementById('timeline-tab');
                        if (timelineTab) {
                            timelineTab.style.display = 'block';
                        }

                        // ÈáçÊñ∞ÊòæÁ§∫Êó∂Èó¥Á∫øÂÜÖÂÆπ
                        if (this.articles && this.articles.length > 0) {
                            this.updateTimeline();
                        } else {
                            // Â¶ÇÊûúÊ≤°ÊúâÊñáÁ´†Êï∞ÊçÆÔºåÊòæÁ§∫ÈªòËÆ§ÊèêÁ§∫
                            const timelineContent = document.getElementById('timeline-content');
                            if (timelineContent) {
                                timelineContent.innerHTML = `
                                    <div class="status info">
                                        <strong>Êó∂Èó¥Á∫ø</strong><br>
                                        ÁÇπÂáª"Âà∑Êñ∞Êó∂Èó¥Á∫ø"ÊåâÈíÆËé∑ÂèñÊúÄÊñ∞ÊñáÁ´†
                                    </div>
                                `;
                            }
                        }
                    }
                }

                showSection(sectionName) {
                    const sections = ['auth-section', 'main-section'];
                    sections.forEach(section => {
                        const element = document.getElementById(section);
                        if (element) {
                            element.style.display = 'none';
                        }
                    });

                    const activeSection = document.getElementById(sectionName + '-section');
                    if (activeSection) {
                        activeSection.style.display = 'block';
                    }

                    this.currentSection = sectionName;
                }

                showUserInfo(user) {
                    document.getElementById('user-name').textContent = user.name || 'Êú™ËÆæÁΩÆ';
                    document.getElementById('user-pubkey').textContent = user.npub;
                    document.getElementById('user-about').textContent = user.about || 'Êú™ËÆæÁΩÆ';

                    // Êõ¥Êñ∞ÂØÜÈí•ÊòæÁ§∫
                    this.updateKeyDisplay();
                }

                async handleCreateAccount() {
                    try {
                        this.showStatus('ÂàõÂª∫Ë¥¶Âè∑‰∏≠...', 'info');

                        const name = document.getElementById('userName').value;
                        const about = document.getElementById('userAbout').value;

                        const user = await this.client.createAccount(name, about);

                        localStorage.setItem('nostr-user', JSON.stringify(user));

                        this.showStatus('Ë¥¶Âè∑ÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
                        this.showUserInfo(user);
                        this.showSection('main');

                    } catch (error) {
                        this.showStatus('ÂàõÂª∫Ë¥¶Âè∑Â§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleImportAccount() {
                    try {
                        this.showStatus('ÂØºÂÖ•Ë¥¶Âè∑‰∏≠...', 'info');

                        const nsec = document.getElementById('nsecInput').value;
                        const user = await this.client.importAccount(nsec);

                        localStorage.setItem('nostr-user', JSON.stringify(user));

                        this.showStatus('Ë¥¶Âè∑ÂØºÂÖ•ÊàêÂäüÔºÅ', 'success');
                        this.showUserInfo(user);
                        this.showSection('main');

                    } catch (error) {
                        this.showStatus('ÂØºÂÖ•Ë¥¶Âè∑Â§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handlePublishArticle() {
                    try {
                        this.showStatus('ÂèëÂ∏ÉÊñáÁ´†‰∏≠...', 'info');

                        const title = document.getElementById('articleTitle').value;
                        const content = document.getElementById('articleContent').value;
                        const dTag = document.getElementById('articleDTag').value;

                        if (!title || !content) {
                            this.showStatus('ËØ∑Â°´ÂÜôÊñáÁ´†Ê†áÈ¢òÂíåÂÜÖÂÆπ', 'error');
                            return;
                        }

                        const result = await this.client.publishArticle(title, content, '', dTag);

                        if (result.success) {
                            this.showStatus(`ÊñáÁ´†ÂèëÂ∏ÉÊàêÂäüÔºÅÂ∑≤ÂèëÈÄÅÂà∞ ${result.relayCount}/${this.client.relays.length} ‰∏™‰∏≠Áªß`, 'success');
                        } else {
                            this.showStatus(`ÊñáÁ´†ÂèëÂ∏ÉÂ§±Ë¥•: ${result.error}`, 'error');
                        }

                        // Ê∏ÖÁ©∫Ë°®Âçï
                        document.getElementById('articleTitle').value = '';
                        document.getElementById('articleContent').value = '';
                        document.getElementById('articleDTag').value = '';

                        // Ê∑ªÂä†Âà∞Êú¨Âú∞ÂàóË°®
                        this.articles.unshift(result.event);
                        await this.updateTimeline();

                    } catch (error) {
                        this.showStatus('ÂèëÂ∏ÉÊñáÁ´†Â§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleRefreshTimeline() {
                    try {
                        const timelineType = document.getElementById('timelineType').value;
                        this.showStatus(`Ê≠£Âú®Ëé∑Âèñ${this.getTimelineTypeName(timelineType)}...`, 'info');

                        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                        const timelineContent = document.getElementById('timeline-content');
                        timelineContent.innerHTML = `
                            <div class="loading">
                                <div>Ê≠£Âú®‰ªéÂ§ö‰∏™‰∏≠ÁªßËé∑ÂèñÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...</div>
                                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                                    Êó∂Èó¥Á∫øÁ±ªÂûã: ${this.getTimelineTypeName(timelineType)}<br>
                                    ÂΩìÂâçËøûÊé•ÁöÑ‰∏≠Áªß: ${this.client.relays.join(', ')}
                                </div>
                            </div>
                        `;

                        let timeline;
                        switch (timelineType) {
                            case 'global':
                                timeline = await this.client.getTimeline(50, 'global');
                                break;
                            case 'followed':
                                timeline = await this.client.getFollowedTimeline(50);
                                break;
                            case 'user':
                                if (!this.client.publicKey) {
                                    throw new Error('ËØ∑ÂÖàÁôªÂΩï');
                                }
                                timeline = await this.client.getUserTimeline(this.client.publicKey, 50);
                                break;
                            default:
                                timeline = await this.client.getTimeline(50, 'global');
                        }

                        this.articles = timeline;
                        await this.updateTimeline();

                        if (timeline.length === 0) {
                            this.showStatus(`Êú™ÊâæÂà∞‰ªª‰ΩïÊñáÁ´†`, 'info');
                            timelineContent.innerHTML = `
                                <div class="status info">
                                    <strong>Êú™ÊâæÂà∞ÊñáÁ´†</strong><br>
                                    Êó∂Èó¥Á∫øÁ±ªÂûã: ${this.getTimelineTypeName(timelineType)}<br>
                                    ÂèØËÉΩÁöÑÂéüÂõ†Ôºö<br>
                                    ‚Ä¢ ÂΩìÂâç‰∏≠Áªß‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥ÂÜÖÂÆπ<br>
                                    ‚Ä¢ ÈúÄË¶ÅÊ∑ªÂä†Êõ¥Â§ö‰∏≠Áªß<br>
                                    ‚Ä¢ ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò<br>
                                    <br>
                                    <button onclick="app.handleRefreshTimeline()" style="background: #667eea; margin-top: 10px;">
                                        ÈáçËØïËé∑Âèñ
                                    </button>
                                </div>
                            `;
                        } else {
                            this.showStatus(`${this.getTimelineTypeName(timelineType)}Â∑≤Êõ¥Êñ∞ÔºÅËé∑ÂèñÂà∞ ${timeline.length} ÁØáÊñáÁ´†`, 'success');
                        }
                    } catch (error) {
                        console.error('Âà∑Êñ∞Êó∂Èó¥Á∫øÂ§±Ë¥•:', error);
                        this.showStatus('Âà∑Êñ∞Êó∂Èó¥Á∫øÂ§±Ë¥•: ' + error.message, 'error');

                        // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
                        const timelineContent = document.getElementById('timeline-content');
                        timelineContent.innerHTML = `
                            <div class="status error">
                                <strong>Ëé∑ÂèñÊó∂Èó¥Á∫øÂ§±Ë¥•</strong><br>
                                ÈîôËØØ‰ø°ÊÅØ: ${error.message}<br>
                                ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï<br>
                                <br>
                                <button onclick="app.handleRefreshTimeline()" style="background: #667eea; margin-top: 10px;">
                                    ÈáçËØïËé∑Âèñ
                                </button>
                            </div>
                        `;
                    }
                }

                getTimelineTypeName(type) {
                    switch (type) {
                        case 'global': return 'ÂÖ®Â±ÄÊó∂Èó¥Á∫ø';
                        case 'followed': return 'ÂÖ≥Ê≥®Áî®Êà∑Êó∂Èó¥Á∫ø';
                        case 'user': return 'ÊàëÁöÑÊñáÁ´†';
                        default: return 'Êó∂Èó¥Á∫ø';
                    }
                }

                async handleAddRelay() {
                    try {
                        const relayUrl = document.getElementById('relayUrl').value;

                        if (!relayUrl) {
                            this.showStatus('ËØ∑ËæìÂÖ•‰∏≠ÁªßÂú∞ÂùÄ', 'error');
                            return;
                        }

                        this.showStatus('ËøûÊé•‰∏≠Áªß‰∏≠...', 'info');

                        await this.client.addRelay(relayUrl);

                        this.showStatus('‰∏≠ÁªßËøûÊé•ÊàêÂäüÔºÅ', 'success');
                        this.updateRelayList();
                        this.updateQuickAddRelays(); // Êõ¥Êñ∞Âø´ÈÄüÊ∑ªÂä†ÂàóË°®

                        document.getElementById('relayUrl').value = '';

                    } catch (error) {
                        this.showStatus('ËøûÊé•‰∏≠ÁªßÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleQuickAddRelay(relayUrl) {
                    try {
                        this.showStatus(`Ê≠£Âú®Ê∑ªÂä†‰∏≠Áªß: ${relayUrl}`, 'info');

                        await this.client.addRelay(relayUrl);

                        this.showStatus('‰∏≠ÁªßÊ∑ªÂä†ÊàêÂäüÔºÅ', 'success');
                        this.updateRelayList();
                        this.updateQuickAddRelays(); // Êõ¥Êñ∞Âø´ÈÄüÊ∑ªÂä†ÂàóË°®

                    } catch (error) {
                        this.showStatus('Ê∑ªÂä†‰∏≠ÁªßÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleRemoveRelay(relayUrl) {
                    try {
                        if (confirm(`Á°ÆÂÆöË¶ÅÁßªÈô§‰∏≠Áªß ${relayUrl} ÂêóÔºü`)) {
                            const success = this.client.removeRelay(relayUrl);

                            if (success) {
                                this.showStatus('‰∏≠ÁªßÁßªÈô§ÊàêÂäüÔºÅ', 'success');
                                this.updateRelayList();
                                this.updateQuickAddRelays(); // Êõ¥Êñ∞Âø´ÈÄüÊ∑ªÂä†ÂàóË°®
                            } else {
                                this.showStatus('ÁßªÈô§‰∏≠ÁªßÂ§±Ë¥•', 'error');
                            }
                        }
                    } catch (error) {
                        this.showStatus('ÁßªÈô§‰∏≠ÁªßÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleDebugRelays() {
                    try {
                        this.showStatus('Ê≠£Âú®ÊµãËØïÊâÄÊúâ‰∏≠ÁªßËøûÊé•...', 'info');

                        const timelineContent = document.getElementById('timeline-content');
                        timelineContent.innerHTML = '<div class="loading">Ê≠£Âú®ÊµãËØï‰∏≠ÁªßËøûÊé•...</div>';

                        const results = [];

                        for (const relay of this.client.relays) {
                            try {
                                console.log(`ÊµãËØï‰∏≠Áªß: ${relay}`);

                                // ÊµãËØïËøûÊé•
                                await this.client.testRelayConnection(relay);

                                // Â∞ùËØïÊü•ËØ¢Êï∞ÊçÆ
                                const events = await this.client.pool.querySync([relay], [
                                    {
                                        kinds: [this.client.eventKinds.LONG_FORM],
                                        limit: 5
                                    }
                                ], {
                                    timeout: 5000
                                });

                                results.push({
                                    relay,
                                    status: 'success',
                                    events: events.length,
                                    message: `‚úÖ ËøûÊé•ÊàêÂäüÔºåÊâæÂà∞ ${events.length} ‰∏™‰∫ã‰ª∂`
                                });

                            } catch (error) {
                                results.push({
                                    relay,
                                    status: 'error',
                                    events: 0,
                                    message: `‚ùå ËøûÊé•Â§±Ë¥•: ${error.message}`
                                });
                            }
                        }

                        // ÊòæÁ§∫ÁªìÊûú
                        let html = '<div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">';
                        html += '<h3>‰∏≠ÁªßËøûÊé•ÊµãËØïÁªìÊûú</h3>';

                        results.forEach(result => {
                            const color = result.status === 'success' ? '#28a745' : '#dc3545';
                            html += `
                                <div style="margin: 10px 0; padding: 10px; border-left: 4px solid ${color}; background: white;">
                                    <strong>${result.relay}</strong><br>
                                    <span style="color: ${color};">${result.message}</span>
                                </div>
                            `;
                        });

                        html += '</div>';
                        timelineContent.innerHTML = html;

                        const successCount = results.filter(r => r.status === 'success').length;
                        this.showStatus(`ÊµãËØïÂÆåÊàê: ${successCount}/${this.client.relays.length} ‰∏™‰∏≠ÁªßËøûÊé•ÊàêÂäü`, 'success');

                    } catch (error) {
                        console.error('Ë∞ÉËØï‰∏≠ÁªßÂ§±Ë¥•:', error);
                        this.showStatus('Ë∞ÉËØï‰∏≠ÁªßÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleLikeArticle(button) {
                    try {
                        const articleId = button.dataset.articleId;
                        const authorPubkey = button.dataset.authorPubkey;

                        await this.client.likeArticle(articleId, authorPubkey);

                        // ‰øùÂ≠òÁÇπËµûÁä∂ÊÄÅÂà∞ localStorage
                        const likedArticles = JSON.parse(localStorage.getItem('liked-articles') || '[]');
                        if (!likedArticles.includes(articleId)) {
                            likedArticles.push(articleId);
                            localStorage.setItem('liked-articles', JSON.stringify(likedArticles));
                        }

                        button.classList.add('active');
                        button.textContent = 'Â∑≤ÁÇπËµû';

                        this.showStatus('ÁÇπËµûÊàêÂäüÔºÅ', 'success');

                    } catch (error) {
                        this.showStatus('ÁÇπËµûÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleBookmarkArticle(button) {
                    try {
                        const articleId = button.dataset.articleId;
                        const title = button.dataset.title;
                        const authorPubkey = button.dataset.authorPubkey;
                        const dTag = button.dataset.dTag;
                        const isCurrentlyBookmarked = button.classList.contains('active');

                        console.log('üîç Êî∂ËóèÊìç‰Ωú:', {
                            articleId: articleId.substring(0, 16) + '...',
                            title: title,
                            authorPubkey: authorPubkey.substring(0, 16) + '...',
                            dTag: dTag,
                            isCurrentlyBookmarked: isCurrentlyBookmarked
                        });

                        if (isCurrentlyBookmarked) {
                            // ÂèñÊ∂àÊî∂Ëóè
                            console.log('üì§ ÂºÄÂßãÂèñÊ∂àÊî∂Ëóè...');

                            const result = await this.client.unbookmarkArticle(articleId, authorPubkey, dTag);

                            console.log('üì§ ÂèñÊ∂àÊî∂ËóèÁªìÊûú:', result);

                            if (result && result.success) {
                                button.classList.remove('active');
                                button.textContent = 'üìö Êî∂Ëóè';
                                this.showStatus('Â∑≤ÂèñÊ∂àÊî∂ËóèÔºÅ', 'success');

                                // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò
                                const cachedBookmarks = localStorage.getItem('bookmarked-articles');
                                if (cachedBookmarks) {
                                    try {
                                        const bookmarkedArticles = JSON.parse(cachedBookmarks);
                                        const index = bookmarkedArticles.indexOf(articleId);
                                        if (index > -1) {
                                            bookmarkedArticles.splice(index, 1);
                                            localStorage.setItem('bookmarked-articles', JSON.stringify(bookmarkedArticles));
                                        }
                                    } catch (e) {
                                        console.warn('Êõ¥Êñ∞Êî∂ËóèÁºìÂ≠òÂ§±Ë¥•:', e);
                                    }
                                }
                            } else {
                                throw new Error(result?.error || 'ÂèñÊ∂àÊî∂ËóèÂ§±Ë¥•');
                            }
                        } else {
                            // Ê∑ªÂä†Êî∂Ëóè
                            console.log('üì§ ÂºÄÂßãÂèëÂ∏ÉÊî∂Ëóè‰∫ã‰ª∂...');

                            const result = await this.client.bookmarkArticle(articleId, title, authorPubkey, dTag);

                            console.log('üì§ Êî∂Ëóè‰∫ã‰ª∂ÂèëÂ∏ÉÁªìÊûú:', result);

                            if (result && result.success) {
                                button.classList.add('active');
                                button.textContent = 'Â∑≤Êî∂Ëóè';
                                this.showStatus('Êî∂ËóèÊàêÂäüÔºÅ', 'success');

                                // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò
                                const cachedBookmarks = localStorage.getItem('bookmarked-articles');
                                const bookmarkedArticles = cachedBookmarks ? JSON.parse(cachedBookmarks) : [];
                                if (!bookmarkedArticles.includes(articleId)) {
                                    bookmarkedArticles.push(articleId);
                                    localStorage.setItem('bookmarked-articles', JSON.stringify(bookmarkedArticles));
                                }
                            } else if (result && result.reason === 'already_bookmarked') {
                                // Â∑≤ÁªèÊî∂ËóèËøá‰∫ÜÔºåÊõ¥Êñ∞UIÁä∂ÊÄÅ
                                button.classList.add('active');
                                button.textContent = 'Â∑≤Êî∂Ëóè';
                                this.showStatus('ÊñáÁ´†Â∑≤Âú®Êî∂ËóèÂàóË°®‰∏≠ÔºÅ', 'info');

                                // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò
                                const cachedBookmarks = localStorage.getItem('bookmarked-articles');
                                const bookmarkedArticles = cachedBookmarks ? JSON.parse(cachedBookmarks) : [];
                                if (!bookmarkedArticles.includes(articleId)) {
                                    bookmarkedArticles.push(articleId);
                                    localStorage.setItem('bookmarked-articles', JSON.stringify(bookmarkedArticles));
                                }
                            } else {
                                throw new Error(result?.error || 'ÂèëÂ∏ÉÂ§±Ë¥•');
                            }
                        }

                    } catch (error) {
                        console.error('‚ùå Êî∂ËóèÊìç‰ΩúÂ§±Ë¥•:', error);
                        this.showStatus('Êî∂ËóèÊìç‰ΩúÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleFollowAuthor(button) {
                    try {
                        const authorPubkey = button.dataset.authorPubkey;
                        const authorName = button.dataset.authorName;
                        const isCurrentlyFollowed = button.classList.contains('active');

                        console.log('üîç ÂÖ≥Ê≥®Êìç‰Ωú:', {
                            authorPubkey: authorPubkey.substring(0, 16) + '...',
                            authorName: authorName,
                            isCurrentlyFollowed: isCurrentlyFollowed
                        });

                        if (isCurrentlyFollowed) {
                            // ÂèñÊ∂àÂÖ≥Ê≥®
                            console.log('üì§ ÂºÄÂßãÂèñÊ∂àÂÖ≥Ê≥®...');

                            const result = await this.client.unfollowAuthor(authorPubkey);

                            console.log('üì§ ÂèñÊ∂àÂÖ≥Ê≥®ÁªìÊûú:', result);

                            if (result && result.success) {
                                button.classList.remove('active');
                                button.textContent = 'üë• ÂÖ≥Ê≥®';
                                this.showStatus('Â∑≤ÂèñÊ∂àÂÖ≥Ê≥®ÔºÅ', 'success');
                            } else {
                                throw new Error(result?.error || 'ÂèñÊ∂àÂÖ≥Ê≥®Â§±Ë¥•');
                            }
                        } else {
                            // Ê∑ªÂä†ÂÖ≥Ê≥®
                            console.log('üì§ ÂºÄÂßãÂÖ≥Ê≥®‰ΩúËÄÖ...');

                            const result = await this.client.followAuthor(authorPubkey, authorName);

                            console.log('üì§ ÂÖ≥Ê≥®ÁªìÊûú:', result);

                            if (result && result.success) {
                                button.classList.add('active');
                                button.textContent = 'Â∑≤ÂÖ≥Ê≥®';
                                this.showStatus('ÂÖ≥Ê≥®ÊàêÂäüÔºÅ', 'success');
                            } else if (result && result.reason === 'already_followed') {
                                // Â∑≤ÁªèÂÖ≥Ê≥®Ëøá‰∫ÜÔºåÊõ¥Êñ∞UIÁä∂ÊÄÅ
                                button.classList.add('active');
                                button.textContent = 'Â∑≤ÂÖ≥Ê≥®';
                                this.showStatus('Â∑≤Âú®ÂÖ≥Ê≥®ÂàóË°®‰∏≠ÔºÅ', 'info');
                            } else {
                                throw new Error(result?.error || 'ÂÖ≥Ê≥®Â§±Ë¥•');
                            }
                        }

                    } catch (error) {
                        console.error('‚ùå ÂÖ≥Ê≥®Êìç‰ΩúÂ§±Ë¥•:', error);
                        this.showStatus('ÂÖ≥Ê≥®Êìç‰ΩúÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async handleCommentArticle(button) {
                    try {
                        const articleId = button.dataset.articleId;
                        const authorPubkey = button.dataset.authorPubkey;

                        const content = prompt('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ:');
                        if (!content) return;

                        // ÈúÄË¶ÅËé∑ÂèñÂΩìÂâçÊñáÁ´†‰ø°ÊÅØ
                        const currentArticle = this.currentArticle;
                        if (!currentArticle) {
                            this.showStatus('ËØ∑ÂÖàËøõÂÖ•ÊñáÁ´†È°µÈù¢', 'error');
                            return;
                        }
                        const dTag = this.client.getTagValue(currentArticle.tags, 'd') || articleId;
                        await this.client.commentOnArticle(articleId, authorPubkey, currentArticle.pubkey, content, null, currentArticle, dTag);

                        this.showStatus('ËØÑËÆ∫ÂèëÂ∏ÉÊàêÂäüÔºÅ', 'success');

                        // Â¶ÇÊûúÂΩìÂâçÂú®ÊñáÁ´†ÈòÖËØªÈ°µÈù¢ÔºåÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
                        const articleViewer = document.getElementById('article-viewer');
                        if (articleViewer && articleViewer.style.display !== 'none') {
                            // ÈáçÊñ∞Âä†ËΩΩÂΩìÂâçÊñáÁ´†ÁöÑËØÑËÆ∫
                            const currentArticle = this.currentArticle;
                            if (currentArticle && currentArticle.id === articleId) {
                                // ÈáçÁΩÆËØÑËÆ∫Áä∂ÊÄÅÂπ∂ÈáçÊñ∞Âä†ËΩΩ
                                this.commentPage = 0;
                                this.comments = [];
                                this.allCommentsLoaded = false;
                                await this.loadCommentsForArticle(currentArticle);
                            }
                        }

                    } catch (error) {
                        this.showStatus('ÂèëÂ∏ÉËØÑËÆ∫Â§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async updateTimeline() {
                    const timelineContent = document.getElementById('timeline-content');

                    if (this.articles.length === 0) {
                        timelineContent.innerHTML = '<div class="status info">ÊöÇÊó†ÊñáÁ´†ÔºåËØ∑ÂèëÂ∏ÉÊñáÁ´†ÊàñËøûÊé•Âà∞Êõ¥Â§ö‰∏≠Áªß</div>';
                        return;
                    }

                    // ÂÖàÊ∏≤ÊüìÂü∫Êú¨ÂÜÖÂÆπÔºå‰∏çÂåÖÂê´ÁÇπËµûÁä∂ÊÄÅ
                    let html = '';
                    this.articles.forEach(event => {
                        const timeStr = this.client.formatTime(event.created_at);
                        let title = '';
                        let content = event.content;
                        let eventType = '';

                        // Ê†πÊçÆ‰∫ã‰ª∂Á±ªÂûãÂ§ÑÁêÜÊòæÁ§∫
                        switch (event.kind) {
                            case 0: // ÂÖÉÊï∞ÊçÆ
                                eventType = 'üìù Áî®Êà∑ËµÑÊñô';
                                try {
                                    const metadata = JSON.parse(event.content);
                                    title = metadata.name || 'Áî®Êà∑ËµÑÊñô';
                                    content = `ÊòµÁß∞: ${metadata.name || 'Êú™ËÆæÁΩÆ'}\nÁÆÄ‰ªã: ${metadata.about || 'Êú™ËÆæÁΩÆ'}\nÁΩëÁ´ô: ${metadata.website || 'Êú™ËÆæÁΩÆ'}`;
                                } catch (e) {
                                    title = 'Áî®Êà∑ËµÑÊñô';
                                    content = event.content;
                                }
                                break;
                            case 1: // ÊñáÊú¨Á¨îËÆ∞
                                eventType = 'üí¨ Áü≠Ê∂àÊÅØ';
                                title = 'Áü≠Ê∂àÊÅØ';
                                break;
                            case 30023: // ÈïøÊñá
                                eventType = 'üìÑ ÊñáÁ´†';
                                title = this.client.getTagValue(event.tags, 'title') || 'Êó†Ê†áÈ¢ò';
                                break;
                            case 1111: // ËØÑËÆ∫
                                eventType = 'üí≠ ËØÑËÆ∫';
                                title = 'ËØÑËÆ∫';
                                break;
                            default:
                                eventType = `üîß ‰∫ã‰ª∂Á±ªÂûã ${event.kind}`;
                                title = `‰∫ã‰ª∂Á±ªÂûã ${event.kind}`;
                        }

                        html += `
                        <div class="article-item" data-article-id="${event.id}">
                            <div class="article-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="article-title" style="cursor: pointer; color: #667eea; font-weight: 600; flex: 1;" data-article-id="${event.id}">
                                    ${eventType} - ${this.escapeHtml(title)}
                                </div>
                                <button class="view-detail-btn" data-article-id="${event.id}" style="background: #17a2b8; margin-left: 10px;">
                                    üìñ ËØ¶ÊÉÖ
                                </button>
                            </div>
                            <div class="article-content">${this.escapeHtml(content.substring(0, 200))}${content.length > 200 ? '...' : ''}</div>
                            <div class="article-meta">
                                ‰ΩúËÄÖ: ${this.client.truncateKey(event.pubkey)} |
                                ÂèëÂ∏ÉÊó∂Èó¥: ${timeStr} |
                                ‰∫ã‰ª∂Á±ªÂûã: ${event.kind}
                            </div>
                            <div class="article-actions">
                                <button class="like-btn" data-article-id="${event.id}" data-author-pubkey="${event.pubkey}">
                                    üëç ÁÇπËµû
                                </button>
                                <button class="bookmark-btn" data-article-id="${event.id}" data-title="${this.escapeHtml(title)}" data-author-pubkey="${event.pubkey}" data-d-tag="${this.client.getTagValue(event.tags, 'd') || event.id}">
                                    üìö Êî∂Ëóè
                                </button>
                                <button class="follow-btn" data-author-pubkey="${event.pubkey}" data-author-name="${this.client.truncateKey(event.pubkey)}">
                                    üë• ÂÖ≥Ê≥®
                                </button>
                                <button class="comment-btn" data-article-id="${event.id}" data-author-pubkey="${event.pubkey}">
                                    üí¨ ËØÑËÆ∫
                                </button>
                                ${event.pubkey === this.client.publicKey ? `
                                    <button class="edit-btn" data-article-id="${event.id}" data-author-pubkey="${event.pubkey}" data-kind="${event.kind}" style="background: #ffc107; color: #000;">
                                        ‚úèÔ∏è ÁºñËæë
                                    </button>
                                ` : ''}
                                <button class="show-json-btn" data-event-id="${event.id}" style="background: #6c757d; margin-left: 5px;">
                                    üìã JSON
                                </button>
                            </div>
                            <div id="json-modal-${event.id}" class="json-modal" style="display: none;">
                                <div class="json-modal-content">
                                    <div class="json-modal-header">
                                        <h3>‰∫ã‰ª∂ÂÆåÊï¥ JSON</h3>
                                        <button class="close-json-btn" data-event-id="${event.id}">&times;</button>
                                    </div>
                                    <div class="json-modal-body">
                                        <textarea id="json-content-${event.id}" readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px;">${JSON.stringify(event, null, 2)}</textarea>
                                    </div>
                                    <div class="json-modal-footer">
                                        <button class="copy-json-btn" data-event-id="${event.id}" style="background: #28a745;">Â§çÂà∂ JSON</button>
                                        <button class="close-json-btn" data-event-id="${event.id}" style="background: #6c757d;">ÂÖ≥Èó≠</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    });

                    timelineContent.innerHTML = html;

                    // ÂºÇÊ≠•Êõ¥Êñ∞ÁÇπËµûÁä∂ÊÄÅ
                    this.updateLikeStatuses();

                    // ÂºÇÊ≠•Êõ¥Êñ∞Êî∂ËóèÁä∂ÊÄÅ
                    this.updateBookmarkStatuses();

                    // ÂºÇÊ≠•Êõ¥Êñ∞ÂÖ≥Ê≥®Áä∂ÊÄÅ
                    this.updateFollowStatuses();
                }

                // ÂºÇÊ≠•Êõ¥Êñ∞ÊâÄÊúâÊñáÁ´†ÁöÑÁÇπËµûÁä∂ÊÄÅ
                async updateLikeStatuses() {
                    const likeButtons = document.querySelectorAll('.like-btn');

                    for (const button of likeButtons) {
                        const articleId = button.dataset.articleId;
                        try {
                            const isLiked = await this.checkLikeStatus(articleId);
                            if (isLiked) {
                                button.classList.add('active');
                                button.textContent = 'Â∑≤ÁÇπËµû';
                            }
                        } catch (error) {
                            console.warn('Êõ¥Êñ∞ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
                        }
                    }
                }

                // Ê£ÄÊü•ÁÇπËµûÁä∂ÊÄÅ
                async checkLikeStatus(articleId) {
                    // È¶ñÂÖàÊ£ÄÊü• localStorage ‰∏≠ÁöÑÁºìÂ≠òÁä∂ÊÄÅ
                    const likedArticles = JSON.parse(localStorage.getItem('liked-articles') || '[]');
                    const cachedLiked = likedArticles.includes(articleId);

                    // Â¶ÇÊûúÁºìÂ≠ò‰∏≠ÊòæÁ§∫Â∑≤ÁÇπËµûÔºåÁõ¥Êé•ËøîÂõû true
                    if (cachedLiked) {
                        return true;
                    }

                    // Â¶ÇÊûúÁºìÂ≠ò‰∏≠Ê≤°ÊúâÔºåÂàôÊü•ËØ¢ relay ‰∏≠ÁöÑÂÆûÈôÖÁä∂ÊÄÅ
                    try {
                        const actualLiked = await this.client.checkUserLikeStatus(articleId);

                        // Â¶ÇÊûú relay ‰∏≠ÊòæÁ§∫Â∑≤ÁÇπËµûÔºåÊõ¥Êñ∞ÁºìÂ≠ò
                        if (actualLiked) {
                            if (!likedArticles.includes(articleId)) {
                                likedArticles.push(articleId);
                                localStorage.setItem('liked-articles', JSON.stringify(likedArticles));
                            }
                        }

                        return actualLiked;
                    } catch (error) {
                        console.warn('Êü•ËØ¢ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•Ôºå‰ΩøÁî®ÁºìÂ≠òÁä∂ÊÄÅ:', error);
                        return cachedLiked;
                    }
                }

                // ÂºÇÊ≠•Êõ¥Êñ∞ÊâÄÊúâÊñáÁ´†ÁöÑÊî∂ËóèÁä∂ÊÄÅ
                async updateBookmarkStatuses() {
                    const bookmarkButtons = document.querySelectorAll('.bookmark-btn');

                    for (const button of bookmarkButtons) {
                        const articleId = button.dataset.articleId;
                        const authorPubkey = button.dataset.authorPubkey;
                        const dTag = button.dataset.dTag;
                        try {
                            const isBookmarked = await this.checkBookmarkStatus(articleId, authorPubkey, dTag);
                            if (isBookmarked) {
                                button.classList.add('active');
                                button.textContent = 'Â∑≤Êî∂Ëóè';
                            }
                        } catch (error) {
                            console.warn('Êõ¥Êñ∞Êî∂ËóèÁä∂ÊÄÅÂ§±Ë¥•:', error);
                        }
                    }
                }

                // ÂºÇÊ≠•Êõ¥Êñ∞ÊâÄÊúâÊñáÁ´†ÁöÑÂÖ≥Ê≥®Áä∂ÊÄÅ
                async updateFollowStatuses() {
                    const followButtons = document.querySelectorAll('.follow-btn');

                    for (const button of followButtons) {
                        const authorPubkey = button.dataset.authorPubkey;
                        try {
                            const isFollowed = await this.checkFollowStatus(authorPubkey);
                            if (isFollowed) {
                                button.classList.add('active');
                                button.textContent = 'Â∑≤ÂÖ≥Ê≥®';
                            }
                        } catch (error) {
                            console.warn('Êõ¥Êñ∞ÂÖ≥Ê≥®Áä∂ÊÄÅÂ§±Ë¥•:', error);
                        }
                    }
                }

                // Ê£ÄÊü•ÂÖ≥Ê≥®Áä∂ÊÄÅ
                async checkFollowStatus(authorPubkey) {
                    try {
                        // ‰ΩøÁî®ÂÆ¢Êà∑Á´ØÁöÑ getCurrentFollowList ÊñπÊ≥ï
                        const currentFollows = await this.client.getCurrentFollowList();

                        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊåáÂÆö‰ΩúËÄÖ
                        const isFollowed = currentFollows.some(tag => tag[0] === 'p' && tag[1] === authorPubkey);

                        return isFollowed;
                    } catch (error) {
                        console.warn('Êü•ËØ¢ÂÖ≥Ê≥®Áä∂ÊÄÅÂ§±Ë¥•:', error);
                        return false;
                    }
                }

                                // Ê£ÄÊü•Êî∂ËóèÁä∂ÊÄÅ (ÊîØÊåÅ a Ê†áÁ≠æÊ†ºÂºè)
                async checkBookmarkStatus(articleId, authorPubkey, dTag) {
                    // ÊûÑÈÄ†ÊñáÁ´†ÁöÑ a Ê†áÁ≠æ
                    const articleATag = `30023:${authorPubkey}:${dTag}`;

                    // È¶ñÂÖàÊ£ÄÊü•Êú¨Âú∞ÁºìÂ≠ò
                    const cachedBookmarks = localStorage.getItem('bookmarked-articles');
                    if (cachedBookmarks) {
                        try {
                            const bookmarkedArticles = JSON.parse(cachedBookmarks);
                            if (bookmarkedArticles.includes(articleId)) {
                                return true;
                            }
                        } catch (e) {
                            console.warn('Ëß£ÊûêÊî∂ËóèÁºìÂ≠òÂ§±Ë¥•:', e);
                        }
                    }

                    try {
                        // ‰ΩøÁî®ÂÆ¢Êà∑Á´ØÁöÑ getCurrentBookmarks ÊñπÊ≥ï
                        const currentBookmarks = await this.client.getCurrentBookmarks();

                        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊåáÂÆöÊñáÁ´† (‰ºòÂÖàÊ£ÄÊü• a Ê†áÁ≠æÔºåÁÑ∂ÂêéÊ£ÄÊü• e Ê†áÁ≠æ)
                        const isBookmarked = currentBookmarks.some(tag =>
                            (tag[0] === 'a' && tag[1] === articleATag) ||
                            (tag[0] === 'e' && tag[1] === articleId)
                        );

                        // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò
                        if (isBookmarked) {
                            const bookmarkedArticles = cachedBookmarks ? JSON.parse(cachedBookmarks) : [];
                            if (!bookmarkedArticles.includes(articleId)) {
                                bookmarkedArticles.push(articleId);
                                localStorage.setItem('bookmarked-articles', JSON.stringify(bookmarkedArticles));
                            }
                        }

                        return isBookmarked;
                    } catch (error) {
                        console.warn('Êü•ËØ¢Êî∂ËóèÁä∂ÊÄÅÂ§±Ë¥•Ôºå‰ΩøÁî®ÁºìÂ≠òÁä∂ÊÄÅ:', error);
                        // ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•Êó∂Ôºå‰ΩøÁî®ÁºìÂ≠òÁä∂ÊÄÅ
                        if (cachedBookmarks) {
                            try {
                                const bookmarkedArticles = JSON.parse(cachedBookmarks);
                                return bookmarkedArticles.includes(articleId);
                            } catch (e) {
                                console.warn('Ëß£ÊûêÊî∂ËóèÁºìÂ≠òÂ§±Ë¥•:', e);
                            }
                        }
                        return false;
                    }
                }

                updateRelayList() {
                    const relayItems = document.getElementById('relay-items');
                    if (!relayItems) return;

                    console.log('üîç Ë∞ÉËØï‰∏≠ÁªßÁä∂ÊÄÅ:');
                    console.log('- this.client.pool:', this.client.pool);
                    console.log('- this.client.relays:', this.client.relays);
                    console.log('- this.client.pool.relays:', this.client.pool?.relays);

                    let statusMap;
                    if (this.client.pool && typeof this.client.pool.listConnectionStatus === 'function') {
                        console.log('‚úÖ ‰ΩøÁî® listConnectionStatus ÊñπÊ≥ï');
                        statusMap = this.client.pool.listConnectionStatus();
                    } else {
                        console.log('‚ùå listConnectionStatus ÊñπÊ≥ï‰∏çÂèØÁî®');
                        statusMap = new Map();
                    }

                    let html = '';
                    console.log('üîç Ë∞ÉËØï relay ÂåπÈÖç:');
                    console.log('this.client.relays:', this.client.relays);
                    for (const relay of this.client.relays) {
                        // statusMap ÁöÑ key ÈÉΩÊúâÊú´Â∞æÊñúÊù†ÔºåÊâÄ‰ª•Ê†áÂáÜÂåñ‰∏∫Â∏¶ÊñúÊù†ÁöÑÁâàÊú¨
                        const normalizedRelay = relay.endsWith('/') ? relay : relay + '/';
                        let connected = statusMap.get(relay);
                        console.log(`- relay: "${relay}" -> statusMap.get(): ${connected}`);
                        if (connected === undefined) {
                            connected = statusMap.get(normalizedRelay);
                            console.log(`- normalizedRelay: ${normalizedRelay} -> statusMap.get(): ${connected}`);
                        }
                        const statusText = connected ? 'Â∑≤ËøûÊé•' : 'ÂæÖËøûÊé•';
                        const statusColor = connected ? '#28a745' : '#dc3545';
                        
                        // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
                        const isAuthenticated = this.client.isAuthenticated(relay);
                        const authText = isAuthenticated ? 'üîê Â∑≤ËÆ§ËØÅ' : '';
                        const authColor = isAuthenticated ? '#007bff' : '#6c757d';
                        
                        html += `<div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background: ${statusColor};"></span>
                            <span style="flex: 1; font-family: monospace; font-size: 14px;">${relay}</span>
                            <span style="margin-left: 10px; color: ${statusColor}; font-size: 13px;">${statusText}</span>
                            <span style="margin-left: 8px; color: ${authColor}; font-size: 12px;">${authText}</span>
                            <button class="remove-relay-btn" data-relay="${relay}" style="margin-left: 10px;">ÁßªÈô§</button>
                        </div>`;
                    }
                    relayItems.innerHTML = html;
                    // ÁªëÂÆöÁßªÈô§ÊåâÈíÆ‰∫ã‰ª∂
                    relayItems.querySelectorAll('.remove-relay-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const relayUrl = btn.getAttribute('data-relay');
                            this.handleRemoveRelay(relayUrl);
                        };
                    });
                }

                updateQuickAddRelays() {
                    const quickAddContainer = document.getElementById('quick-add-relays');
                    const recommendedRelays = this.client.getRecommendedRelays();

                    if (recommendedRelays.length === 0) {
                        quickAddContainer.innerHTML = '<p style="color: #666;">ÊâÄÊúâÊé®Ëçê‰∏≠ÁªßÂ∑≤Ê∑ªÂä†</p>';
                        return;
                    }

                    let html = '';
                    recommendedRelays.forEach(relay => {
                        html += `
                            <button class="quick-add-relay-btn" data-relay="${relay.url}" style="background: #17a2b8; margin: 5px; padding: 8px 12px; font-size: 14px;">
                                Ê∑ªÂä† ${relay.name}
                            </button>
                        `;
                    });

                    quickAddContainer.innerHTML = html;

                    // ÁªëÂÆöÂø´ÈÄüÊ∑ªÂä†ÊåâÈíÆ‰∫ã‰ª∂
                    document.querySelectorAll('.quick-add-relay-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const relayUrl = e.target.dataset.relay;
                            await this.handleQuickAddRelay(relayUrl);
                        });
                    });
                }

                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                showStatus(message, type) {
                    const statusDiv = document.getElementById('status-message');
                    statusDiv.className = `status ${type}`;
                    statusDiv.textContent = message;
                    statusDiv.style.display = 'block';

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }

                // ÊòæÁ§∫‰∫ã‰ª∂ JSON
                showEventJson(eventId) {
                    const modal = document.getElementById(`json-modal-${eventId}`);
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                }

                // ÈöêËóè‰∫ã‰ª∂ JSON
                hideEventJson(eventId) {
                    const modal = document.getElementById(`json-modal-${eventId}`);
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }

                // Â§çÂà∂ JSON ÂÜÖÂÆπ
                copyEventJson(eventId) {
                    const textarea = document.getElementById(`json-content-${eventId}`);
                    if (textarea) {
                        textarea.select();
                        textarea.setSelectionRange(0, 99999); // ÂÖºÂÆπÁßªÂä®Á´Ø

                        try {
                            document.execCommand('copy');
                            this.showStatus('JSON Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                        } catch (err) {
                            this.showStatus('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
                        }
                    }
                }

                // ÂàáÊç¢ÂºÄÂèëËÄÖÊ®°Âºè
                toggleDevMode() {
                    const app = document.getElementById('app');
                    const isDevMode = app.classList.contains('dev-mode');

                    if (isDevMode) {
                        app.classList.remove('dev-mode');
                        this.showStatus('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠', 'info');
                    } else {
                        app.classList.add('dev-mode');
                        this.showStatus('ÂºÄÂèëËÄÖÊ®°ÂºèÂ∑≤ÂºÄÂêØ', 'success');
                    }
                }

                // ÂØÜÈí•ÁÆ°ÁêÜÁõ∏ÂÖ≥ÊñπÊ≥ï
                switchKeyFormat(format) {
                    const formatBtns = document.querySelectorAll('.format-btn');
                    formatBtns.forEach(btn => btn.classList.remove('active'));

                    const activeBtn = document.querySelector(`[data-format="${format}"]`);
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                    }

                    const publicKeyDisplay = document.getElementById('public-key-display');
                    if (!this.client.publicKey) return;

                    if (format === 'npub') {
                        const npub = nip19.npubEncode(this.client.publicKey);
                        publicKeyDisplay.value = npub;
                    } else {
                        publicKeyDisplay.value = this.client.publicKey;
                    }
                }

                copyToClipboard(elementId, buttonId) {
                    const element = document.getElementById(elementId);
                    const button = document.getElementById(buttonId);

                    if (!element || !element.value) {
                        this.showStatus('Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ', 'error');
                        return;
                    }

                    // ÂàõÂª∫‰∏¥Êó∂ËæìÂÖ•Ê°ÜÊù•Â§çÂà∂ÊñáÊú¨
                    const tempInput = document.createElement('input');
                    tempInput.value = element.value;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    tempInput.setSelectionRange(0, 99999); // ÂÖºÂÆπÁßªÂä®Á´Ø

                    try {
                        document.execCommand('copy');
                        this.showStatus('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');

                        // ÊåâÈíÆÂèçÈ¶àÊïàÊûú
                        const originalText = button.textContent;
                        button.textContent = '‚úÖ Â∑≤Â§çÂà∂';
                        button.classList.add('copy-success');

                        setTimeout(() => {
                            button.textContent = originalText;
                            button.classList.remove('copy-success');
                        }, 2000);

                    } catch (err) {
                        this.showStatus('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
                    } finally {
                        document.body.removeChild(tempInput);
                    }
                }

                togglePrivateKeyVisibility() {
                    const privateKeyInput = document.getElementById('private-key-display');
                    const toggleBtn = document.getElementById('toggle-private-key');

                    if (privateKeyInput.type === 'password') {
                        privateKeyInput.type = 'text';
                        toggleBtn.textContent = 'üôà ÈöêËóè';
                        toggleBtn.style.background = '#dc3545';
                    } else {
                        privateKeyInput.type = 'password';
                        toggleBtn.textContent = 'üëÅÔ∏è ÊòæÁ§∫';
                        toggleBtn.style.background = '#6c757d';
                    }
                }

                updateKeyDisplay() {
                    if (!this.client.publicKey) return;

                    const publicKeyDisplay = document.getElementById('public-key-display');
                    const privateKeyDisplay = document.getElementById('private-key-display');

                    // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÊ†ºÂºè
                    const activeFormatBtn = document.querySelector('.format-btn.active');
                    const format = activeFormatBtn ? activeFormatBtn.dataset.format : 'npub';

                    // ÊòæÁ§∫ÂÖ¨Èí•
                    if (format === 'npub') {
                        const npub = nip19.npubEncode(this.client.publicKey);
                        publicKeyDisplay.value = npub;
                    } else {
                        publicKeyDisplay.value = this.client.publicKey;
                    }

                    // ÊòæÁ§∫ÁßÅÈí• (nsec Ê†ºÂºè)
                    const savedUser = localStorage.getItem('nostr-user');
                    if (savedUser) {
                        const user = JSON.parse(savedUser);
                        if (user.nsec) {
                            privateKeyDisplay.value = user.nsec;
                        }
                    }
                }

                // Ëé∑ÂèñÊüêÁØáÊñáÁ´†ÁöÑËØÑËÆ∫ÔºåÂàÜÈ°µ
                async getCommentsForArticle(article, since = 0, limit = 50) {
                    // ËØÑËÆ∫ kind ÈÄöÂ∏∏‰∏∫ 1111Ôºåtag A = 30023:pubkey:dTag
                    // ‰ªéÊñáÁ´†Ê†áÁ≠æ‰∏≠Ëé∑Âèñ d tag
                    const dTag = this.client.getTagValue(article.tags, 'd') || article.id;
                    const aTag = `30023:${article.pubkey}:${dTag}`;

                    console.log('üîç Ë∞ÉËØïÊñáÁ´†‰ø°ÊÅØ:', {
                        articleId: article.id,
                        pubkey: article.pubkey,
                        dTag: dTag,
                        aTag: aTag
                    });

                    // ‰ΩøÁî®Áã¨Á´ãÁöÑ SimplePool ÈÅøÂÖçÁä∂ÊÄÅÂÜ≤Á™Å
                    const commentPool = new SimplePool();

                    try {
                        // È¶ñÂÖàÊü•ËØ¢Êúâ A Ê†áÁ≠æÁöÑËØÑËÆ∫ÔºàÊ†πËØÑËÆ∫Ôºâ
                        const aTagFilter = {
                            kinds: [this.client.eventKinds.COMMENT],
                            '#A': [aTag],
                            since: since,
                            limit: limit
                        };

                        console.log('üîç Êü•ËØ¢ A Ê†áÁ≠æËØÑËÆ∫ËøáÊª§Âô®:', aTagFilter);

                        let aTagComments = [];
                        try {
                            aTagComments = await commentPool.querySync(this.client.relays, aTagFilter, { maxWait: 10000 });
                        } catch (e) {
                            console.warn('Êü•ËØ¢ A Ê†áÁ≠æËØÑËÆ∫Â§±Ë¥•:', e);
                        }

                        console.log('üîç A Ê†áÁ≠æËØÑËÆ∫ÁªìÊûú:', aTagComments);

                        // ÁÑ∂ÂêéÊü•ËØ¢ÊåáÂêëËøô‰∫õËØÑËÆ∫ÁöÑÂõûÂ§ç
                        let replyComments = [];
                        if (aTagComments.length > 0) {
                            const replyFilter = {
                                kinds: [this.client.eventKinds.COMMENT],
                                '#e': aTagComments.map(c => c.id),
                                since: since,
                                limit: limit * 2
                            };

                            console.log('üîç Êü•ËØ¢ÂõûÂ§çËØÑËÆ∫ËøáÊª§Âô®:', replyFilter);

                            try {
                                replyComments = await commentPool.querySync(this.client.relays, replyFilter, { maxWait: 10000 });
                            } catch (e) {
                                console.warn('Êü•ËØ¢ÂõûÂ§çËØÑËÆ∫Â§±Ë¥•:', e);
                            }

                            console.log('üîç ÂõûÂ§çËØÑËÆ∫ÁªìÊûú:', replyComments);
                        }

                        // ÂêàÂπ∂ÊâÄÊúâËØÑËÆ∫
                        const allComments = [...aTagComments, ...replyComments];
                        console.log('üîç ÂêàÂπ∂ÂêéÁöÑÊâÄÊúâËØÑËÆ∫:', allComments);

                        // ÂéªÈáç
                        const unique = Array.from(new Map(allComments.map(e => [e.id, e])).values());
                        // ÊåâÊó∂Èó¥ÂçáÂ∫è
                        unique.sort((a, b) => a.created_at - b.created_at);
                        return unique;

                    } finally {
                        commentPool.close(this.client.relays);
                    }
                }

                async showArticleViewer(articleId) {
                    // Ëé∑ÂèñÊñáÁ´†ÂØπË±°
                    const article = this.articles.find(a => a.id === articleId);
                    if (!article) return;

                    // ‰øùÂ≠òÂΩìÂâçÊñáÁ´†‰ø°ÊÅØ
                    this.currentArticle = article;

                    // ÊûÑÂª∫ÊñáÁ´†ËØ¶ÊÉÖHTML
                    const title = this.client.getTagValue(article.tags, 'title') || 'Êó†Ê†áÈ¢ò';
                    const publishedAt = this.client.getTagValue(article.tags, 'published_at');
                    const timeStr = publishedAt ? this.client.formatTime(parseInt(publishedAt)) : this.client.formatTime(article.created_at);
                    const content = article.content;
                    const author = this.client.truncateKey(article.pubkey);

                    // ËØÑËÆ∫ÂàÜÈ°µÂèÇÊï∞
                    this.commentPage = 0;
                    this.pageSize = 50;
                    this.allCommentsLoaded = false;
                    this.comments = [];

                    // Êü•ÊâæÂõûÂ§çËØÑËÆ∫ÁöÑÊ†πËØÑËÆ∫
                    function findRootComment(reply, commentMap, allComments) {
                        const parentId = reply.parentId;
                        if (!parentId) return null;

                        const parent = commentMap.get(parentId);
                        if (!parent) return null;

                        // Â¶ÇÊûúÁà∂ËØÑËÆ∫‰∏çÊòØÂõûÂ§çÔºàÂç≥ÊòØÊ†πËØÑËÆ∫ÔºâÔºåÂàôËøîÂõûÂÆÉ
                        if (!parent.isReply) {
                            return parent;
                        }

                        // Â¶ÇÊûúÁà∂ËØÑËÆ∫‰πüÊòØÂõûÂ§çÔºåÁªßÁª≠Âêë‰∏äÊü•Êâæ
                        return findRootComment(parent, commentMap, allComments);
                    }

                    // ËØÑËÆ∫Âå∫ÂÆπÂô®
                    const renderComments = async () => {
                        const commentList = document.getElementById('comment-list');

                        // ÊûÑÂª∫‰∏§Â±ÇÂ±ïÂπ≥ËØÑËÆ∫ÁªìÊûÑ
                        const commentMap = new Map();
                        comments.forEach(c => commentMap.set(c.id, { ...c, children: [] }));

                        const rootComments = [];
                        const allReplies = [];

                        // ÂàÜÁ±ªËØÑËÆ∫ÔºöÊ†πËØÑËÆ∫ vs ÂõûÂ§çËØÑËÆ∫
                        comments.forEach(c => {
                            const parentId = (c.tags.find(t => t[0] === 'e') || [])[1];
                            if (parentId && commentMap.has(parentId)) {
                                const currentComment = commentMap.get(c.id);
                                currentComment.isReply = true;
                                currentComment.parentId = parentId;

                                // ËÆæÁΩÆÂõûÂ§çÁõÆÊ†á‰ø°ÊÅØ
                                const parentComment = commentMap.get(parentId);
                                if (parentComment) {
                                    currentComment.replyToAuthor = parentComment.pubkey;
                                    currentComment.replyToContent = parentComment.content.substring(0, 50) + '...';
                                }

                                allReplies.push(currentComment);
                            } else {
                                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂØπÊñáÁ´†ÁöÑÁõ¥Êé•ËØÑËÆ∫ÔºàÂåÖÂê´ A Ê†áÁ≠æÔºâ
                                const hasArticleTag = c.tags.some(tag => tag[0] === 'A');
                                if (hasArticleTag) {
                                    rootComments.push(commentMap.get(c.id));
                                }
                            }
                        });

                        // Â∞ÜÊâÄÊúâÂõûÂ§çÊåâÊó∂Èó¥ÊéíÂ∫èÂêéÊ∑ªÂä†Âà∞ÂØπÂ∫îÁöÑÊ†πËØÑËÆ∫‰∏ã
                        allReplies.sort((a, b) => a.created_at - b.created_at);

                        // ÊâæÂà∞ÊØè‰∏™ÂõûÂ§çÂ∫îËØ•ÂΩíÂ±ûÁöÑÊ†πËØÑËÆ∫
                        allReplies.forEach(reply => {
                            const rootComment = findRootComment(reply, commentMap, comments);
                            if (rootComment) {
                                rootComment.children.push(reply);
                            }
                        });

                        // Ê∏≤Êüì‰∏§Â±ÇÂ±ïÂπ≥ÁªìÊûÑ
                        function renderFlatComments(list) {
                            return list.map(c => {
                                const authorName = app.client.truncateKey(c.pubkey);
                                const timeStr = app.client.formatTime(c.created_at);

                                let html = `
                                    <div class="comment-item" data-comment-id="${c.id}">
                                        <div class="comment-author">${authorName}</div>
                                        <div class="comment-content">${app.escapeHtml(c.content)}</div>
                                        <div class="comment-time">${timeStr}</div>
                                        <div class="comment-actions">
                                            <button class="reply-btn" data-comment-id="${c.id}" data-parent-pubkey="${c.pubkey}">ÂõûÂ§ç</button>
                                            <button class="show-json-btn" data-event-id="${c.id}" style="background: #6c757d; margin-left: 5px; font-size: 12px; padding: 4px 8px;">üìã JSON</button>
                                        </div>
                                        <div class="reply-box" id="reply-box-${c.id}" style="display:none;">
                                            <textarea id="reply-input-${c.id}" rows="2" style="width:100%;margin-top:6px;"></textarea>
                                            <button class="send-reply-btn" data-parent-id="${c.id}" data-parent-pubkey="${c.pubkey}" style="margin-top:4px;">ÂèëÈÄÅ</button>
                                        </div>
                                        <div id="json-modal-${c.id}" class="json-modal" style="display: none;">
                                            <div class="json-modal-content">
                                                <div class="json-modal-header">
                                                    <h3>ËØÑËÆ∫‰∫ã‰ª∂ÂÆåÊï¥ JSON</h3>
                                                    <button class="close-json-btn" data-event-id="${c.id}">&times;</button>
                                                </div>
                                                <div class="json-modal-body">
                                                    <textarea id="json-content-${c.id}" readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px;">${JSON.stringify(c, null, 2)}</textarea>
                                                </div>
                                                <div class="json-modal-footer">
                                                    <button class="copy-json-btn" data-event-id="${c.id}" style="background: #28a745;">Â§çÂà∂ JSON</button>
                                                    <button class="close-json-btn" data-event-id="${c.id}" style="background: #6c757d;">ÂÖ≥Èó≠</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;

                                // Ê∏≤ÊüìÁ¨¨‰∫åÂ±ÇÂõûÂ§çÔºàÊâÄÊúâÂõûÂ§çÈÉΩÂ±ïÂπ≥ÊòæÁ§∫Ôºâ
                                if (c.children && c.children.length > 0) {
                                    html += '<div class="replies-section" style="margin-left: 20px; margin-top: 10px;">';
                                    c.children.forEach(reply => {
                                        const replyAuthorName = app.client.truncateKey(reply.pubkey);
                                        const replyTimeStr = app.client.formatTime(reply.created_at);
                                        const replyTarget = reply.replyToAuthor ?
                                            `ÂõûÂ§ç @${app.client.truncateKey(reply.replyToAuthor)}` : '';

                                        html += `
                                            <div class="comment-item child-comment" data-comment-id="${reply.id}">
                                                <div class="comment-author">${replyAuthorName} ${replyTarget}</div>
                                                <div class="comment-content">${app.escapeHtml(reply.content)}</div>
                                                <div class="comment-time">${replyTimeStr}</div>
                                                <div class="comment-actions">
                                                    <button class="reply-btn" data-comment-id="${reply.id}" data-parent-pubkey="${reply.pubkey}">ÂõûÂ§ç</button>
                                                    <button class="show-json-btn" data-event-id="${reply.id}" style="background: #6c757d; margin-left: 5px; font-size: 12px; padding: 4px 8px;">üìã JSON</button>
                                                </div>
                                                <div class="reply-box" id="reply-box-${reply.id}" style="display:none;">
                                                    <textarea id="reply-input-${reply.id}" rows="2" style="width:100%;margin-top:6px;"></textarea>
                                                    <button class="send-reply-btn" data-parent-id="${reply.id}" data-parent-pubkey="${reply.pubkey}" style="margin-top:4px;">ÂèëÈÄÅ</button>
                                                </div>
                                                <div id="json-modal-${reply.id}" class="json-modal" style="display: none;">
                                                    <div class="json-modal-content">
                                                        <div class="json-modal-header">
                                                            <h3>ËØÑËÆ∫‰∫ã‰ª∂ÂÆåÊï¥ JSON</h3>
                                                            <button class="close-json-btn" data-event-id="${reply.id}">&times;</button>
                                                        </div>
                                                        <div class="json-modal-body">
                                                            <textarea id="json-content-${reply.id}" readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px;">${JSON.stringify(reply, null, 2)}</textarea>
                                                        </div>
                                                        <div class="json-modal-footer">
                                                            <button class="copy-json-btn" data-event-id="${reply.id}" style="background: #28a745;">Â§çÂà∂ JSON</button>
                                                            <button class="close-json-btn" data-event-id="${reply.id}" style="background: #6c757d;">ÂÖ≥Èó≠</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    html += '</div>';
                                }

                                html += '</div>';
                                return html;
                            }).join('');
                        }

                        commentList.innerHTML = renderFlatComments(rootComments);

                        // ÊåâÈíÆÊòæÁ§∫/ÈöêËóè
                        const moreBtn = document.getElementById('load-more-comments');
                        if (this.allCommentsLoaded) {
                            moreBtn.style.display = 'none';
                            document.getElementById('no-more-comments').style.display = 'block';
                        } else {
                            moreBtn.style.display = 'block';
                            document.getElementById('no-more-comments').style.display = 'none';
                        }

                        // ÁªëÂÆöÂõûÂ§çÊåâÈíÆ
                        commentList.querySelectorAll('.reply-btn').forEach(btn => {
                            btn.onclick = () => {
                                const box = document.getElementById('reply-box-' + btn.dataset.commentId);
                                box.style.display = box.style.display === 'none' ? 'block' : 'none';
                            };
                        });

                        // ÁªëÂÆöÂèëÈÄÅÊåâÈíÆ
                        commentList.querySelectorAll('.send-reply-btn').forEach(btn => {
                            btn.onclick = async () => {
                                const parentId = btn.dataset.parentId;
                                const parentPubkey = btn.dataset.parentPubkey;
                                const input = document.getElementById('reply-input-' + parentId);
                                const replyContent = input.value.trim();
                                if (!replyContent) return;
                                // ÂèëÈÄÅËØÑËÆ∫ÔºàÂ≠êËØÑËÆ∫Ôºâ
                                await app.client.commentOnArticle(article.id, parentPubkey, replyContent, parentId);
                                input.value = '';
                                document.getElementById('reply-box-' + parentId).style.display = 'none';
                                // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
                                this.commentPage = 0; this.comments = []; this.allCommentsLoaded = false;
                                await this.loadCommentsForArticle(article);
                            };
                        });
                    };

                    // Âä†ËΩΩËØÑËÆ∫
                    const loadComments = async () => {
                        await this.loadCommentsForArticle(article);
                    };

                    // ÈòÖËØªÈ°µHTML
                    const viewer = document.getElementById('article-viewer');
                    const articleContent = document.getElementById('article-content');
                    articleContent.innerHTML = `
                        <div class="article-title" style="font-size:1.5em;font-weight:600;margin-bottom:15px;">${this.escapeHtml(title)}</div>
                        <div class="article-meta" style="margin-bottom:15px;color:#666;">‰ΩúËÄÖ: ${author} | ÂèëÂ∏ÉÊó∂Èó¥: ${timeStr}</div>
                        <div class="article-content" style="margin-bottom:30px;line-height:1.7;">${this.escapeHtml(content)}</div>
                        <div class="comments-section">
                            <h3 style="margin-bottom:15px;">ËØÑËÆ∫</h3>
                            <div id="comment-list"></div>
                            <button id="load-more-comments" style="margin-top:15px;">Âä†ËΩΩÊõ¥Â§öËØÑËÆ∫</button>
                            <div id="no-more-comments" style="display:none;color:#999;margin-top:15px;">Ê≤°ÊúâÊõ¥Â§öËØÑËÆ∫‰∫Ü</div>
                        </div>
                    `;

                    // ÂàáÊç¢ÊòæÁ§∫
                    document.getElementById('timeline-tab').style.display = 'none';
                    viewer.style.display = 'block';

                    // ÁªëÂÆöËøîÂõûÊåâÈíÆ
                    document.getElementById('back-to-timeline').onclick = () => {
                        viewer.style.display = 'none';
                        document.getElementById('timeline-tab').style.display = 'block';
                    };

                    // Á°Æ‰øùtabÂàáÊç¢ÂäüËÉΩÂú®ÊñáÁ´†ËØ¶ÊÉÖÈ°µÈù¢‰πüËÉΩÊ≠£Â∏∏Â∑•‰Ωú
                    // ÈáçÊñ∞ÁªëÂÆötabÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨Âô®
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('tab')) {
                            const tabType = e.target.dataset.tab;

                            // Â¶ÇÊûúÂΩìÂâçÂú®ÊñáÁ´†ËØ¶ÊÉÖÈ°µÈù¢ÔºåÂÖàËøîÂõûÊó∂Èó¥Á∫ø
                            if (viewer.style.display === 'block') {
                                viewer.style.display = 'none';
                                document.getElementById('timeline-tab').style.display = 'block';
                            }

                            // ‰ΩøÁî® setTimeout Á°Æ‰øù DOM Êõ¥Êñ∞ÂêéÂÜçÂàáÊç¢tab
                            setTimeout(() => {
                                this.switchTab(tabType);
                                if (tabType === 'relays') {
                                    this.updateRelayList();
                                }
                            }, 0);
                        }
                    });

                    // ÁªëÂÆöÂä†ËΩΩÊõ¥Â§ö
                    document.getElementById('load-more-comments').onclick = loadComments;

                    // ÂàùÂßãÂä†ËΩΩ
                    await loadComments();
                }

                // ÊòæÁ§∫ÊñáÁ´†ÁºñËæëÂô®
                async showArticleEditor(articleId) {
                    // Ëé∑ÂèñÊñáÁ´†ÂØπË±°
                    const article = this.articles.find(a => a.id === articleId);
                    if (!article) {
                        this.showStatus('ÊñáÁ´†‰∏çÂ≠òÂú®', 'error');
                        return;
                    }

                    // Ê£ÄÊü•ÊùÉÈôê - Âè™Êúâ‰ΩúËÄÖÂèØ‰ª•ÁºñËæë
                    if (article.pubkey !== this.client.publicKey) {
                        this.showStatus('Âè™Êúâ‰ΩúËÄÖÂèØ‰ª•ÁºñËæëÊñáÁ´†', 'error');
                        return;
                    }

                    // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÊñáÁ´†
                    this.currentEditingArticle = article;

                    // ÈöêËóèÂÖ∂‰ªñÈ°µÈù¢
                    document.getElementById('timeline-tab').style.display = 'none';
                    document.getElementById('article-viewer').style.display = 'none';

                    // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
                    const title = this.client.getTagValue(article.tags, 'title') || '';
                    const dTag = this.client.getTagValue(article.tags, 'd') || '';
                    const content = article.content || '';

                    document.getElementById('edit-articleTitle').value = title;
                    document.getElementById('edit-articleDTag').value = dTag;
                    document.getElementById('edit-articleContent').value = content;

                    // ÊòæÁ§∫ÁºñËæëÂô®
                    document.getElementById('article-editor').style.display = 'block';
                }

                // ÈöêËóèÊñáÁ´†ÁºñËæëÂô®
                hideArticleEditor() {
                    document.getElementById('article-editor').style.display = 'none';
                    document.getElementById('timeline-tab').style.display = 'block';
                    this.currentEditingArticle = null;
                }

                // Â§ÑÁêÜÊñáÁ´†Êõ¥Êñ∞
                async handleUpdateArticle() {
                    if (!this.currentEditingArticle) {
                        this.showStatus('Ê≤°ÊúâÊ≠£Âú®ÁºñËæëÁöÑÊñáÁ´†', 'error');
                        return;
                    }

                    const title = document.getElementById('edit-articleTitle').value.trim();
                    const dTag = document.getElementById('edit-articleDTag').value.trim();
                    const content = document.getElementById('edit-articleContent').value.trim();

                    if (!title || !content) {
                        this.showStatus('Ê†áÈ¢òÂíåÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                        return;
                    }

                    try {
                        this.showStatus('Ê≠£Âú®Êõ¥Êñ∞ÊñáÁ´†...', 'info');

                        // ‰ΩøÁî®ÂéüÊñáÁ´†ÁöÑ d Ê†áÁ≠æÔºåÂ¶ÇÊûúÁî®Êà∑Ê≤°Êúâ‰øÆÊîπÁöÑËØù
                        const finalDTag = dTag || this.client.getTagValue(this.currentEditingArticle.tags, 'd') || '';

                        // ÂèëÂ∏ÉÊñ∞ÁâàÊú¨ÁöÑÊñáÁ´†ÔºàNostr ÂçèËÆÆ‰∏≠Êõ¥Êñ∞ÂÆûÈôÖ‰∏äÊòØÂèëÂ∏ÉÊñ∞ÁöÑÁâàÊú¨Ôºâ
                        const result = await this.client.publishArticle(title, content, '', finalDTag);

                        this.showStatus('ÊñáÁ´†Êõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');

                        // Ê∏ÖÁ©∫Ë°®Âçï
                        document.getElementById('edit-articleTitle').value = '';
                        document.getElementById('edit-articleDTag').value = '';
                        document.getElementById('edit-articleContent').value = '';

                        // ÈöêËóèÁºñËæëÂô®
                        this.hideArticleEditor();

                        // Âà∑Êñ∞Êó∂Èó¥Á∫ø
                        await this.updateTimeline();

                    } catch (error) {
                        this.showStatus('Êõ¥Êñ∞ÊñáÁ´†Â§±Ë¥•: ' + error.message, 'error');
                    }
                }

                // ÊòæÁ§∫Ëá™ÂÆö‰πâËØÑËÆ∫È°µÈù¢
                showCustomCommentPage() {
                    // ÈöêËóèÂÖ∂‰ªñÈ°µÈù¢
                    document.getElementById('timeline-tab').style.display = 'none';
                    document.getElementById('article-viewer').style.display = 'none';
                    document.getElementById('article-editor').style.display = 'none';

                    // ÊòæÁ§∫Ëá™ÂÆö‰πâËØÑËÆ∫È°µÈù¢
                    document.getElementById('custom-comment-page').style.display = 'block';
                }

                // ÈöêËóèËá™ÂÆö‰πâËØÑËÆ∫È°µÈù¢
                hideCustomCommentPage() {
                    document.getElementById('custom-comment-page').style.display = 'none';
                    document.getElementById('timeline-tab').style.display = 'block';

                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('comment-content').value = '';
                    document.getElementById('comment-a-tag').value = '';
                    document.getElementById('comment-p-tag').value = '';
                    document.getElementById('comment-e-tag').value = '';
                    document.getElementById('comment-P-tag').value = '';
                    document.getElementById('comment-E-tag').value = '';
                }

                // Â§ÑÁêÜËá™ÂÆö‰πâËØÑËÆ∫ÂàõÂª∫
                async handleCreateCustomComment() {
                    const content = document.getElementById('comment-content').value.trim();

                    if (!content) {
                        this.showStatus('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                        return;
                    }

                    try {
                        this.showStatus('Ê≠£Âú®ÂàõÂª∫Ëá™ÂÆö‰πâËØÑËÆ∫...', 'info');

                        // Ëé∑ÂèñÊâÄÊúâÊ†áÁ≠æÂÄº
                        const aTag = document.getElementById('comment-a-tag').value.trim();
                        const pTag = document.getElementById('comment-p-tag').value.trim();
                        const eTag = document.getElementById('comment-e-tag').value.trim();
                        const PTag = document.getElementById('comment-P-tag').value.trim();
                        const ETag = document.getElementById('comment-E-tag').value.trim();
                        // ÊûÑÂª∫Ê†áÁ≠æÊï∞ÁªÑ
                        const tags = [];

                        if (aTag) tags.push(['A', aTag]);
                        if (pTag) tags.push(['p', pTag]);
                        if (eTag) tags.push(['e', eTag]);
                        if (PTag) tags.push(['P', PTag]);
                        if (ETag) tags.push(['E', ETag]);

                        // ÈªòËÆ§Ê∑ªÂä† k Âíå K Ê†áÁ≠æ
                        tags.push(['k', '1111']);  // ËØÑËÆ∫‰∫ã‰ª∂Á±ªÂûã
                        tags.push(['K', '30023']); // Ë¢´ÂºïÁî®‰∫ã‰ª∂ÁöÑ kind

                        console.log('üîß ÂàõÂª∫Ëá™ÂÆö‰πâËØÑËÆ∫ÔºåÊ†áÁ≠æ:', tags);

                        // ÂàõÂª∫ kind 1111 ‰∫ã‰ª∂
                        const event = await this.client.createEvent(1111, content, tags);

                        console.log('üîß Ëá™ÂÆö‰πâËØÑËÆ∫‰∫ã‰ª∂ÂàõÂª∫ÊàêÂäü:', event);

                        // ÂèëÂ∏ÉÂà∞ relay
                        const result = await this.client.publishEvent(event);

                        console.log('üîß Ëá™ÂÆö‰πâËØÑËÆ∫ÂèëÂ∏ÉÁªìÊûú:', result);

                        this.showStatus('Ëá™ÂÆö‰πâËØÑËÆ∫ÂèëÂ∏ÉÊàêÂäüÔºÅ', 'success');

                        // ÈöêËóèÈ°µÈù¢
                        this.hideCustomCommentPage();

                        // Âà∑Êñ∞Êó∂Èó¥Á∫ø
                        await this.updateTimeline();

                    } catch (error) {
                        console.error('üîß Ëá™ÂÆö‰πâËØÑËÆ∫ÂàõÂª∫Â§±Ë¥•:', error);
                        this.showStatus('ÂàõÂª∫Ëá™ÂÆö‰πâËØÑËÆ∫Â§±Ë¥•: ' + error.message, 'error');
                    }
                }

                // ÊµãËØï NIP-42 ËÆ§ËØÅÂäüËÉΩ
                async handleTestAuth() {
                    if (!this.client.privateKey) {
                        this.showStatus('ËØ∑ÂÖàÂàõÂª∫ÊàñÂØºÂÖ•Ë¥¶Âè∑', 'error');
                        return;
                    }

                    this.showStatus('Ê≠£Âú®ÊµãËØï NIP-42 ËÆ§ËØÅÂäüËÉΩ...', 'info');

                    try {
                        // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊµãËØï‰∫ã‰ª∂
                        const testEvent = await this.client.createEvent(1, 'üîê ÊµãËØï NIP-42 ËÆ§ËØÅ - ' + new Date().toLocaleString());

                        console.log('üîê ÊµãËØï‰∫ã‰ª∂ÂàõÂª∫ÊàêÂäü:', testEvent);

                        // Â∞ùËØïÂèëÂ∏ÉÂà∞ÊâÄÊúâ‰∏≠ÁªßÔºàËøô‰ºöËß¶ÂèëËÆ§ËØÅÊµÅÁ®ãÔºâ
                        const result = await this.client.publishEvent(testEvent);

                        console.log('üîê ËÆ§ËØÅÊµãËØïÂÆåÊàê:', result);

                        this.showStatus(`ËÆ§ËØÅÊµãËØïÂÆåÊàêÔºÅÊàêÂäü: ${result.successful}, Â§±Ë¥•: ${result.failed}`, 'success');

                        // Êõ¥Êñ∞‰∏≠ÁªßÂàóË°®‰ª•ÊòæÁ§∫ËÆ§ËØÅÁä∂ÊÄÅ
                        this.updateRelayList();

                        // Âà∑Êñ∞Êó∂Èó¥Á∫øÊü•ÁúãÊµãËØïÊ∂àÊÅØ
                        await this.updateTimeline();

                    } catch (error) {
                        console.error('üîê ËÆ§ËØÅÊµãËØïÂ§±Ë¥•:', error);
                        this.showStatus('ËÆ§ËØÅÊµãËØïÂ§±Ë¥•: ' + error.message, 'error');
                    }
                }

                async loadCommentsForArticle(article) {
                    // ËÆ°ÁÆó since Êó∂Èó¥Êà≥ÔºåÁî®‰∫éÂàÜÈ°µ
                    // Á¨¨‰∏ÄÊ¨°Âä†ËΩΩÊó∂ since = 0ÔºåÂêéÁª≠Âä†ËΩΩÊó∂‰ΩøÁî®ÊúÄÊñ∞ËØÑËÆ∫ÁöÑÊó∂Èó¥Êà≥
                    const since = this.commentPage === 0 ? 0 :
                        (this.comments.length > 0 ? Math.max(...this.comments.map(c => c.created_at)) : 0);

                    const newComments = await this.getCommentsForArticle(article, since, this.pageSize);
                    if (newComments.length < this.pageSize) this.allCommentsLoaded = true;
                    this.comments = this.comments.concat(newComments);
                    this.commentPage++;
                    await this.renderComments(article);
                }

                async renderComments(article) {
                    const commentList = document.getElementById('comment-list');
                    commentList.innerHTML = '';

                    if (this.comments.length === 0) {
                        commentList.innerHTML = '<div class="status info">ÊöÇÊó†ËØÑËÆ∫ÔºåËØ∑ÂèëÂ∏ÉËØÑËÆ∫ÊàñËøûÊé•Âà∞Êõ¥Â§ö‰∏≠Áªß</div>';
                        return;
                    }

                    // ÊûÑÂª∫‰∏§Â±ÇÂ±ïÂπ≥ËØÑËÆ∫ÁªìÊûÑ
                    const commentMap = new Map();
                    this.comments.forEach(c => commentMap.set(c.id, { ...c, children: [] }));

                    const rootComments = [];
                    const allReplies = [];

                    // ÂàÜÁ±ªËØÑËÆ∫ÔºöÊ†πËØÑËÆ∫ vs ÂõûÂ§çËØÑËÆ∫
                    console.log('üîç ÂºÄÂßãÂàÜÁ±ªËØÑËÆ∫ÔºåÊÄªËØÑËÆ∫Êï∞:', this.comments.length);
                    this.comments.forEach((c, index) => {
                        console.log(`üîç Â§ÑÁêÜÁ¨¨ ${index + 1} ‰∏™ËØÑËÆ∫:`, {
                            id: c.id,
                            content: c.content,
                            tags: c.tags
                        });

                        const eTag = c.tags.find(t => t[0] === 'e');
                        const aTag = c.tags.find(t => t[0] === 'A');

                        console.log('üìã Ê†áÁ≠æ‰ø°ÊÅØ:', {
                            eTag: eTag,
                            aTag: aTag,
                            articleId: article.id
                        });

                        // Ê£ÄÊü•ÊòØÂê¶Êúâ e Ê†áÁ≠æ
                        if (eTag) {
                            const eventId = eTag[1];

                            // Ê£ÄÊü• e tag ÊòØÂê¶ÊåáÂêëÊñáÁ´†ID
                            if (eventId === article.id) {
                                // e tag ÊåáÂêëÊñáÁ´†IDÔºåËøôÊòØÊ†πËØÑËÆ∫
                                console.log('‚úÖ ËØÜÂà´‰∏∫Ê†πËØÑËÆ∫ (e tag ÊåáÂêëÊñáÁ´†):', c.content);
                                rootComments.push(commentMap.get(c.id));
                            } else {
                                // Ê£ÄÊü• e tag ÊòØÂê¶ÊåáÂêëÊñáÁ´†ÁöÑ E Ê†áÁ≠æÂÄº
                                const articleETag = article.tags.find(t => t[0] === 'E');
                                if (articleETag && eventId === articleETag[1]) {
                                    // e tag ÊåáÂêëÊñáÁ´†ÁöÑ E Ê†áÁ≠æÂÄºÔºåËøô‰πüÊòØÊ†πËØÑËÆ∫
                                    console.log('‚úÖ ËØÜÂà´‰∏∫Ê†πËØÑËÆ∫ (e tag ÊåáÂêëÊñáÁ´†ÁöÑ E Ê†áÁ≠æ):', c.content);
                                    rootComments.push(commentMap.get(c.id));
                                } else {
                                    // e tag ÊåáÂêëÂÖ∂‰ªñËØÑËÆ∫IDÔºåËøôÊòØÂõûÂ§çËØÑËÆ∫
                                    console.log('üîÑ ËØÜÂà´‰∏∫ÂõûÂ§çËØÑËÆ∫ (e tag ÊåáÂêëÂÖ∂‰ªñËØÑËÆ∫):', c.content, 'ÊåáÂêë:', eventId);
                                    const currentComment = commentMap.get(c.id);
                                    currentComment.isReply = true;
                                    currentComment.parentId = eventId;

                                    // ËÆæÁΩÆÂõûÂ§çÁõÆÊ†á‰ø°ÊÅØ
                                    const parentComment = commentMap.get(eventId);
                                    if (parentComment) {
                                        currentComment.replyToAuthor = parentComment.pubkey;
                                        currentComment.replyToContent = parentComment.content.substring(0, 50) + '...';
                                    }

                                    allReplies.push(currentComment);
                                }
                            }
                        } else if (aTag) {
                            // Âè™Êúâ A Ê†áÁ≠æÔºåÊ≤°Êúâ e Ê†áÁ≠æÔºåËøôÂèØËÉΩÊòØÊ†πËØÑËÆ∫
                            console.log('‚úÖ ËØÜÂà´‰∏∫Ê†πËØÑËÆ∫ (Âè™Êúâ A Ê†áÁ≠æ):', c.content);
                            rootComments.push(commentMap.get(c.id));
                        } else {
                            // Êó¢Ê≤°Êúâ e Ê†áÁ≠æ‰πüÊ≤°Êúâ A Ê†áÁ≠æÔºåÂèØËÉΩÊòØÂÖ∂‰ªñÁ±ªÂûãÁöÑËØÑËÆ∫
                            console.log('‚ö†Ô∏è ËØÑËÆ∫Êó¢Ê≤°Êúâ e Ê†áÁ≠æ‰πüÊ≤°Êúâ A Ê†áÁ≠æ:', c.id, c.content);
                            rootComments.push(commentMap.get(c.id));
                        }
                    });

                    console.log('üìä ÂàÜÁ±ªÁªìÊûú:', {
                        rootComments: rootComments.length,
                        allReplies: allReplies.length,
                        rootCommentsContent: rootComments.map(c => c.content)
                    });

                    // Â∞ÜÊâÄÊúâÂõûÂ§çÊåâÊó∂Èó¥ÊéíÂ∫èÂêéÊ∑ªÂä†Âà∞ÂØπÂ∫îÁöÑÊ†πËØÑËÆ∫‰∏ã
                    allReplies.sort((a, b) => a.created_at - b.created_at);

                    // ÊâæÂà∞ÊØè‰∏™ÂõûÂ§çÂ∫îËØ•ÂΩíÂ±ûÁöÑÊ†πËØÑËÆ∫
                    allReplies.forEach(reply => {
                        console.log('üîç Â§ÑÁêÜÂõûÂ§ç:', {
                            replyId: reply.id,
                            replyContent: reply.content,
                            parentId: reply.parentId
                        });

                        const rootComment = this.findRootComment(reply, commentMap, this.comments, article);
                        if (rootComment) {
                            console.log('‚úÖ ÊâæÂà∞Ê†πËØÑËÆ∫:', {
                                rootId: rootComment.id,
                                rootContent: rootComment.content
                            });
                            rootComment.children.push(reply);
                        } else {
                            // Â¶ÇÊûúÊâæ‰∏çÂà∞Ê†πËØÑËÆ∫ÔºåËØ¥ÊòéÂõûÂ§çÊåáÂêëÁöÑËØÑËÆ∫‰∏çÂú®ÂΩìÂâçÂàóË°®‰∏≠
                            // ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂ∞ÜÂõûÂ§ç‰Ωú‰∏∫Ê†πËØÑËÆ∫ÊòæÁ§∫
                            console.warn('‚ùå ÂõûÂ§çÊåáÂêëÁöÑËØÑËÆ∫‰∏çÂú®ÂàóË°®‰∏≠:', reply.parentId);
                            rootComments.push(reply);
                        }
                    });

                    // Ê∏≤Êüì‰∏§Â±ÇÂ±ïÂπ≥ÁªìÊûÑ
                    function renderFlatComments(list) {
                        return list.map(c => {
                            const authorName = app.client.truncateKey(c.pubkey);
                            const timeStr = app.client.formatTime(c.created_at);

                            let html = `
                                <div class="comment-item" data-comment-id="${c.id}">
                                    <div class="comment-author">${authorName}</div>
                                    <div class="comment-content">${app.escapeHtml(c.content)}</div>
                                    <div class="comment-time">${timeStr}</div>
                                    <div class="comment-actions">
                                        <button class="reply-btn" data-comment-id="${c.id}" data-parent-pubkey="${c.pubkey}">ÂõûÂ§ç</button>
                                        <button class="show-json-btn" data-event-id="${c.id}" style="background: #6c757d; margin-left: 5px; font-size: 12px; padding: 4px 8px;">üìã JSON</button>
                                    </div>
                                        <div class="reply-box" id="reply-box-${c.id}" style="display:none;">
                                            <textarea id="reply-input-${c.id}" rows="2" style="width:100%;margin-top:6px;"></textarea>
                                            <button class="send-reply-btn" data-parent-id="${c.id}" data-parent-pubkey="${c.pubkey}" style="margin-top:4px;">ÂèëÈÄÅ</button>
                                        </div>
                                        <div id="json-modal-${c.id}" class="json-modal" style="display: none;">
                                            <div class="json-modal-content">
                                                <div class="json-modal-header">
                                                    <h3>ËØÑËÆ∫‰∫ã‰ª∂ÂÆåÊï¥ JSON</h3>
                                                    <button class="close-json-btn" data-event-id="${c.id}">&times;</button>
                                                </div>
                                                <div class="json-modal-body">
                                                    <textarea id="json-content-${c.id}" readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px;">${JSON.stringify(c, null, 2)}</textarea>
                                                </div>
                                                <div class="json-modal-footer">
                                                    <button class="copy-json-btn" data-event-id="${c.id}" style="background: #28a745;">Â§çÂà∂ JSON</button>
                                                    <button class="close-json-btn" data-event-id="${c.id}" style="background: #6c757d;">ÂÖ≥Èó≠</button>
                                                </div>
                                            </div>
                                        </div>
                                </div>
                            `;

                            // Ê∏≤ÊüìÁ¨¨‰∫åÂ±ÇÂõûÂ§çÔºàÊâÄÊúâÂõûÂ§çÈÉΩÂ±ïÂπ≥ÊòæÁ§∫Ôºâ
                            if (c.children && c.children.length > 0) {
                                html += '<div class="replies-section" style="margin-left: 20px; margin-top: 10px;">';
                                c.children.forEach(reply => {
                                    const replyAuthorName = app.client.truncateKey(reply.pubkey);
                                    const replyTimeStr = app.client.formatTime(reply.created_at);
                                    const replyTarget = reply.replyToAuthor ?
                                        `ÂõûÂ§ç @${app.client.truncateKey(reply.replyToAuthor)}` : '';

                                    html += `
                                        <div class="comment-item child-comment" data-comment-id="${reply.id}">
                                            <div class="comment-author">${replyAuthorName} ${replyTarget}</div>
                                            <div class="comment-content">${app.escapeHtml(reply.content)}</div>
                                            <div class="comment-time">${replyTimeStr}</div>
                                            <div class="comment-actions">
                                                <button class="reply-btn" data-comment-id="${reply.id}" data-parent-pubkey="${reply.pubkey}">ÂõûÂ§ç</button>
                                                <button class="show-json-btn" data-event-id="${reply.id}" style="background: #6c757d; margin-left: 5px; font-size: 12px; padding: 4px 8px;">üìã JSON</button>
                                            </div>
                                            <div class="reply-box" id="reply-box-${reply.id}" style="display:none;">
                                                <textarea id="reply-input-${reply.id}" rows="2" style="width:100%;margin-top:6px;"></textarea>
                                                <button class="send-reply-btn" data-parent-id="${reply.id}" data-parent-pubkey="${reply.pubkey}" style="margin-top:4px;">ÂèëÈÄÅ</button>
                                            </div>
                                            <div id="json-modal-${reply.id}" class="json-modal" style="display: none;">
                                                <div class="json-modal-content">
                                                    <div class="json-modal-header">
                                                        <h3>ËØÑËÆ∫‰∫ã‰ª∂ÂÆåÊï¥ JSON</h3>
                                                        <button class="close-json-btn" data-event-id="${reply.id}">&times;</button>
                                                    </div>
                                                    <div class="json-modal-body">
                                                        <textarea id="json-content-${reply.id}" readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #f8f9fa; border: 1px solid #ddd; padding: 10px;">${JSON.stringify(reply, null, 2)}</textarea>
                                                    </div>
                                                    <div class="json-modal-footer">
                                                        <button class="copy-json-btn" data-event-id="${reply.id}" style="background: #28a745;">Â§çÂà∂ JSON</button>
                                                        <button class="close-json-btn" data-event-id="${reply.id}" style="background: #6c757d;">ÂÖ≥Èó≠</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                            }

                            html += '</div>';
                            return html;
                        }).join('');
                    }

                    commentList.innerHTML = renderFlatComments(rootComments);

                    // ÊåâÈíÆÊòæÁ§∫/ÈöêËóè
                    const moreBtn = document.getElementById('load-more-comments');
                    if (this.allCommentsLoaded) {
                        moreBtn.style.display = 'none';
                        document.getElementById('no-more-comments').style.display = 'block';
                    } else {
                        moreBtn.style.display = 'block';
                        document.getElementById('no-more-comments').style.display = 'none';
                    }

                    // ÁªëÂÆöÂõûÂ§çÊåâÈíÆ
                    commentList.querySelectorAll('.reply-btn').forEach(btn => {
                        btn.onclick = () => {
                            const box = document.getElementById('reply-box-' + btn.dataset.commentId);
                            box.style.display = box.style.display === 'none' ? 'block' : 'none';
                        };
                    });

                    // ÁªëÂÆöÂèëÈÄÅÊåâÈíÆ
                    commentList.querySelectorAll('.send-reply-btn').forEach(btn => {
                        btn.onclick = async () => {
                            const parentId = btn.dataset.parentId;
                            const parentPubkey = btn.dataset.parentPubkey;
                            const input = document.getElementById('reply-input-' + parentId);
                            const replyContent = input.value.trim();
                            if (!replyContent) return;
                            // ÂèëÈÄÅËØÑËÆ∫ÔºàÂ≠êËØÑËÆ∫Ôºâ
                            const dTag = this.client.getTagValue(article.tags, 'd') || article.id;
                            await this.client.commentOnArticle(article.id, article.pubkey, parentPubkey, replyContent, parentId, article, dTag);
                            input.value = '';
                            document.getElementById('reply-box-' + parentId).style.display = 'none';
                            // ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
                            this.commentPage = 0;
                            this.comments = [];
                            this.allCommentsLoaded = false;
                            await this.loadCommentsForArticle(article);
                        };
                    });
                }

                // Êü•ÊâæÂõûÂ§çËØÑËÆ∫ÁöÑÊ†πËØÑËÆ∫
                findRootComment(reply, commentMap, allComments, article) {
                    const parentId = reply.parentId;
                    if (!parentId) {
                        console.log('‚ùå ÂõûÂ§çÊ≤°Êúâ parentId:', reply.id);
                        return null;
                    }

                    const parent = commentMap.get(parentId);
                    if (!parent) {
                        console.log('‚ùå Êâæ‰∏çÂà∞Áà∂ËØÑËÆ∫:', parentId, 'ÂõûÂ§çID:', reply.id);
                        return null;
                    }

                    console.log('üîç Ê£ÄÊü•Áà∂ËØÑËÆ∫:', {
                        parentId: parentId,
                        parentContent: parent.content,
                        parentTags: parent.tags
                    });

                    // Ê£ÄÊü•Áà∂ËØÑËÆ∫ÊòØÂê¶ÊòØÊ†πËØÑËÆ∫Ôºàe tag ÊåáÂêëÊñáÁ´†IDÔºâ
                    const parentETag = parent.tags.find(t => t[0] === 'e');
                    if (parentETag) {
                        console.log('üìã Áà∂ËØÑËÆ∫ÁöÑ e tag:', parentETag[1], 'ÊñáÁ´†ID:', article.id);
                        if (parentETag[1] === article.id) {
                            // Áà∂ËØÑËÆ∫ÁöÑ e tag ÊåáÂêëÊñáÁ´†IDÔºåËØ¥ÊòéÊòØÊ†πËØÑËÆ∫
                            console.log('‚úÖ ÊâæÂà∞Ê†πËØÑËÆ∫:', parent.id, parent.content);
                            return parent;
                        }
                    }

                    // Â¶ÇÊûúÁà∂ËØÑËÆ∫‰πüÊòØÂõûÂ§çÔºåÁªßÁª≠Âêë‰∏äÊü•Êâæ
                    console.log('üîÑ Áà∂ËØÑËÆ∫‰πüÊòØÂõûÂ§çÔºåÁªßÁª≠Âêë‰∏äÊü•Êâæ');
                    return this.findRootComment(parent, commentMap, allComments, article);
                }

                                // Âä†ËΩΩÂπ∂Ê∏≤ÊüìÊî∂ËóèÊñáÁ´†
                async loadFavoritesArticles() {
                    const favoritesContent = document.getElementById('favorites-content');
                    favoritesContent.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÊî∂ËóèÊñáÁ´†...</div>';

                    try {
                        // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
                        if (!this.client.publicKey) {
                            favoritesContent.innerHTML = '<div class="status error">ËØ∑ÂÖàÁôªÂΩï‰ª•Êü•ÁúãÊî∂ËóèÊñáÁ´†</div>';
                            return;
                        }

                        // 1. Êü•ËØ¢ÂΩìÂâçÁî®Êà∑ÁöÑÊâÄÊúâÊî∂Ëóè‰∫ã‰ª∂ÔºàBOOKMARK kindÔºâ
                        console.log('üîç Êü•ËØ¢Áî®Êà∑ÁöÑÊî∂Ëóè‰∫ã‰ª∂...');
                        console.log('üë§ ÂΩìÂâçÁî®Êà∑ÂÖ¨Èí•:', this.client.publicKey.substring(0, 16) + '...');

                        // ‰ΩøÁî®‰∏é getCurrentBookmarks Áõ∏ÂêåÁöÑ limit ÂèÇÊï∞
                        const queryParams = {
                            kinds: [this.client.eventKinds.BOOKMARK],
                            authors: [this.client.publicKey], // Êü•ËØ¢ÂΩìÂâçÁî®Êà∑ÁöÑÊî∂Ëóè
                            limit: 1  // Êîπ‰∏∫‰∏é getCurrentBookmarks Áõ∏ÂêåÁöÑ limit
                        };

                        console.log('üìã ËØ¶ÁªÜÊü•ËØ¢ÂèÇÊï∞:', {
                            ...queryParams,
                            relays: this.client.relays,
                            maxWait: 8000
                        });

                        // ‰ΩøÁî®Áã¨Á´ãÁöÑ SimplePool ÂÆû‰æãËøõË°åÊî∂ËóèÊü•ËØ¢
                        console.log('üîç ÂàõÂª∫Áã¨Á´ãÁöÑ SimplePool ËøõË°åÊî∂ËóèÊü•ËØ¢...');
                        const bookmarkPool = new SimplePool();

                        let bookmarkEvents = [];
                        try {
                            bookmarkEvents = await bookmarkPool.querySync(this.client.relays, queryParams, { maxWait: 8000 });
                            console.log('‚úÖ Áã¨Á´ã SimplePool Êü•ËØ¢ÁªìÊûú:', bookmarkEvents.length, '‰∏™');

                            // Êü•ËØ¢ÂÆåÊàêÂêéÁ´ãÂç≥ÂÖ≥Èó≠Ëøô‰∏™Áã¨Á´ãÁöÑ pool
                            bookmarkPool.close(this.client.relays);

                        } catch (error) {
                            console.error('Áã¨Á´ã SimplePool Êü•ËØ¢Â§±Ë¥•:', error);
                            bookmarkPool.close(this.client.relays);

                            // ÂõûÈÄÄÂà∞‰∏ª pool
                            console.log('üîÑ ÂõûÈÄÄÂà∞‰∏ª pool...');
                            bookmarkEvents = await this.client.pool.querySync(this.client.relays, queryParams, { maxWait: 8000 });
                            console.log('‚úÖ ‰∏ª pool Êü•ËØ¢ÁªìÊûú:', bookmarkEvents.length, '‰∏™');
                        }

                        console.log('‚úÖ Êü•ËØ¢Âà∞Êî∂Ëóè‰∫ã‰ª∂:', bookmarkEvents.length, '‰∏™');

                        // ÊòæÁ§∫Êî∂Ëóè‰∫ã‰ª∂ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                        if (bookmarkEvents.length > 0) {
                            console.log('üìã Êî∂Ëóè‰∫ã‰ª∂ËØ¶ÊÉÖ:');
                            bookmarkEvents.forEach((event, index) => {
                                console.log(`  ${index + 1}. ID: ${event.id.substring(0, 16)}...`);
                                console.log(`     ‰ΩúËÄÖ: ${event.pubkey.substring(0, 16)}...`);
                                console.log(`     Á±ªÂûã: ${event.kind}`);
                                console.log(`     Ê†áÁ≠æ:`, event.tags);
                                console.log(`     ÂÜÖÂÆπ: ${event.content.substring(0, 100)}...`);
                            });
                        }

                        // 2. ‰ªéÊî∂Ëóè‰∫ã‰ª∂‰∏≠ÊèêÂèñÊâÄÊúâÊñáÁ´†‰ø°ÊÅØÔºàÊîØÊåÅ e Ê†áÁ≠æÂíå a Ê†áÁ≠æÔºâ
                        const articleIds = [];
                        const articleATags = [];

                        bookmarkEvents.forEach(event => {
                            event.tags.forEach(tag => {
                                if (tag[0] === 'e') {
                                    articleIds.push(tag[1]);
                                } else if (tag[0] === 'a') {
                                    articleATags.push(tag[1]);
                                }
                            });
                        });

                        // ÂéªÈáç
                        const uniqueArticleIds = [...new Set(articleIds)];
                        const uniqueArticleATags = [...new Set(articleATags)];

                        console.log('üìã ÊèêÂèñÂà∞ÊñáÁ´†‰ø°ÊÅØ:');
                        console.log('   - e Ê†áÁ≠æÊñáÁ´†ID:', uniqueArticleIds.length, '‰∏™');
                        console.log('   - a Ê†áÁ≠æÊñáÁ´†:', uniqueArticleATags.length, '‰∏™');

                        if (uniqueArticleIds.length === 0 && uniqueArticleATags.length === 0) {
                            favoritesContent.innerHTML = '<div class="status info">Êî∂Ëóè‰∫ã‰ª∂‰∏≠Ê≤°ÊúâÊâæÂà∞ÊñáÁ´†</div>';
                            return;
                        }

                        // 3. Êü•ËØ¢ÊñáÁ´†ÂÜÖÂÆπ
                        console.log('üîç Êü•ËØ¢Êî∂ËóèÁöÑÊñáÁ´†ËØ¶ÊÉÖ...');

                        // ÂêåÊ†∑‰ΩøÁî®Áã¨Á´ãÁöÑ SimplePool Êü•ËØ¢ÊñáÁ´†ËØ¶ÊÉÖ
                        const articlePool = new SimplePool();
                        let articles = [];

                        try {
                            // È¶ñÂÖàÊü•ËØ¢ e Ê†áÁ≠æÊñáÁ´† (ÈÄöËøá ID)
                            if (uniqueArticleIds.length > 0) {
                                const idArticles = await articlePool.querySync(this.client.relays, {
                                    ids: uniqueArticleIds,
                                    limit: 50
                                }, { maxWait: 8000 });
                                articles.push(...idArticles);
                                console.log('‚úÖ ÈÄöËøá ID Êü•ËØ¢Âà∞ÊñáÁ´†:', idArticles.length, 'ÁØá');
                            }

                            // ÁÑ∂ÂêéÊü•ËØ¢ a Ê†áÁ≠æÊñáÁ´† (kind 30023)
                            if (uniqueArticleATags.length > 0) {
                                // Ëß£Êûê a Ê†áÁ≠æËé∑ÂèñÊü•ËØ¢ÂèÇÊï∞
                                const aTagQueries = uniqueArticleATags.map(aTag => {
                                    const [kind, pubkey, dTag] = aTag.split(':');
                                    return {
                                        kinds: [parseInt(kind)],
                                        authors: [pubkey],
                                        '#d': [dTag]
                                    };
                                });

                                // ÂàÜÂà´Êü•ËØ¢ÊØè‰∏™ a Ê†áÁ≠æ
                                for (const query of aTagQueries) {
                                    const aTagArticles = await articlePool.querySync(this.client.relays, {
                                        ...query,
                                        limit: 10
                                    }, { maxWait: 8000 });
                                    articles.push(...aTagArticles);
                                }
                                console.log('‚úÖ ÈÄöËøá a Ê†áÁ≠æÊü•ËØ¢Âà∞ÊñáÁ´†:', articles.length - (uniqueArticleIds.length > 0 ? uniqueArticleIds.length : 0), 'ÁØá');
                            }

                            // Êü•ËØ¢ÂÆåÊàêÂêéÁ´ãÂç≥ÂÖ≥Èó≠
                            articlePool.close(this.client.relays);

                        } catch (error) {
                            console.error('Áã¨Á´ã SimplePool Êü•ËØ¢ÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•:', error);
                            articlePool.close(this.client.relays);

                            // Â¶ÇÊûúÊü•ËØ¢Â§±Ë¥•ÔºåÊöÇÊó∂Ë∑≥Ëøá a Ê†áÁ≠æÊü•ËØ¢ÔºåÂè™Êü•ËØ¢ e Ê†áÁ≠æÊñáÁ´†
                            if (uniqueArticleIds.length > 0) {
                                console.log('üîÑ ÂõûÈÄÄÂà∞‰∏ª pool Êü•ËØ¢ e Ê†áÁ≠æÊñáÁ´†...');
                                articles = await this.client.pool.querySync(this.client.relays, {
                                    ids: uniqueArticleIds,
                                    limit: 50
                                }, { maxWait: 8000 });
                                console.log('‚úÖ ‰∏ª pool Êü•ËØ¢ÊñáÁ´†ËØ¶ÊÉÖÁªìÊûú:', articles.length, 'ÁØá');
                            }
                        }

                        console.log('‚úÖ Êü•ËØ¢Âà∞Êî∂ËóèÊñáÁ´†:', articles.length, 'ÁØá');

                        if (!articles.length) {
                            favoritesContent.innerHTML = '<div class="status info">Êú™ÊâæÂà∞Êî∂ËóèÊñáÁ´†ËØ¶ÊÉÖ</div>';
                            return;
                        }

                        // 4. Ê∏≤Êüì
                        let html = '';
                        articles.sort((a, b) => b.created_at - a.created_at);
                        articles.forEach(event => {
                            const timeStr = this.client.formatTime(event.created_at);
                            const title = this.client.getTagValue(event.tags, 'title') || this.client.getTagValue(event.tags, 'd') || 'Êó†Ê†áÈ¢ò';
                            const content = event.content || '';

                            html += `
                            <div class="article-item" data-article-id="${event.id}">
                                <div class="article-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div class="article-title" style="cursor: pointer; color: #667eea; font-weight: 600; flex: 1;" data-article-id="${event.id}">
                                        üìö ${this.escapeHtml(title)}
                                    </div>
                                    <button class="view-detail-btn" data-article-id="${event.id}" style="background: #17a2b8; margin-left: 10px;">
                                        üìñ ËØ¶ÊÉÖ
                                    </button>
                                </div>
                                <div class="article-content">${this.escapeHtml(content.substring(0, 200))}${content.length > 200 ? '...' : ''}</div>
                                <div class="article-meta">
                                    ‰ΩúËÄÖ: ${this.client.truncateKey(event.pubkey)} |
                                    ÂèëÂ∏ÉÊó∂Èó¥: ${timeStr} |
                                    ‰∫ã‰ª∂Á±ªÂûã: ${event.kind}
                                </div>
                            </div>
                            `;
                        });
                        favoritesContent.innerHTML = html;

                    } catch (e) {
                        console.error('‚ùå Âä†ËΩΩÊî∂ËóèÊñáÁ´†Â§±Ë¥•:', e);
                        favoritesContent.innerHTML = '<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ' + e.message + '</div>';
                    }
                }

                // Âä†ËΩΩÂπ∂Ê∏≤ÊüìÂÖ≥Ê≥®ÂàóË°®
                async loadFollowingList() {
                    const followingContent = document.getElementById('following-content');
                    followingContent.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÂÖ≥Ê≥®ÂàóË°®...</div>';

                    try {
                        // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
                        if (!this.client.publicKey) {
                            followingContent.innerHTML = '<div class="status error">ËØ∑ÂÖàÁôªÂΩï‰ª•Êü•ÁúãÂÖ≥Ê≥®ÂàóË°®</div>';
                            return;
                        }

                        console.log('üîç Êü•ËØ¢Áî®Êà∑ÁöÑÂÖ≥Ê≥®ÂàóË°®...');
                        console.log('üë§ ÂΩìÂâçÁî®Êà∑ÂÖ¨Èí•:', this.client.publicKey.substring(0, 16) + '...');

                        // 1. Ëé∑ÂèñÂÖ≥Ê≥®ÂàóË°®
                        const followList = await this.client.getCurrentFollowList();
                        console.log('üìã ÂÖ≥Ê≥®ÂàóË°®:', followList.length, '‰∏™');

                        if (followList.length === 0) {
                            followingContent.innerHTML = '<div class="status info">ÊöÇÊó†ÂÖ≥Ê≥®ÁöÑ‰∫∫</div>';
                            return;
                        }

                        // 2. ÊèêÂèñÊâÄÊúâÂÖ≥Ê≥®ÁöÑÁî®Êà∑ÂÖ¨Èí•
                        const followedPubkeys = followList.map(tag => tag[1]); // p Ê†áÁ≠æÁöÑÁ¨¨‰∫å‰∏™ÂÖÉÁ¥†ÊòØÂÖ¨Èí•
                        console.log('üìã ÂÖ≥Ê≥®ÁöÑÁî®Êà∑ÂÖ¨Èí•:', followedPubkeys.length, '‰∏™');

                        // 3. Êü•ËØ¢Ëøô‰∫õÁî®Êà∑ÁöÑ metadata (kind 0)
                        console.log('üîç Êü•ËØ¢ÂÖ≥Ê≥®Áî®Êà∑ÁöÑ metadata...');
                        const metadataPool = new SimplePool();
                        let metadataEvents = [];

                        try {
                            metadataEvents = await metadataPool.querySync(this.client.relays, {
                                kinds: [this.client.eventKinds.METADATA], // kind 0
                                authors: followedPubkeys,
                                limit: 100
                            }, { maxWait: 10000 });
                            console.log('‚úÖ Êü•ËØ¢Âà∞ metadata:', metadataEvents.length, '‰∏™');

                            metadataPool.close(this.client.relays);
                        } catch (error) {
                            console.error('Êü•ËØ¢ metadata Â§±Ë¥•:', error);
                            metadataPool.close(this.client.relays);
                        }

                        // 4. Â§ÑÁêÜ metadata Âπ∂ÂàõÂª∫Áî®Êà∑‰ø°ÊÅØÊò†Â∞Ñ
                        const userProfiles = new Map();

                        // ‰∏∫ÊØè‰∏™ÂÖ≥Ê≥®ÁöÑÁî®Êà∑ÂàõÂª∫Âü∫Á°Ä‰ø°ÊÅØ
                        followList.forEach(tag => {
                            const pubkey = tag[1];
                            const relay = tag[2] || '';
                            const alias = tag[3] || '';
                            userProfiles.set(pubkey, {
                                pubkey,
                                relay,
                                alias,
                                name: alias || this.client.truncateKey(pubkey),
                                display_name: '',
                                about: '',
                                picture: '',
                                nip05: '',
                                hasMetadata: false
                            });
                        });

                        // Áî®ÂÆûÈôÖÁöÑ metadata Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
                        metadataEvents.forEach(event => {
                            try {
                                const metadata = JSON.parse(event.content);
                                const profile = userProfiles.get(event.pubkey);
                                if (profile) {
                                    profile.name = metadata.name || metadata.display_name || profile.alias || this.client.truncateKey(event.pubkey);
                                    profile.display_name = metadata.display_name || '';
                                    profile.about = metadata.about || '';
                                    profile.picture = metadata.picture || '';
                                    profile.nip05 = metadata.nip05 || '';
                                    profile.hasMetadata = true;
                                }
                            } catch (e) {
                                console.warn('Ëß£Êûê metadata Â§±Ë¥•:', e);
                            }
                        });

                        // 5. Ê∏≤ÊüìÂÖ≥Ê≥®ÂàóË°®
                        let html = '';
                        const profiles = Array.from(userProfiles.values());

                        profiles.forEach(profile => {
                            const avatarUrl = profile.picture || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDAgNSAyMUM1IDIxLjU1MjMgNS40NDc3MiAyMiA2IDIySDEwSDE0SDE4QzE4LjU1MjMgMjIgMTkgMjEuNTUyMyAxOSAyMUMxOSAxNy4xMzQwIDE1Ljg2NiAxNCAxMiAxNFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo8L3N2Zz4K';

                            html += `
                            <div class="following-item" style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${profile.picture || avatarUrl}"
                                         alt="Â§¥ÂÉè"
                                         style="width: 50px; height: 50px; border-radius: 25px; object-fit: cover; background: #f0f0f0;"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDAgNSAyMUM1IDIxLjU1MjMgNS40NDc3MiAyMiA2IDIySDEwSDE0SDE4QzE4LjU1MjMgMjIgMTkgMjEuNTUyMyAxOSAyMUMxOSAxNy4xMzQwIDE1Ljg2NiAxNCAxMiAxNFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo8L3N2Zz4K'">

                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 5px;">
                                            ${this.escapeHtml(profile.name)}
                                            ${profile.display_name && profile.display_name !== profile.name ?
                                                `<span style="color: #666; font-weight: normal; font-size: 14px;">(@${this.escapeHtml(profile.display_name)})</span>` : ''}
                                        </div>

                                        ${profile.about ?
                                            `<div style="color: #666; font-size: 14px; margin-bottom: 8px;">${this.escapeHtml(profile.about)}</div>` : ''}

                                        ${profile.nip05 ?
                                            `<div style="color: #667eea; font-size: 13px; margin-bottom: 8px;">‚úì ${this.escapeHtml(profile.nip05)}</div>` : ''}

                                        <div style="color: #999; font-size: 12px;">
                                            ÂÖ¨Èí•: ${this.client.truncateKey(profile.pubkey)}
                                            ${profile.hasMetadata ? ' | Â∑≤Âä†ËΩΩËµÑÊñô' : ' | Êó†ËµÑÊñô'}
                                        </div>
                                    </div>

                                    <div>
                                        <button class="follow-btn active"
                                                data-author-pubkey="${profile.pubkey}"
                                                data-author-name="${this.escapeHtml(profile.name)}"
                                                style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                            Â∑≤ÂÖ≥Ê≥®
                                        </button>
                                    </div>
                                </div>
                            </div>
                            `;
                        });

                        followingContent.innerHTML = html;

                    } catch (e) {
                        console.error('‚ùå Âä†ËΩΩÂÖ≥Ê≥®ÂàóË°®Â§±Ë¥•:', e);
                        followingContent.innerHTML = '<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ' + e.message + '</div>';
                    }
                }
            }

            // ÂêØÂä®Â∫îÁî®
            const app = new NostrApp();
            app.init();
        });
    </script>
</body>

</html>
