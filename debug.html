<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Nostr Debug 测试</h1>
        
        <div class="debug-section">
            <h3>1. 测试基本功能</h3>
            <button onclick="testNostrTools()">测试 nostr-tools</button>
            <button onclick="testKeyGeneration()">测试密钥生成</button>
            <button onclick="testEventCreation()">测试事件创建</button>
        </div>
        
        <div class="debug-section">
            <h3>2. 测试 WebSocket 连接</h3>
            <button onclick="testSingleRelay()">测试单个中继</button>
            <button onclick="testAllRelays()">测试所有中继</button>
        </div>
        
        <div class="debug-section">
            <h3>3. 创建账号测试</h3>
            <button onclick="testCreateAccount()">创建测试账号</button>
            <button onclick="clearStorage()">清除本地存储</button>
        </div>
        
        <div id="output" class="log"></div>
    </div>

    <script type="module">
        import { 
            SimplePool, 
            finalizeEvent,
            generateSecretKey,
            getPublicKey,
            nip19,
            validateEvent,
            verifyEvent
        } from './node_modules/nostr-tools/lib/esm/index.js';

        let output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        window.testNostrTools = function() {
            try {
                log('测试 nostr-tools 导入...');
                log('✅ nostr-tools 导入成功');
                log(`SimplePool: ${typeof SimplePool}`);
                log(`generateSecretKey: ${typeof generateSecretKey}`);
                log(`getPublicKey: ${typeof getPublicKey}`);
                log(`nip19: ${typeof nip19}`);
            } catch (error) {
                log('❌ nostr-tools 导入失败: ' + error.message, 'error');
            }
        };

        window.testKeyGeneration = function() {
            try {
                log('测试密钥生成...');
                
                // 生成私钥
                const privateKey = generateSecretKey();
                log(`私钥生成成功: ${privateKey.constructor.name}, 长度: ${privateKey.length}`);
                
                // 生成公钥
                const publicKey = getPublicKey(privateKey);
                log(`公钥生成成功: ${typeof publicKey}, 长度: ${publicKey.length}`);
                
                // 测试编码
                const npub = nip19.npubEncode(publicKey);
                const nsec = nip19.nsecEncode(privateKey);
                log(`npub: ${npub.substring(0, 20)}...`);
                log(`nsec: ${nsec.substring(0, 20)}...`);
                
                log('✅ 密钥生成测试通过', 'success');
            } catch (error) {
                log('❌ 密钥生成失败: ' + error.message, 'error');
                console.error('密钥生成错误:', error);
            }
        };

        window.testEventCreation = function() {
            try {
                log('测试事件创建...');
                
                const privateKey = generateSecretKey();
                const publicKey = getPublicKey(privateKey);
                
                const event = {
                    kind: 0,
                    content: JSON.stringify({name: 'test', about: 'test user'}),
                    tags: [],
                    created_at: Math.floor(Date.now() / 1000),
                    pubkey: publicKey
                };
                
                const signedEvent = finalizeEvent(event, privateKey);
                log(`事件ID: ${signedEvent.id.substring(0, 16)}...`);
                
                const isValid = validateEvent(signedEvent);
                const isSignatureValid = verifyEvent(signedEvent);
                
                log(`事件验证: ${isValid ? '✅' : '❌'}`);
                log(`签名验证: ${isSignatureValid ? '✅' : '❌'}`);
                
                if (isValid && isSignatureValid) {
                    log('✅ 事件创建测试通过', 'success');
                } else {
                    log('❌ 事件创建测试失败', 'error');
                }
            } catch (error) {
                log('❌ 事件创建失败: ' + error.message, 'error');
                console.error('事件创建错误:', error);
            }
        };

        window.testSingleRelay = function() {
            const relayUrl = 'wss://relay.damus.io';
            log(`测试连接到: ${relayUrl}`);
            
            const ws = new WebSocket(relayUrl);
            
            const timeout = setTimeout(() => {
                ws.close();
                log('❌ 连接超时', 'error');
            }, 5000);
            
            ws.onopen = () => {
                clearTimeout(timeout);
                log('✅ 连接成功', 'success');
                ws.close();
            };
            
            ws.onerror = (error) => {
                clearTimeout(timeout);
                log(`❌ 连接失败: ${error.message}`, 'error');
            };
        };

        window.testAllRelays = function() {
            const relays = [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.snort.social',
                'wss://relay.nostr.band',
                'wss://nostr.wine',
                'wss://relay.nostr.info'
            ];
            
            log('测试所有中继连接...');
            
            relays.forEach(relayUrl => {
                const ws = new WebSocket(relayUrl);
                
                const timeout = setTimeout(() => {
                    ws.close();
                    log(`⏱️ ${relayUrl} 连接超时`);
                }, 5000);
                
                ws.onopen = () => {
                    clearTimeout(timeout);
                    log(`✅ ${relayUrl} 连接成功`, 'success');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    clearTimeout(timeout);
                    log(`❌ ${relayUrl} 连接失败`);
                };
            });
        };

        window.testCreateAccount = function() {
            try {
                log('测试完整的账号创建流程...');
                
                // 生成密钥
                const privateKey = generateSecretKey();
                const publicKey = getPublicKey(privateKey);
                
                // 创建用户元数据事件
                const metadata = {
                    name: 'Debug Test User',
                    about: 'This is a debug test account'
                };
                
                const event = {
                    kind: 0,
                    content: JSON.stringify(metadata),
                    tags: [],
                    created_at: Math.floor(Date.now() / 1000),
                    pubkey: publicKey
                };
                
                const signedEvent = finalizeEvent(event, privateKey);
                
                // 验证事件
                if (!validateEvent(signedEvent) || !verifyEvent(signedEvent)) {
                    throw new Error('事件验证失败');
                }
                
                // 测试保存到localStorage
                const user = {
                    privateKey: Array.from(privateKey),
                    publicKey,
                    npub: nip19.npubEncode(publicKey),
                    nsec: nip19.nsecEncode(privateKey),
                    name: metadata.name,
                    about: metadata.about
                };
                
                localStorage.setItem('nostr-debug-user', JSON.stringify(user));
                log('✅ 账号创建测试完成', 'success');
                log(`用户信息: ${JSON.stringify(user, null, 2)}`);
                
            } catch (error) {
                log('❌ 账号创建失败: ' + error.message, 'error');
                console.error('账号创建错误:', error);
            }
        };

        window.clearStorage = function() {
            localStorage.removeItem('nostr-user');
            localStorage.removeItem('nostr-debug-user');
            log('🗑️ 本地存储已清除');
        };

        // 页面加载时自动测试
        window.addEventListener('load', () => {
            log('🚀 Debug 页面加载完成');
            testNostrTools();
        });
    </script>
</body>
</html>