<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Nostr Debug æµ‹è¯•</h1>
        
        <div class="debug-section">
            <h3>1. æµ‹è¯•åŸºæœ¬åŠŸèƒ½</h3>
            <button onclick="testNostrTools()">æµ‹è¯• nostr-tools</button>
            <button onclick="testKeyGeneration()">æµ‹è¯•å¯†é’¥ç”Ÿæˆ</button>
            <button onclick="testEventCreation()">æµ‹è¯•äº‹ä»¶åˆ›å»º</button>
        </div>
        
        <div class="debug-section">
            <h3>2. æµ‹è¯• WebSocket è¿æ¥</h3>
            <button onclick="testSingleRelay()">æµ‹è¯•å•ä¸ªä¸­ç»§</button>
            <button onclick="testAllRelays()">æµ‹è¯•æ‰€æœ‰ä¸­ç»§</button>
        </div>
        
        <div class="debug-section">
            <h3>3. åˆ›å»ºè´¦å·æµ‹è¯•</h3>
            <button onclick="testCreateAccount()">åˆ›å»ºæµ‹è¯•è´¦å·</button>
            <button onclick="clearStorage()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
        </div>
        
        <div id="output" class="log"></div>
    </div>

    <script type="module">
        import { 
            SimplePool, 
            finalizeEvent,
            generateSecretKey,
            getPublicKey,
            nip19,
            validateEvent,
            verifyEvent
        } from './node_modules/nostr-tools/lib/esm/index.js';

        let output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        window.testNostrTools = function() {
            try {
                log('æµ‹è¯• nostr-tools å¯¼å…¥...');
                log('âœ… nostr-tools å¯¼å…¥æˆåŠŸ');
                log(`SimplePool: ${typeof SimplePool}`);
                log(`generateSecretKey: ${typeof generateSecretKey}`);
                log(`getPublicKey: ${typeof getPublicKey}`);
                log(`nip19: ${typeof nip19}`);
            } catch (error) {
                log('âŒ nostr-tools å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        };

        window.testKeyGeneration = function() {
            try {
                log('æµ‹è¯•å¯†é’¥ç”Ÿæˆ...');
                
                // ç”Ÿæˆç§é’¥
                const privateKey = generateSecretKey();
                log(`ç§é’¥ç”ŸæˆæˆåŠŸ: ${privateKey.constructor.name}, é•¿åº¦: ${privateKey.length}`);
                
                // ç”Ÿæˆå…¬é’¥
                const publicKey = getPublicKey(privateKey);
                log(`å…¬é’¥ç”ŸæˆæˆåŠŸ: ${typeof publicKey}, é•¿åº¦: ${publicKey.length}`);
                
                // æµ‹è¯•ç¼–ç 
                const npub = nip19.npubEncode(publicKey);
                const nsec = nip19.nsecEncode(privateKey);
                log(`npub: ${npub.substring(0, 20)}...`);
                log(`nsec: ${nsec.substring(0, 20)}...`);
                
                log('âœ… å¯†é’¥ç”Ÿæˆæµ‹è¯•é€šè¿‡', 'success');
            } catch (error) {
                log('âŒ å¯†é’¥ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                console.error('å¯†é’¥ç”Ÿæˆé”™è¯¯:', error);
            }
        };

        window.testEventCreation = function() {
            try {
                log('æµ‹è¯•äº‹ä»¶åˆ›å»º...');
                
                const privateKey = generateSecretKey();
                const publicKey = getPublicKey(privateKey);
                
                const event = {
                    kind: 0,
                    content: JSON.stringify({name: 'test', about: 'test user'}),
                    tags: [],
                    created_at: Math.floor(Date.now() / 1000),
                    pubkey: publicKey
                };
                
                const signedEvent = finalizeEvent(event, privateKey);
                log(`äº‹ä»¶ID: ${signedEvent.id.substring(0, 16)}...`);
                
                const isValid = validateEvent(signedEvent);
                const isSignatureValid = verifyEvent(signedEvent);
                
                log(`äº‹ä»¶éªŒè¯: ${isValid ? 'âœ…' : 'âŒ'}`);
                log(`ç­¾åéªŒè¯: ${isSignatureValid ? 'âœ…' : 'âŒ'}`);
                
                if (isValid && isSignatureValid) {
                    log('âœ… äº‹ä»¶åˆ›å»ºæµ‹è¯•é€šè¿‡', 'success');
                } else {
                    log('âŒ äº‹ä»¶åˆ›å»ºæµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                log('âŒ äº‹ä»¶åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                console.error('äº‹ä»¶åˆ›å»ºé”™è¯¯:', error);
            }
        };

        window.testSingleRelay = function() {
            const relayUrl = 'wss://relay.damus.io';
            log(`æµ‹è¯•è¿æ¥åˆ°: ${relayUrl}`);
            
            const ws = new WebSocket(relayUrl);
            
            const timeout = setTimeout(() => {
                ws.close();
                log('âŒ è¿æ¥è¶…æ—¶', 'error');
            }, 5000);
            
            ws.onopen = () => {
                clearTimeout(timeout);
                log('âœ… è¿æ¥æˆåŠŸ', 'success');
                ws.close();
            };
            
            ws.onerror = (error) => {
                clearTimeout(timeout);
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            };
        };

        window.testAllRelays = function() {
            const relays = [
                'wss://relay.damus.io',
                'wss://nos.lol',
                'wss://relay.snort.social',
                'wss://relay.nostr.band',
                'wss://nostr.wine',
                'wss://relay.nostr.info'
            ];
            
            log('æµ‹è¯•æ‰€æœ‰ä¸­ç»§è¿æ¥...');
            
            relays.forEach(relayUrl => {
                const ws = new WebSocket(relayUrl);
                
                const timeout = setTimeout(() => {
                    ws.close();
                    log(`â±ï¸ ${relayUrl} è¿æ¥è¶…æ—¶`);
                }, 5000);
                
                ws.onopen = () => {
                    clearTimeout(timeout);
                    log(`âœ… ${relayUrl} è¿æ¥æˆåŠŸ`, 'success');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    clearTimeout(timeout);
                    log(`âŒ ${relayUrl} è¿æ¥å¤±è´¥`);
                };
            });
        };

        window.testCreateAccount = function() {
            try {
                log('æµ‹è¯•å®Œæ•´çš„è´¦å·åˆ›å»ºæµç¨‹...');
                
                // ç”Ÿæˆå¯†é’¥
                const privateKey = generateSecretKey();
                const publicKey = getPublicKey(privateKey);
                
                // åˆ›å»ºç”¨æˆ·å…ƒæ•°æ®äº‹ä»¶
                const metadata = {
                    name: 'Debug Test User',
                    about: 'This is a debug test account'
                };
                
                const event = {
                    kind: 0,
                    content: JSON.stringify(metadata),
                    tags: [],
                    created_at: Math.floor(Date.now() / 1000),
                    pubkey: publicKey
                };
                
                const signedEvent = finalizeEvent(event, privateKey);
                
                // éªŒè¯äº‹ä»¶
                if (!validateEvent(signedEvent) || !verifyEvent(signedEvent)) {
                    throw new Error('äº‹ä»¶éªŒè¯å¤±è´¥');
                }
                
                // æµ‹è¯•ä¿å­˜åˆ°localStorage
                const user = {
                    privateKey: Array.from(privateKey),
                    publicKey,
                    npub: nip19.npubEncode(publicKey),
                    nsec: nip19.nsecEncode(privateKey),
                    name: metadata.name,
                    about: metadata.about
                };
                
                localStorage.setItem('nostr-debug-user', JSON.stringify(user));
                log('âœ… è´¦å·åˆ›å»ºæµ‹è¯•å®Œæˆ', 'success');
                log(`ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(user, null, 2)}`);
                
            } catch (error) {
                log('âŒ è´¦å·åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                console.error('è´¦å·åˆ›å»ºé”™è¯¯:', error);
            }
        };

        window.clearStorage = function() {
            localStorage.removeItem('nostr-user');
            localStorage.removeItem('nostr-debug-user');
            log('ğŸ—‘ï¸ æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤');
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            log('ğŸš€ Debug é¡µé¢åŠ è½½å®Œæˆ');
            testNostrTools();
        });
    </script>
</body>
</html>